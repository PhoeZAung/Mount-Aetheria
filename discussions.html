<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Discussions - Mount Aetheria</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#1a1a1a">
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
/* --- BASE THEME --- */
:root { --bg: #1a1a1a; --panel: #252525; --border: #333; --accent: #ffcc66; --text: #ddd; --received: rgba(40, 40, 40, 0.8); --sent: rgba(92, 75, 30, 0.8); }
body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding-top: 50px; height: 100vh; overflow: hidden; }
* { box-sizing: border-box; }

/* --- NAVIGATION --- */
.top-nav { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #000; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 2000; }
.nav-brand { font-family: 'Uncial Antiqua'; color: var(--accent); font-size: 18px; text-decoration: none; }
.nav-links { display: flex; gap: 20px; }
.nav-links a { color: #888; text-decoration: none; font-size: 14px; font-weight: bold; }
.nav-links a:hover, .nav-links a.active { color: #fff; }
#hamburgerBtn { display: none; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; }
#mobileMenu { display: none; position: fixed; top: 50px; left: 0; width: 100%; background: #111; border-bottom: 1px solid var(--accent); flex-direction: column; z-index: 1999; }
#mobileMenu.show { display: flex; }
#mobileMenu a { padding: 15px 20px; color: #fff; text-decoration: none; border-bottom: 1px solid #333; font-family: 'Uncial Antiqua'; }

/* --- MAIN LAYOUT --- */
.chat-container { display: flex; height: calc(100vh - 50px); width: 100%; }
.sidebar { width: 300px; background: #000; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
.sidebar-header { padding: 10px; border-bottom: 1px solid var(--border); display: flex; gap: 5px; }
.btn-action { flex: 1; background: var(--accent); border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; color: #000; font-size: 12px; }
.topic-list { flex: 1; overflow-y: auto; }

.topic-card { padding: 12px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
.topic-card:hover { background: #111; }
.topic-card.active { background: #222; border-left: 3px solid var(--accent); }
.topic-img { width: 40px; height: 40px; border-radius: 50%; background: #333; object-fit: cover; }
.topic-info { flex: 1; min-width: 0; }
.topic-name { font-weight: bold; color: #fff; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.topic-desc-preview { color: #888; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.unread-badge { background: #ff4444; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center; }

/* CHAT AREA */
.chat-area { flex: 1; display: flex; flex-direction: column; background-color: #151515; background-size: cover; background-position: center; background-repeat: no-repeat; position: relative; transition: background-image 0.5s ease-in-out; }
.chat-area::before { content: ""; position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0, 0, 0, 0.75); z-index: 0; }
.chat-header, .messages-box, .input-area { position: relative; z-index: 1; }
.chat-header { padding: 10px 15px; background: rgba(0,0,0,0.6); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; backdrop-filter: blur(5px); }
.chat-back-btn { display: none; background: none; border: none; color: var(--accent); font-size: 20px; cursor: pointer; }
.chat-header-title { font-family: 'Uncial Antiqua'; color: var(--accent); font-size: 16px; display: flex; align-items: center; gap: 8px; }
.info-icon { cursor: pointer; font-size: 16px; color: #aaa; position: relative; }
.info-icon:hover { color: #fff; }
.info-tooltip { display: none; position: absolute; top: 25px; left: 0; background: rgba(0,0,0,0.9); border: 1px solid var(--accent); padding: 10px; width: 200px; font-family: sans-serif; font-size: 12px; color: #ddd; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); white-space: normal; line-height: 1.4; }
.info-icon:hover .info-tooltip { display: block; }
.messages-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg { display: flex; gap: 10px; max-width: 80%; }
.msg.mine { align-self: flex-end; flex-direction: row-reverse; }
.msg-avatar { width: 35px; height: 35px; border-radius: 50%; background: #000; object-fit: cover; border: 1px solid #444; flex-shrink: 0; }
.msg-content { background: var(--received); padding: 8px 12px; border-radius: 12px; border-top-left-radius: 0; font-size: 14px; line-height: 1.4; word-wrap: break-word; color: #fff; border: 1px solid rgba(255,255,255,0.1); }
.msg.mine .msg-content { background: var(--sent); border-radius: 12px; border-top-right-radius: 0; border: 1px solid rgba(255,204,102,0.2); }
.msg-meta { font-size: 10px; color: #bbb; margin-bottom: 2px; }
.msg.mine .msg-meta { text-align: right; }

/* INPUT AREA */
.input-area { padding: 10px; background: rgba(0,0,0,0.8); border-top: 1px solid #333; display: flex; gap: 10px; align-items: center; }
.chat-input { flex: 1; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #fff; padding: 10px; border-radius: 20px; outline: none; }
.emoji-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; transition: transform 0.1s; }
.emoji-btn:hover { transform: scale(1.1); }
.send-btn { background: var(--accent); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; }

/* EMOJI PICKER & MODALS */
.emoji-picker { display: none; position: absolute; bottom: 70px; left: 10px; background: #222; border: 1px solid #444; border-radius: 8px; width: 280px; padding: 10px; grid-template-columns: repeat(6, 1fr); gap: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 10; }
.emoji-picker.show { display: grid; }
.emoji-item { cursor: pointer; font-size: 20px; text-align: center; padding: 5px; border-radius: 4px; }
.emoji-item:hover { background: #333; }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center; }
.modal-box { background: var(--panel); width: 90%; max-width: 400px; border: 1px solid var(--accent); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 10px; position: relative; }
.modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; cursor: pointer; font-size: 18px; z-index: 5; }
input, textarea { background: #111; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; width: 100%; }

/* BROWSE LIST */
.browse-list { max-height: 400px; overflow-y: auto; margin-top: 10px; }
.browse-item { padding: 12px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: background 0.2s; }
.browse-item:hover { background: #333; }

/* JOIN TOPIC POPUP */
#joinPopupContent { background-size: cover; background-position: center; position: relative; border-radius: 8px; overflow: hidden; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
#joinPopupContent::before { content:""; position:absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); z-index:0; }
.join-inner { position: relative; z-index: 1; text-align: center; padding: 20px; width: 100%; }
.join-title { font-family: 'Uncial Antiqua'; color: var(--accent); font-size: 24px; margin-bottom: 10px; text-shadow: 2px 2px 0 #000; }
.join-desc { color: #ddd; margin-bottom: 20px; font-size: 14px; text-shadow: 1px 1px 0 #000; }

.admin-controls { display: flex; gap: 5px; }
.btn-mini { padding: 4px 8px; font-size: 10px; cursor: pointer; border: none; border-radius: 3px; }
.btn-edit { background: #444; color: #fff; }
.btn-del { background: #a00; color: #fff; }

@media (max-width: 768px) {
    .nav-links { display: none; }
    #hamburgerBtn { display: block; }
    .sidebar { width: 100%; border-right: none; }
    .chat-area { display: none; position: fixed; top: 50px; bottom: 0; left: 0; right: 0; z-index: 100; width: 100%; }
    .chat-mode .sidebar { display: none; }
    .chat-mode .chat-area { display: flex; }
    .chat-back-btn { display: block; }
}
</style>
</head>
<body>

<nav class="top-nav">
  <button id="hamburgerBtn" onclick="document.getElementById('mobileMenu').classList.toggle('show')">&#9776;</button>
  <a href="index.html" class="nav-brand">Mount Aetheria</a>
  <div class="nav-links">
    <a href="story.html">Story</a>
    <a href="tools.html">Tools</a>
    <a href="characters.html">Sheet</a>
    <a href="discussions.html" class="active" style="color:var(--accent)">Discussion</a>
    <a href="signin.html" id="authLink">Sign In</a>
  </div>
</nav>

<div id="mobileMenu">
  <a href="story.html">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html" style="color:var(--accent)">Discussion</a>
  <a href="signin.html" id="mobileAuthLink">Sign In</a>
</div>

<div class="chat-container" id="appContainer">
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="btn-action" onclick="openBrowseModal()">Browse Topics</button>
            <button class="btn-action" id="createTopicBtn" style="display:none; background:#444; color:#fff;" onclick="openCreateModal()">+ New</button>
        </div>
        <div class="topic-list" id="myTopicsList"><div style="padding:20px; text-align:center; color:#666; font-size:12px;">Loading chats...</div></div>
    </div>
    <div class="chat-area" id="chatArea">
        <div class="chat-header">
            <button class="chat-back-btn" onclick="exitChat()">&#8592;</button>
            <div class="chat-header-title"><span id="chatTitle">Select a Topic</span><span class="info-icon">&#9432;<div class="info-tooltip" id="chatDescTooltip">Topic Description</div></span></div>
        </div>
        <div class="messages-box" id="msgBox"><div style="text-align:center; color:#ccc; margin-top:50px; text-shadow: 1px 1px 2px #000;"><p>Join a topic to start chatting.</p></div></div>
        <form class="input-area" id="chatForm" style="display:none;">
            <button type="button" class="emoji-btn" onclick="document.getElementById('emojiPicker').classList.toggle('show')">‚öîÔ∏è</button>
            <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-item" onclick="addEmoji('üé≤')">üé≤</div><div class="emoji-item" onclick="addEmoji('‚öîÔ∏è')">‚öîÔ∏è</div><div class="emoji-item" onclick="addEmoji('üõ°Ô∏è')">üõ°Ô∏è</div><div class="emoji-item" onclick="addEmoji('üèπ')">üèπ</div><div class="emoji-item" onclick="addEmoji('üßô‚Äç‚ôÇÔ∏è')">üßô‚Äç‚ôÇÔ∏è</div><div class="emoji-item" onclick="addEmoji('üêâ')">üêâ</div><div class="emoji-item" onclick="addEmoji('üî•')">üî•</div><div class="emoji-item" onclick="addEmoji('‚ú®')">‚ú®</div><div class="emoji-item" onclick="addEmoji('üìú')">üìú</div><div class="emoji-item" onclick="addEmoji('üç∫')">üç∫</div><div class="emoji-item" onclick="addEmoji('üíÄ')">üíÄ</div><div class="emoji-item" onclick="addEmoji('üí∞')">üí∞</div><div class="emoji-item" onclick="addEmoji('üóùÔ∏è')">üóùÔ∏è</div><div class="emoji-item" onclick="addEmoji('üíç')">üíç</div><div class="emoji-item" onclick="addEmoji('üê∫')">üê∫</div><div class="emoji-item" onclick="addEmoji('üåô')">üåô</div><div class="emoji-item" onclick="addEmoji('üß™')">üß™</div><div class="emoji-item" onclick="addEmoji('üíé')">üíé</div>
            </div>
            <input type="text" class="chat-input" id="msgInput" placeholder="Type a message..." autocomplete="off">
            <button type="submit" class="send-btn">&#10148;</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="createModal"><div class="modal-box"><button class="modal-close" onclick="closeModals()">x</button><h3 style="color:var(--accent); text-align:center;" id="createModalTitle">Create Topic</h3><input type="hidden" id="editTopicId"> <input id="newTopicName" placeholder="Topic Name"><input id="newTopicDesc" placeholder="Short Description"><input id="newTopicImg" placeholder="Image URL (Background)"><input id="newTopicPass" placeholder="Password (Optional)"><button class="btn-action" onclick="submitTopicForm()">Save</button></div></div>
<div class="modal-overlay" id="browseModal"><div class="modal-box" style="max-width:500px; height:80vh;"><button class="modal-close" onclick="closeModals()">x</button><h3 style="color:var(--accent); text-align:center;">Browse Topics</h3><input id="searchTopics" placeholder="Search topics..." onkeyup="filterBrowse()"><div class="browse-list" id="browseListContainer"></div></div></div>
<div class="modal-overlay" id="joinModal"><div class="modal-box" id="joinPopupContent"><button class="modal-close" onclick="closeModals()">x</button><div class="join-inner"><div class="join-title" id="joinTitle">Topic Name</div><div class="join-desc" id="joinDesc">Topic Description goes here...</div><input type="password" id="joinPassInput" placeholder="Enter Password" style="display:none; margin-bottom:10px; text-align:center;"><button class="btn-action" onclick="confirmJoin()">Join Topic</button><div id="joinError" style="color:#f44; font-size:12px; margin-top:5px; display:none;"></div></div></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, onSnapshot, query, orderBy, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw", authDomain: "mount-aetheria.firebaseapp.com", projectId: "mount-aetheria", storageBucket: "mount-aetheria.firebasestorage.app", messagingSenderId: "492855693446", appId: "1:492855693446:web:f99485569254a7220c38107", measurementId: "G-0PF84KDN7L" };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_EMAIL = "phoeaung2076@gmail.com";

let currentUser = null;
let isAdmin = false;
let currentProfile = { name: "Player", pfp: "" };
let activeTopicId = null;
let joinedTopicsData = []; 
let allTopicsCache = [];
let msgUnsub = null;
let pendingJoinId = null;
let pendingJoinPass = null;

onAuthStateChanged(auth, async (user) => {
    const link = document.getElementById('authLink');
    const mLink = document.getElementById('mobileAuthLink');
    if(user){
        currentUser = user;
        link.textContent = "My Account"; link.href = "account.html";
        mLink.textContent = "My Account"; mLink.href = "account.html";
        
        if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
            isAdmin = true;
            document.getElementById('createTopicBtn').style.display = 'block';
        }
        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if(userDoc.exists()) {
                const data = userDoc.data();
                currentProfile.name = data.displayName || data.username || `Player${Math.floor(Math.random()*9000)}`;
                currentProfile.pfp = data.photoURL || data.pfp || "";
            }
        } catch(e) { console.error(e); }
        initSidebar();
    } else {
        window.location.href = "signin.html";
    }
});

// --- SIDEBAR & JOINED TOPICS ---
function initSidebar() {
    const joinedRef = collection(db, "users", currentUser.uid, "joined");
    onSnapshot(joinedRef, (snapshot) => {
        const myJoins = [];
        snapshot.forEach(doc => myJoins.push({ id: doc.id, readCount: doc.data().readCount || 0 }));
        
        const q = query(collection(db, "topics")); 
        onSnapshot(q, (topicSnap) => {
            joinedTopicsData = [];
            topicSnap.forEach(tDoc => {
                const userJoin = myJoins.find(u => u.id === tDoc.id);
                if (userJoin) {
                    const tData = tDoc.data();
                    const totalMsgs = tData.messageCount || 0;
                    const unread = Math.max(0, totalMsgs - userJoin.readCount);
                    joinedTopicsData.push({ id: tDoc.id, ...tData, unread: unread, lastActiveTime: tData.lastActive ? tData.lastActive.seconds : 0 });
                }
            });
            joinedTopicsData.sort((a, b) => b.lastActiveTime - a.lastActiveTime);
            renderSidebar();
        });
    });
}

function renderSidebar() {
    const container = document.getElementById('myTopicsList');
    container.innerHTML = '';
    if(joinedTopicsData.length === 0) { container.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">Click "Browse Topics" to join.</div>'; return; }
    joinedTopicsData.forEach(topic => {
        const div = document.createElement('div');
        div.className = `topic-card ${activeTopicId === topic.id ? 'active' : ''}`;
        div.onclick = () => openChat(topic);
        const imgHtml = topic.img ? `<img src="${topic.img}" class="topic-img">` : `<div class="topic-img" style="background:#333"></div>`;
        const badgeHtml = topic.unread > 0 ? `<div class="unread-badge">${topic.unread}</div>` : '';
        div.innerHTML = `${imgHtml}<div class="topic-info"><div style="display:flex; justify-content:space-between;"><span>${topic.title}</span>${badgeHtml}</div><div class="topic-desc-preview">${topic.desc}</div></div>`;
        container.appendChild(div);
    });
}

// --- CHAT LOGIC ---
window.openChat = async (topic) => {
    activeTopicId = topic.id;
    document.getElementById('chatTitle').textContent = topic.title;
    document.getElementById('chatDescTooltip').textContent = topic.desc || "No description.";
    document.getElementById('chatForm').style.display = 'flex';
    document.getElementById('msgBox').innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">Loading...</div>';
    
    const area = document.getElementById('chatArea');
    if(topic.img) area.style.backgroundImage = `url('${topic.img}')`; else area.style.backgroundImage = `none`;
    
    renderSidebar(); 
    document.getElementById('appContainer').classList.add('chat-mode');
    await setDoc(doc(db, "users", currentUser.uid, "joined", topic.id), { readCount: topic.messageCount || 0 }, { merge: true });

    if(msgUnsub) msgUnsub();
    const q = query(collection(db, "topics", topic.id, "messages"), orderBy("timestamp", "asc"));
    msgUnsub = onSnapshot(q, (snap) => {
        const box = document.getElementById('msgBox'); box.innerHTML = '';
        if(snap.empty) box.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">No messages yet.</div>';
        snap.forEach(d => {
            const m = d.data();
            const isMine = m.senderId === currentUser.uid;
            const date = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            const pfpHtml = m.senderPfp ? `<img src="${m.senderPfp}" class="msg-avatar">` : `<div class="msg-avatar" style="background:#000"></div>`;
            const row = document.createElement('div'); row.className = `msg ${isMine?'mine':''}`;
            row.innerHTML = `${pfpHtml}<div><div class="msg-meta">${isMine?'You':m.senderName} ‚Ä¢ ${date}</div><div class="msg-content">${escapeHtml(m.content)}</div></div>`;
            box.appendChild(row);
        });
        box.scrollTop = box.scrollHeight;
    });
}

window.exitChat = () => { document.getElementById('appContainer').classList.remove('chat-mode'); activeTopicId = null; if(msgUnsub) msgUnsub(); renderSidebar(); }

document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault(); const input = document.getElementById('msgInput'); const txt = input.value.trim();
    if(!txt || !activeTopicId) return;
    input.value = ''; document.getElementById('emojiPicker').classList.remove('show');
    try {
        await addDoc(collection(db, "topics", activeTopicId, "messages"), { content: txt, senderId: currentUser.uid, senderName: currentProfile.name, senderPfp: currentProfile.pfp, timestamp: serverTimestamp() });
        await updateDoc(doc(db, "topics", activeTopicId), { lastActive: serverTimestamp(), messageCount: increment(1) });
    } catch(err) { console.error(err); alert("Error sending."); }
});

window.addEmoji = (char) => { const inp = document.getElementById('msgInput'); inp.value += char; inp.focus(); }

window.openCreateModal = () => { document.getElementById('createModalTitle').textContent = "Create Topic"; document.getElementById('editTopicId').value = ""; document.getElementById('newTopicName').value = ""; document.getElementById('newTopicDesc').value = ""; document.getElementById('newTopicImg').value = ""; document.getElementById('newTopicPass').value = ""; document.getElementById('createModal').style.display = 'flex'; }
window.openEditModal = (id) => { const t = allTopicsCache.find(x => x.id === id); if(!t) return; document.getElementById('createModalTitle').textContent = "Edit Topic"; document.getElementById('editTopicId').value = id; document.getElementById('newTopicName').value = t.title; document.getElementById('newTopicDesc').value = t.desc; document.getElementById('newTopicImg').value = t.img; document.getElementById('newTopicPass').value = t.password || ""; document.getElementById('browseModal').style.display = 'none'; document.getElementById('createModal').style.display = 'flex'; }
window.deleteTopic = async (id) => { if(!confirm("Delete this topic?")) return; await deleteDoc(doc(db, "topics", id)); openBrowseModal(); }
window.submitTopicForm = async () => {
    const id = document.getElementById('editTopicId').value; const title = document.getElementById('newTopicName').value; const desc = document.getElementById('newTopicDesc').value; const img = document.getElementById('newTopicImg').value; const pass = document.getElementById('newTopicPass').value;
    if(!title) return alert("Title required");
    const data = { title, desc, img, password: pass, lastActive: serverTimestamp() };
    if(id) await updateDoc(doc(db, "topics", id), data); else { data.createdAt = serverTimestamp(); data.messageCount = 0; await addDoc(collection(db, "topics"), data); }
    closeModals();
}

window.openBrowseModal = async () => { document.getElementById('browseModal').style.display = 'flex'; document.getElementById('browseListContainer').innerHTML = 'Loading...'; const snap = await getDocs(query(collection(db, "topics"), orderBy("lastActive", "desc"))); allTopicsCache = []; snap.forEach(d => allTopicsCache.push({id: d.id, ...d.data()})); filterBrowse(); }
window.filterBrowse = () => {
    const term = document.getElementById('searchTopics').value.toLowerCase(); const list = document.getElementById('browseListContainer'); list.innerHTML = '';
    allTopicsCache.filter(t => t.title.toLowerCase().includes(term)).forEach(t => {
        const isJoined = joinedTopicsData.find(j => j.id === t.id);
        let adminBtns = ''; if(isAdmin) adminBtns = `<div class="admin-controls"><button class="btn-mini btn-edit" onclick="event.stopPropagation(); openEditModal('${t.id}')">Edit</button><button class="btn-mini btn-del" onclick="event.stopPropagation(); deleteTopic('${t.id}')">Del</button></div>`;
        const div = document.createElement('div'); div.className = 'browse-item'; div.onclick = () => showJoinPopup(t); 
        div.innerHTML = `<div><div style="font-weight:bold;color:var(--accent)">${t.title} ${isJoined ? '‚úÖ' : ''}</div><div style="font-size:11px;color:#888;">${t.desc||''}</div></div>${adminBtns}`;
        list.appendChild(div);
    });
}

window.showJoinPopup = (topic) => {
    if(joinedTopicsData.find(j => j.id === topic.id)) { closeModals(); openChat(topic); return; }
    pendingJoinId = topic.id; pendingJoinPass = topic.password;
    document.getElementById('browseModal').style.display = 'none'; document.getElementById('joinModal').style.display = 'flex';
    document.getElementById('joinTitle').textContent = topic.title; document.getElementById('joinDesc').textContent = topic.desc; document.getElementById('joinError').style.display = 'none';
    const content = document.getElementById('joinPopupContent');
    if(topic.img) content.style.backgroundImage = `url('${topic.img}')`; else { content.style.backgroundImage = `none`; content.style.backgroundColor = '#222'; }
    const passInput = document.getElementById('joinPassInput'); if(topic.password) { passInput.style.display = 'block'; passInput.value = ''; } else passInput.style.display = 'none';
}

window.confirmJoin = async () => {
    const err = document.getElementById('joinError');
    if(pendingJoinPass) { const val = document.getElementById('joinPassInput').value; if(val !== pendingJoinPass) { err.textContent = "Wrong password."; err.style.display = 'block'; return; } }
    const t = allTopicsCache.find(x => x.id === pendingJoinId);
    await setDoc(doc(db, "users", currentUser.uid, "joined", pendingJoinId), { joinedAt: serverTimestamp(), readCount: t.messageCount || 0 });
    closeModals(); openChat(t);
}

window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
function escapeHtml(text) { if(!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
</script>
</body>
</html>