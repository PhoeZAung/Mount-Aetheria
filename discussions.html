<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discussions - Mount Aetheria</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
body {
  margin: 0;
  padding-top: 70px;
  font-family: Arial, sans-serif;
  background: linear-gradient(to bottom, #222, #444);
  color: #fff;
  min-height: 100vh;
  display: none;
  flex-direction: column;
  align-items: center;
}

/* NAV */
.top-nav{width:100%;background:#111;padding:15px 20px;display:flex;justify-content:space-around;align-items:center;position:fixed;top:0;left:0;z-index:2000}
.top-nav a{color:#fff;text-decoration:none;font-size:18px;font-weight:600;font-family:'Uncial Antiqua',serif}
.top-nav a:hover{color:#ffcc66}

/* HAMBURGER */
#hamburger{display:none;position:fixed;top:15px;left:15px;background:#111;color:#fff;border:none;padding:10px;font-size:24px;cursor:pointer;z-index:2001;border-radius:5px;}
#navMenu{display:none;flex-direction:column;background:#111;position:fixed;top:60px;left:15px;border-radius:8px;z-index:2000;box-shadow:0 5px 15px rgba(0,0,0,0.8);overflow:hidden;}
#navMenu a{padding:12px 20px;color:#fff;text-decoration:none;border-bottom:1px solid #333;font-family:'Uncial Antiqua',serif;display:block;}

/* LAYOUT */
.main-container { width: 95%; max-width: 1000px; display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin-bottom: 40px; height: 80vh; }
.topics-panel { background: #333; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
.topics-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
.topics-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }

/* TOPIC ITEM */
.topic-item { background: #222; padding: 12px; border-radius: 6px; cursor: pointer; border-left: 3px solid transparent; transition: background 0.2s; position: relative; display:flex; justify-content:space-between; align-items:center; }
.topic-item:hover { background: #444; }
.topic-item.active { border-left: 3px solid #ffcc66; background: #444; }
.topic-info { flex: 1; overflow: hidden; }
.topic-title { font-weight: bold; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.topic-meta { font-size: 11px; color: #aaa; }
/* Unread Badge Style */
.unread-badge { background: #ff4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; margin-left: 10px; flex-shrink: 0; }
.delete-btn { color: #ff6666; cursor: pointer; font-size: 16px; margin-left: 10px; font-weight: bold; z-index: 10; flex-shrink: 0; }

/* CHAT PANEL */
.chat-panel { background: #333; border-radius: 12px; padding: 0; display: flex; flex-direction: column; overflow: hidden; }
.chat-header { background: #222; padding: 15px; border-bottom: 1px solid #444; font-family: 'Uncial Antiqua', serif; font-size: 20px; color: #ffcc66; display: flex; align-items: center; gap: 10px; }
.messages-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

.message { display: flex; gap: 10px; max-width: 80%; align-items: flex-start; }
.message.self { align-self: flex-end; flex-direction: row-reverse; }
.avatar { width: 40px; height: 40px; border-radius: 50%; background: #000; object-fit: cover; flex-shrink: 0; border: 1px solid #555; }
.msg-content { background: #444; padding: 10px 15px; border-radius: 12px; border-top-left-radius: 2px; position: relative; }
.message.self .msg-content { background: #5a4a2a; border-top-left-radius: 12px; border-top-right-radius: 2px; }
.sender-name { font-size: 11px; color: #ffcc66; margin-bottom: 2px; font-weight: bold; }
.msg-text { font-size: 14px; line-height: 1.4; word-wrap: break-word; }

/* INPUT */
.input-area { padding: 15px; background: #222; display: flex; gap: 10px; border-top: 1px solid #444; position: relative;}
.input-area input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #555; background: #333; color: #fff; outline: none; }
.input-area button { background: #ffcc66; color: #000; padding: 10px; font-weight: bold; border: none; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
.input-area button:disabled { background: #555; }

/* Mobile Back Button */
#backBtn { display: none; background: transparent; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 5px 10px; cursor: pointer; }

/* EMOJI PICKER STYLES */
#emojiPicker {
    position: absolute;
    bottom: 60px; /* Above the input area */
    left: 10px;
    background: #2b2b2b;
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    display: none;
    z-index: 100;
}
.emoji-item {
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
    margin: 2px;
    transition: background 0.1s;
    border-radius: 4px;
    line-height: 1;
}
.emoji-item:hover {
    background: #444;
}

/* Mobile Responsiveness for chat view */
@media(max-width: 768px){
  .top-nav { display: none; }
  #hamburger { display: block; }
  .main-container { display: block; height: 85vh; position: relative; }
  .topics-panel { width: 100%; height: 100%; box-sizing: border-box; }
  .chat-panel { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
  
  .main-container.mobile-chat-active .topics-panel { display: none; }
  .main-container.mobile-chat-active .chat-panel { display: flex; }
  #backBtn { display: block; }
  #emojiPicker {
    bottom: 80px;
    left: auto;
    right: 15px;
  }
}
</style>
</head>
<body>

<nav class="top-nav">
  <a href="index.html">Home</a>
  <a href="story.html">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html" class="active">Discussion</a>
  <a href="login.html" id="authLink">Sign In</a>
</nav>

<button id="hamburger">&#9776;</button>
<div id="navMenu">
  <a href="index.html">Home</a>
  <a href="story.html">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html" class="active">Discussion</a>
  <a href="login.html" id="mobileAuthLink">Sign In</a>
</div>

<div class="main-container" id="mainContainer">
  <div class="topics-panel">
    <div class="topics-header">
      <span style="font-family:'Uncial Antiqua'; font-size:18px;">Topics</span>
      <button id="createTopicBtn" style="width:auto; height:auto; padding:5px 10px; border-radius:4px; font-size:14px; margin:0;">New Topic</button>
    </div>
    <div id="topicsList" class="topics-list">
      <div style="text-align:center; padding:20px; color:#aaa;">Loading topics...</div>
    </div>
  </div>

  <div class="chat-panel">
    <div class="chat-header">
      <button id="backBtn">&larr;</button>
      <span id="chatHeader">Select a Topic</span>
    </div>
    <div class="messages-area" id="messagesArea"></div>
    <div class="input-area">
      <button id="emojiBtn" disabled style="background:#333; color:white; font-size: 20px;">üòä</button>
      <input type="text" id="msgInput" placeholder="Type a message..." disabled>
      <button id="sendBtn" disabled>&#10148;</button>
      <div id="emojiPicker">
        <span class="emoji-item" data-emoji="üòä">üòä</span>
        <span class="emoji-item" data-emoji="üòÇ">üòÇ</span>
        <span class="emoji-item" data-emoji="üëç">üëç</span>
        <span class="emoji-item" data-emoji="üî•">üî•</span>
        <span class="emoji-item" data-emoji="ü§î">ü§î</span>
        <span class="emoji-item" data-emoji="üéâ">üéâ</span>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, query, where, getDocs, updateDoc, increment, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw",
  authDomain: "mount-aetheria.firebaseapp.com",
  projectId: "mount-aetheria",
  storageBucket: "mount-aetheria.firebasestorage.app",
  messagingSenderId: "492855693446",
  appId: "1:492855693446:web:f9948569254a7220c38107",
  measurementId: "G-0PF84KDN7L"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "phoeaung2076@gmail.com"; 
let currentUser = null;
let activeTopicId = null;

// Auth check
onAuthStateChanged(auth, async (user) => {
  const link = document.getElementById('authLink');
  const mLink = document.getElementById('mobileAuthLink');
  if (!user) {
    window.location.href = "login.html";
  } else {
    currentUser = auth.currentUser;
    await user.reload(); 
    document.body.style.display = "flex";
    if(link) { link.textContent = "My Account"; link.href = "account.html"; }
    if(mLink) { mLink.textContent = "My Account"; mLink.href = "account.html"; }
    if (currentUser.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
      document.getElementById('createTopicBtn').style.display = 'none';
    }
    loadTopics();
  }
});

// Load Topics (Implements sort by last message, unread tracking, and timeout)
function loadTopics() {
  const topicsRef = collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_topics');
  // Sort by lastActivity to bring most recent threads to the top (PC and Mobile)
  const q = query(topicsRef, orderBy('lastActivity', 'desc'));

  onSnapshot(q, snapshot => {
    const list = document.getElementById('topicsList');
    list.innerHTML = "";
    const topics = [];
    snapshot.forEach(doc => topics.push({ id: doc.id, ...doc.data() }));
    
    // Sort logic from query handles the primary order
    
    if (topics.length === 0) {
      list.innerHTML = "<div style='padding:10px; text-align:center; color:#777;'>No topics yet.</div>";
      return;
    }
    
    topics.forEach(t => {
      // Calculate Unread with Timeout (24 hours)
      const localKey = `readCount_${t.id}`;
      let lastRead = 0;
      const storedJson = localStorage.getItem(localKey);
      
      try {
        const storedData = JSON.parse(storedJson);
        const ONE_DAY_MS = 86400000; 
        
        if (storedData && storedData.count !== undefined && storedData.timestamp !== undefined) {
          if (Date.now() - storedData.timestamp > ONE_DAY_MS) {
            // Unread status expired
            localStorage.removeItem(localKey);
          } else {
            lastRead = storedData.count;
          }
        }
      } catch (e) {
        localStorage.removeItem(localKey);
      }
      
      const serverCount = t.msgCount || 0;
      const unread = Math.max(0, serverCount - lastRead); 

      const div = document.createElement('div');
      div.className = `topic-item ${activeTopicId === t.id ? 'active' : ''}`;
      
      let adminControls = (currentUser && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) 
                          ? `<span class="delete-btn" data-topic-id="${t.id}">&times;</span>` : '';
      
      // Unread badge logic
      let badgeHtml = unread > 0 ? `<div class="unread-badge">${unread > 99 ? '99+' : unread}</div>` : '';

      div.innerHTML = `
        <div class="topic-info">
            <div class="topic-title">${escapeHtml(t.title)}</div>
            <div class="topic-meta">by ${escapeHtml(t.creatorName)}</div>
        </div>
        ${badgeHtml}
        ${adminControls}
      `;
      
      div.onclick = () => selectTopic(t.id, t.title, serverCount);
      
      const deleteBtn = div.querySelector('.delete-btn');
      if (deleteBtn) {
          deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteTopic(t.id, t.title); });
      }
      list.appendChild(div);
    });
  });
}

function getLocalReadCountData(topicId) {
    const storedJson = localStorage.getItem(`readCount_${topicId}`);
    try {
        const data = JSON.parse(storedJson);
        return data || { count: 0, timestamp: 0 };
    } catch {
        return { count: 0, timestamp: 0 };
    }
}

function selectTopic(topicId, title, currentServerCount) {
  activeTopicId = topicId;
  document.getElementById('chatHeader').textContent = title;
  document.getElementById('msgInput').disabled = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('emojiBtn').disabled = false;
  
  // Mobile Transition
  document.getElementById('mainContainer').classList.add('mobile-chat-active');
  
  // Mark as read in LocalStorage with timestamp to clear the badge
  if(currentServerCount !== undefined) {
      const dataToStore = JSON.stringify({
          count: currentServerCount,
          timestamp: Date.now() 
      });
      localStorage.setItem(`readCount_${topicId}`, dataToStore);
  }

  loadMessages(topicId);
}

let unsubscribeMessages = null;
function loadMessages(topicId) {
  if (unsubscribeMessages) unsubscribeMessages();
  const messagesRef = collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_messages');
  // FIX: Added orderBy('createdAt', 'asc') to ensure messages are correctly retrieved and ordered.
  const q = query(messagesRef, where("topicId", "==", topicId), orderBy('createdAt', 'asc'));
  
  unsubscribeMessages = onSnapshot(q, snapshot => {
    const container = document.getElementById('messagesArea');
    container.innerHTML = "";
    const allMsgs = [];
    snapshot.forEach(doc => allMsgs.push({ id: doc.id, ...doc.data() }));

    // Re-update local read count to match actual messages loaded (in case of race conditions)
    if(allMsgs.length > 0 && activeTopicId === topicId) {
        const dataToStore = JSON.stringify({
            count: allMsgs.length,
            timestamp: Date.now() 
        });
        localStorage.setItem(`readCount_${topicId}`, dataToStore);
    }

    if (allMsgs.length === 0) {
      container.innerHTML = "<div style='text-align:center; color:#555; margin-top:20px;'>No messages yet.</div>";
      return;
    }
    
    allMsgs.forEach(msg => {
      const isSelf = msg.senderId === currentUser.uid;
      const div = document.createElement('div');
      div.className = `message ${isSelf ? 'self' : ''}`;
      const pfp = msg.senderPfp || 'https://via.placeholder.com/40?text=?';
      div.innerHTML = `<img src="${pfp}" class="avatar" onerror="this.src='https://via.placeholder.com/40?text=?'">
                       <div class="msg-content"><div class="sender-name">${escapeHtml(msg.senderName)}</div><div class="msg-text">${escapeHtml(msg.text)}</div></div>`;
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
    // Re-run topic load to update unread badges, which now uses the newly stored local count
    loadTopics(); 
  });
}

document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('msgInput').addEventListener('keypress', (e) => { if(e.key==='Enter') sendMessage(); });

async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !activeTopicId) return;
  
  try {
    // 1. Add Message
    await addDoc(collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_messages'), {
      topicId: activeTopicId,
      text: text,
      senderId: currentUser.uid,
      senderName: currentUser.displayName || "Anonymous",
      senderPfp: currentUser.photoURL || "",
      createdAt: serverTimestamp()
    });

    // 2. Update Topic (Increment count & Set LastActivity)
    const topicRef = doc(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_topics', activeTopicId);
    await updateDoc(topicRef, {
        lastActivity: serverTimestamp(),
        msgCount: increment(1)
    });

    input.value = "";
    
    // Update local count immediately so I don't see my own message as "unread"
    const currentData = getLocalReadCountData(activeTopicId);
    const dataToStore = JSON.stringify({
        count: currentData.count + 1,
        timestamp: Date.now() 
    });
    localStorage.setItem(`readCount_${activeTopicId}`, dataToStore);

  } catch(e) {
    console.error(e);
  }
}

async function deleteTopic(topicId, title) {
    if (!confirm(`Delete topic: "${title}"?`)) return;
    try {
        const messagesRef = collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_messages');
        const q = query(messagesRef, where("topicId", "==", topicId));
        const messageDocs = await getDocs(q);
        await Promise.all(messageDocs.docs.map(d => deleteDoc(d.ref)));
        await deleteDoc(doc(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_topics', topicId));
        
        if (activeTopicId === topicId) {
            activeTopicId = null;
            document.getElementById('chatHeader').textContent = "Select a Topic";
            document.getElementById('messagesArea').innerHTML = "";
            document.getElementById('mainContainer').classList.remove('mobile-chat-active');
        }
    } catch (e) { alert("Error: " + e.message); }
}

// UI Toggles
document.getElementById('hamburger').addEventListener('click', () => {
    const m = document.getElementById('navMenu');
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
});

document.getElementById('backBtn').addEventListener('click', () => {
    document.getElementById('mainContainer').classList.remove('mobile-chat-active');
    activeTopicId = null; // Deselect
    loadTopics(); // Refresh the list to show any new unread counts
});

document.getElementById('createTopicBtn').addEventListener('click', async () => {
  const title = prompt("Enter new topic title:");
  if (title) {
      await addDoc(collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_topics'), {
      title: title, 
      creatorName: currentUser.displayName || "Anonymous", 
      createdAt: serverTimestamp(),
      lastActivity: serverTimestamp(), // Init with current time for sorting
      msgCount: 0 // Init count
    });
  }
});

// === EMOJI LOGIC ===
const emojiBtn = document.getElementById('emojiBtn');
const emojiPicker = document.getElementById('emojiPicker');
const msgInput = document.getElementById('msgInput');

emojiBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
    emojiPicker.style.flexWrap = 'wrap';
});

document.querySelectorAll('.emoji-item').forEach(item => {
    item.addEventListener('click', () => {
        const emoji = item.dataset.emoji;
        msgInput.value += emoji;
        msgInput.focus();
        emojiPicker.style.display = 'none';
    });
});

document.addEventListener('click', (e) => {
    if (emojiPicker.style.display === 'flex' && e.target !== emojiBtn && !emojiPicker.contains(e.target)) {
        emojiPicker.style.display = 'none';
    }
});
// END EMOJI LOGIC

function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
</script>
</body>
</html>