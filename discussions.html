<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discussions - Mount Aetheria</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
body {
  margin: 0;
  padding-top: 70px;
  font-family: Arial, sans-serif;
  background: linear-gradient(to bottom, #222, #444);
  color: #fff;
  min-height: 100vh;
  display: none; /* hide until auth verified */
  flex-direction: column;
  align-items: center;
}

/* Top Navigation */
.top-nav { width: 100%; background: #111; padding: 15px 20px; display: flex; justify-content: space-around; align-items: center; position: fixed; top: 0; left: 0; z-index: 2000; flex-wrap: wrap; }
.top-nav a { color: white; text-decoration: none; font-size: 18px; font-weight: 600; font-family: 'Uncial Antiqua', serif; margin: 0 10px; }
.top-nav a:hover, .top-nav a.active { color: #ffcc66; }

/* Layout */
.main-container { width: 95%; max-width: 1000px; display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin-bottom: 40px; height: 80vh; }
.topics-panel { background: #333; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
.topics-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
.topics-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }

.topic-item { background: #222; padding: 10px; border-radius: 6px; cursor: pointer; border-left: 3px solid transparent; transition: background 0.2s; position: relative; }
.topic-item:hover { background: #444; }
.topic-item.active { border-left: 3px solid #ffcc66; background: #444; }
.topic-title { font-weight: bold; font-size: 14px; }
.topic-meta { font-size: 11px; color: #aaa; margin-top: 4px; }
.delete-btn { /* Style for the delete button */
    float: right; 
    color: #ff6666; 
    cursor: pointer; 
    font-size: 16px; 
    margin-left: 5px;
    z-index: 10;
    line-height: 1;
    font-weight: bold;
}

/* Chat Panel */
.chat-panel { background: #333; border-radius: 12px; padding: 0; display: flex; flex-direction: column; overflow: hidden; }
.chat-header { background: #222; padding: 15px; border-bottom: 1px solid #444; font-family: 'Uncial Antiqua', serif; font-size: 20px; color: #ffcc66; }
.messages-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

.message { display: flex; gap: 10px; max-width: 80%; align-items: flex-start; }
.message.self { align-self: flex-end; flex-direction: row-reverse; }

.avatar { width: 40px; height: 40px; border-radius: 50%; background: #000; object-fit: cover; flex-shrink: 0; border: 1px solid #555; }
.msg-content { background: #444; padding: 10px 15px; border-radius: 12px; border-top-left-radius: 2px; position: relative; }
.message.self .msg-content { background: #5a4a2a; border-top-left-radius: 12px; border-top-right-radius: 2px; }

.sender-name { font-size: 11px; color: #ffcc66; margin-bottom: 2px; font-weight: bold; }
.msg-text { font-size: 14px; line-height: 1.4; word-wrap: break-word; }

/* Input Area */
.input-area { padding: 15px; background: #222; display: flex; gap: 10px; border-top: 1px solid #444; }
.input-area input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #555; background: #333; color: #fff; outline: none; }
.input-area input:focus { border-color: #ffcc66; }
.input-area button { background: #ffcc66; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.input-area button:hover { background: #e6b800; }
.input-area button:disabled { background: #555; cursor: default; }

@media(max-width: 700px){
  .main-container { grid-template-columns: 1fr; height: auto; display: block; }
  .topics-panel { height: 250px; margin-bottom: 20px; }
  .chat-panel { height: 60vh; }
}
</style>
</head>
<body>

<nav class="top-nav">
  <a href="index.html">Home</a>
  <a href="story.html">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html" class="active">Discussion</a>
  <a href="account.html">My Account</a>
  <a href="#" id="logoutBtn">Logout</a>
</nav>

<div class="main-container">
  <div class="topics-panel">
    <div class="topics-header">
      <span style="font-family:'Uncial Antiqua'; font-size:18px;">Topics</span>
      <button id="createTopicBtn" style="width:auto; height:auto; padding:5px 10px; border-radius:4px; font-size:14px; margin:0;">New Topic</button>
    </div>
    <div id="topicsList" class="topics-list">
      <div style="text-align:center; padding:20px; color:#aaa;">Loading topics...</div>
    </div>
  </div>

  <div class="chat-panel">
    <div class="chat-header" id="chatHeader">Select a Topic</div>
    <div class="messages-area" id="messagesArea">
      <div style="text-align:center; color:#777; margin-top:50px;">
        Join a discussion from the left
      </div>
    </div>
    <div class="input-area">
      <input type="text" id="msgInput" placeholder="Type a message..." disabled>
      <button id="sendBtn" disabled>&#10148;</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
// UPDATED IMPORTS to include Firestore methods for delete and query
import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ----- Firebase Config -----
const firebaseConfig = {
  apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw",
  authDomain: "mount-aetheria.firebaseapp.com",
  projectId: "mount-aetheria",
  storageBucket: "mount-aetheria.firebasestorage.app",
  messagingSenderId: "492855693446",
  appId: "1:492855693446:web:f9948569254a7220c38107",
  measurementId: "G-0PF84KDN7L"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "phoeaung2076@gmail.com"; // Your Admin Email

let currentUser = null;
let activeTopicId = null;

// 1. Auth check
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    // FORCE RELOAD of user profile to ensure we have the latest PFP from Account page
    await user.reload(); 
    currentUser = auth.currentUser;
    
    document.body.style.display = "flex";
    
    // HIDE "New Topic" button for non-admin users
    if (currentUser.email !== ADMIN_EMAIL) {
      document.getElementById('createTopicBtn').style.display = 'none';
    }
    
    loadTopics();
  }
});

// 2. Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = "login.html";
});

// 3. Load topics
function loadTopics() {
  const topicsRef = collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_topics');
  onSnapshot(topicsRef, snapshot => {
    const list = document.getElementById('topicsList');
    list.innerHTML = "";
    const topics = [];
    snapshot.forEach(doc => topics.push({ id: doc.id, ...doc.data() }));
    // Sort by newest
    topics.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    
    if (topics.length === 0) {
      list.innerHTML = "<div style='padding:10px; text-align:center; color:#777;'>No topics yet. Create one!</div>";
      return;
    }
    
    topics.forEach(t => {
      const div = document.createElement('div');
      div.className = `topic-item ${activeTopicId === t.id ? 'active' : ''}`;
      
      let adminControls = '';
      if (currentUser && currentUser.email === ADMIN_EMAIL) {
        // Add a delete button only for the admin
        adminControls = `<span class="delete-btn" data-topic-id="${t.id}">&times;</span>`;
      }
      
      div.innerHTML = `<div class="topic-title">${escapeHtml(t.title)} ${adminControls}</div>
                       <div class="topic-meta">by ${escapeHtml(t.creatorName)}</div>`;
      
      div.onclick = () => selectTopic(t.id, t.title);
      
      const deleteBtn = div.querySelector('.delete-btn');
      if (deleteBtn) {
          deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation(); // Prevent selecting the topic
              deleteTopic(t.id, t.title);
          });
      }
      
      list.appendChild(div);
    });
  });
}

// 4. Select topic & load messages
function selectTopic(topicId, title) {
  activeTopicId = topicId;
  document.getElementById('chatHeader').textContent = title;
  document.getElementById('msgInput').disabled = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('msgInput').focus();
  
  // Highlight active topic visually
  const items = document.querySelectorAll('.topic-item');
  items.forEach(i => i.classList.remove('active'));
  // This logic works by re-running loadTopics to rebuild the list with the 'active' class
  // For simplicity, we just rely on the next run of onSnapshot or a page reload for the highlight
  
  loadMessages(topicId);
}

let unsubscribeMessages = null;

function loadMessages(topicId) {
  if (unsubscribeMessages) unsubscribeMessages();
  
  const messagesRef = collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_messages');
  // Use a query to filter messages by topicId efficiently
  const q = query(messagesRef, where("topicId", "==", topicId));
  
  unsubscribeMessages = onSnapshot(q, snapshot => {
    const container = document.getElementById('messagesArea');
    container.innerHTML = "";
    
    const allMsgs = [];
    snapshot.forEach(doc => {
      allMsgs.push({ id: doc.id, ...doc.data() });
    });
    
    // Sort oldest to newest for chat
    allMsgs.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
    
    if (allMsgs.length === 0) {
      container.innerHTML = "<div style='text-align:center; color:#555; margin-top:20px;'>No messages yet. Be the first!</div>";
      return;
    }
    
    allMsgs.forEach(msg => {
      const isSelf = msg.senderId === currentUser.uid;
      const div = document.createElement('div');
      div.className = `message ${isSelf ? 'self' : ''}`;
      
      // Use a default placeholder if pfp is missing
      const pfp = msg.senderPfp || 'https://via.placeholder.com/40?text=?';
      
      div.innerHTML = `<img src="${pfp}" class="avatar" alt="pfp" onerror="this.src='https://via.placeholder.com/40?text=?'">
                       <div class="msg-content">
                         <div class="sender-name">${escapeHtml(msg.senderName)}</div>
                         <div class="msg-text">${escapeHtml(msg.text)}</div>
                       </div>`;
      container.appendChild(div);
    });
    
    // Auto scroll to bottom
    container.scrollTop = container.scrollHeight;
  });
}

// 5. Send message
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('msgInput').addEventListener('keypress', (e) => { if(e.key==='Enter') sendMessage(); });

async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !activeTopicId) return;
  
  try {
    // Send with the LATEST profile info
    await addDoc(collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_messages'), {
      topicId: activeTopicId,
      text: text,
      senderId: currentUser.uid,
      senderName: currentUser.displayName || "Anonymous",
      senderPfp: currentUser.photoURL || "", 
      createdAt: serverTimestamp()
    });
    input.value = "";
  } catch(e) { 
    console.error(e);
    alert("Failed to send: " + e.message); 
  }
}

// 6. Delete Topic Function (Admin Only)
async function deleteTopic(topicId, title) {
    if (currentUser.email !== ADMIN_EMAIL) return alert("You do not have permission to delete topics.");
    if (!confirm(`Are you sure you want to delete the topic: "${title}"? This will also delete all associated messages.`)) return;

    try {
        // 1. Delete all messages associated with the topic
        const messagesRef = collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_messages');
        const q = query(messagesRef, where("topicId", "==", topicId));
        const messageDocs = await getDocs(q);

        const deletePromises = messageDocs.docs.map(d => deleteDoc(d.ref));
        await Promise.all(deletePromises);
        
        // 2. Delete the topic document
        const topicDocRef = doc(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_topics', topicId);
        await deleteDoc(topicDocRef);
        
        alert(`Topic "${title}" and ${messageDocs.size} messages deleted successfully.`);
        
        // Clear chat area if the active topic was deleted
        if (activeTopicId === topicId) {
            activeTopicId = null;
            document.getElementById('chatHeader').textContent = "Select a Topic";
            document.getElementById('messagesArea').innerHTML = "<div style='text-align:center; color:#777; margin-top:50px;'>Join a discussion from the left</div>";
            document.getElementById('msgInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }

    } catch (e) {
        console.error("Error deleting topic:", e);
        alert("Failed to delete topic: " + e.message);
    }
}


// Utility to prevent XSS attacks
function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}

document.getElementById('createTopicBtn').addEventListener('click', async () => {
  if (currentUser.email !== ADMIN_EMAIL) return alert("You do not have permission to create topics.");
    
  const title = prompt("Enter new topic title:");
  if (!title) return;

  try {
    await addDoc(collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'discussions_topics'), {
      title: title,
      creatorName: currentUser.displayName || "Anonymous",
      createdAt: serverTimestamp()
    });
  } catch(e) {
    alert("Failed to create topic: " + e.message);
  }
});
</script>
</body>
</html>