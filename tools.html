<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tools - Mount Aetheria</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a1a">
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* --- THEME --- */
:root { --bg: #1a1a1a; --panel: #252525; --border: #333; --accent: #ffcc66; --text: #ddd; }
*{box-sizing: border-box;}
body { margin: 0; padding-top: 70px; font-family: Arial, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 20px; }

/* --- NAV --- */
.top-nav { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #000; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 2000; }
.nav-brand { font-family: 'Uncial Antiqua'; color: var(--accent); font-size: 18px; text-decoration: none; }
.nav-links { display: flex; gap: 20px; }
.nav-links a { color: #888; text-decoration: none; font-size: 14px; font-weight: bold; }
.nav-links a:hover, .nav-links a.active { color: #fff; }
#hamburgerBtn { display: none; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; }

#mobileMenu { 
  display: none; 
  position: fixed; top: 50px; left: 0; width: 100%; 
  background: #111; border-bottom: 1px solid var(--accent); 
  flex-direction: column; z-index: 1999; 
  align-items: flex-start; 
}
#mobileMenu.show { display: flex; }
#mobileMenu a { 
  width: 100%; padding: 15px 20px; 
  color: #fff; text-decoration: none; 
  border-bottom: 1px solid #333; 
  font-family: 'Uncial Antiqua'; 
  text-align: left; 
}

h1 { color: var(--accent); font-family: 'Uncial Antiqua'; text-align: center; margin-bottom: 30px; }

/* TABS */
.tab-buttons { margin: 20px auto; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; max-width: 90%; }
.tab-buttons button { background: #333; border: 1px solid #555; color: #fff; padding: 10px 30px; font-size: 16px; font-family: 'Uncial Antiqua', serif; cursor: pointer; border-radius: 8px; transition: .2s; flex: 1; max-width: 200px; }
.tab-buttons button.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }
.tab-buttons button:hover { background: #444; }

/* CONTENT */
.tab-content { display: none; max-width: 900px; margin: 0 auto 50px auto; text-align: center; }
.tab-content.active { display: block; }

/* URL CARDS */
.url-grid { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; padding: 10px; }
.url-card { width: 150px; height: 150px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: #fff; font-weight: bold; transition: .2s; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); padding: 10px; }
.url-card img { width: 100%; height: 60px; object-fit: contain; margin-bottom: 10px; }
.url-card:hover { background: #333; transform: translateY(-3px); border-color: var(--accent); }

/* CALENDAR */
.calendar { background: var(--panel); padding: 20px; border-radius: 12px; text-align: left; max-width: 700px; margin: 0 auto; border: 1px solid var(--border); min-height: 300px; }
.calendar h2 { font-family: 'Uncial Antiqua', cursive; margin-top: 0; margin-bottom: 20px; font-size: 22px; color: var(--accent); text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px; }
.calendar-filters { margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.calendar-btn { background: #222; border: 1px solid #555; color: #ccc; padding: 8px 16px; font-size: 14px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
.calendar-btn.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }
.calendar-btn:hover { border-color: #999; }

/* EVENTS LIST */
.event-list { display: none; }
.event-list.active { display: block; }
.event-item { background: #333; margin: 10px 0; padding: 12px 15px; border-radius: 8px; font-size: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--accent); }
.event-item .date { font-weight: bold; color: var(--accent); margin-right: 10px; min-width: 80px; }
.event-item .desc { flex: 1; color: #ddd; }
.event-actions { display: flex; gap: 10px; }
.event-btn-icon { background: none; border: none; cursor: pointer; opacity: 0.7; font-size: 14px; }
.event-btn-icon:hover { opacity: 1; transform: scale(1.1); }
.btn-edit { color: #66ccff; }
.btn-del { color: #ff6666; }

/* ADMIN PANEL */
#adminPanel { display: none; background: #2a1a1a; padding: 15px; border: 1px solid #633; border-radius: 8px; margin-bottom: 20px; }
#adminPanel h3 { margin: 0 0 10px 0; color: #eaa; font-size: 16px; }
.admin-form { display: flex; gap: 10px; flex-wrap: wrap; }
.admin-form input, .admin-form select { background: #111; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; flex: 1; }
.admin-form button { background: var(--accent); color: #000; border: none; padding: 8px 20px; font-weight: bold; border-radius: 4px; cursor: pointer; }

/* --- CUSTOM MODAL --- */
.custom-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:3000; justify-content:center; align-items:center; backdrop-filter:blur(3px); }
.custom-modal-content { background: var(--panel); border: 1px solid var(--accent); padding: 25px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
.custom-modal-content h3 { color: var(--accent); font-family: 'Uncial Antiqua'; margin-top: 0; }
.custom-modal-content p { color: #ccc; margin-bottom: 20px; line-height: 1.5; }
.modal-actions { display: flex; gap: 10px; justify-content: center; }
.modal-btn { padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; flex: 1; }
.modal-btn.confirm { background: var(--accent); color: #000; }
.modal-btn.cancel { background: #444; color: #fff; }

.empty-msg { text-align: center; color: #666; font-style: italic; padding: 20px; }

@media(max-width:768px){
  .nav-links { display: none; }
  #hamburgerBtn { display: block; }
  .url-grid { gap: 10px; }
  .url-card { width: 45%; height: 130px; }
  .admin-form { flex-direction: column; }
  .tab-buttons { width: 100%; gap: 5px; padding: 0 10px; }
  .tab-buttons button { padding: 8px 0; font-size: 14px; width: 48%; max-width: none; flex: initial; }
  .calendar-filters { gap: 5px; }
  .calendar-btn { padding: 6px 10px; font-size: 12px; }
}
</style>
</head>
<body>

<div id="customModal" class="custom-modal">
  <div class="custom-modal-content">
    <h3 id="modalTitle">Confirm</h3>
    <p id="modalMsg">Are you sure?</p>
    <div class="modal-actions">
      <button class="modal-btn confirm" id="modalYesBtn">Yes</button>
      <button class="modal-btn cancel" id="modalNoBtn">No</button>
    </div>
  </div>
</div>

<nav class="top-nav">
  <button id="hamburgerBtn" onclick="document.getElementById('mobileMenu').classList.toggle('show')">&#9776;</button>
  <a href="index.html" class="nav-brand">Mount Aetheria</a>
  <div class="nav-links">
    <a href="story.html">Story</a>
    <a href="tools.html" class="active" style="color:var(--accent)">Tools</a>
    <a href="characters.html">Sheet</a>
    <a href="discussions.html">Discussion</a>
    <a href="signin.html" id="authLink">Sign In</a>
  </div>
</nav>

<div id="mobileMenu">
  <a href="story.html">Story</a>
  <a href="tools.html" style="color:var(--accent)">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html">Discussion</a>
  <a href="signin.html" id="mobileAuthLink">Sign In</a>
</div>

<h1>Tools</h1>

<div class="tab-buttons">
  <button class="tab-btn active" data-tab="links">URL Links</button>
  <button class="tab-btn" data-tab="calendar">Calendar</button>
</div>

<div class="tab-content active" id="links">
  <div class="url-grid">
    <a href="https://www.d20pfsrd.com/" target="_blank" class="url-card">
      <img src="Tools/Links/Pathfinder.png" alt="Pathfinder" onerror="this.src='https://via.placeholder.com/100x60?text=PF'"> Pathfinder
    </a>
    <a href="https://www.finalfantasyd20.com/" target="_blank" class="url-card">
      <img src="Tools/Links/FFD20.png" alt="FFD20" onerror="this.src='https://via.placeholder.com/100x60?text=FFD20'"> FFD20
    </a>
    <a href="https://www.owlbear.rodeo/" target="_blank" class="url-card">
      <img src="Tools/Links/Owlbear.png" alt="Owlbear" onerror="this.src='https://via.placeholder.com/100x60?text=Owl'"> Owlbear
    </a>
    <a href="https://reactive.fugi.tech/" target="_blank" class="url-card">
      <img src="Tools/Links/Reactive.png" alt="Reactive" onerror="this.src='https://via.placeholder.com/100x60?text=React'"> Reactive
    </a>
  </div>
</div>

<div class="tab-content" id="calendar">
  <div class="calendar">
    
    <div id="adminPanel">
      <h3><i class="fa-solid fa-hammer"></i> Calendar Admin</h3>
      <div class="admin-form">
        <input type="hidden" id="editingEventId">
        <select id="newEvGroup">
          <option value="groupA">Dark Grasp</option>
          <option value="groupB">Ra'en Legacy</option>
          <option value="groupC">Scourgefall</option>
          <option value="groupD">Unknown</option>
          <option value="groupE">???</option>
        </select>
        <input type="text" id="newEvDate" placeholder="Date (e.g. Dec 25)">
        <input type="text" id="newEvDesc" placeholder="Description...">
        <button id="addEvBtn">Add Event</button>
        <button id="cancelEditBtn" style="display:none; background:#444; color:#fff;">Cancel</button>
      </div>
    </div>

    <h2>Upcoming Events</h2>
    
    <div class="calendar-filters">
      <button class="calendar-btn active" data-group="groupA">Dark Grasp</button>
      <button class="calendar-btn" data-group="groupB">Ra'en Legacy</button>
      <button class="calendar-btn" data-group="groupC">Scourgefall</button>
      <button class="calendar-btn" data-group="groupD">Unknown</button>
      <button class="calendar-btn" data-group="groupE">???</button>
    </div>

    <div id="eventsContainer">
      <div class="event-list active" id="groupA"></div>
      <div class="event-list" id="groupB"></div>
      <div class="event-list" id="groupC"></div>
      <div class="event-list" id="groupD"></div>
      <div class="event-list" id="groupE"></div>
    </div>
    
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw",authDomain:"mount-aetheria.firebaseapp.com",projectId:"mount-aetheria",storageBucket:"mount-aetheria.firebasestorage.app",messagingSenderId:"492855693446",appId:"1:492855693446:web:f9948569254a7220c38107",measurementId:"G-0PF84KDN7L"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let isAdmin = false;

// Custom Modal Logic
const modal = document.getElementById('customModal');
const modalTitle = document.getElementById('modalTitle');
const modalMsg = document.getElementById('modalMsg');
const modalYes = document.getElementById('modalYesBtn');
const modalNo = document.getElementById('modalNoBtn');

function showConfirm(title, msg, onYes) {
    modalTitle.textContent = title;
    modalMsg.textContent = msg;
    modal.style.display = 'flex';
    modalYes.onclick = () => { modal.style.display = 'none'; onYes(); };
    modalNo.onclick = () => { modal.style.display = 'none'; };
}

function showAlert(title, msg) {
    modalTitle.textContent = title;
    modalMsg.textContent = msg;
    modalYes.style.display = 'none';
    modalNo.textContent = 'OK';
    modalNo.style.width = '100%';
    modal.style.display = 'flex';
    modalNo.onclick = () => { modal.style.display = 'none'; modalYes.style.display = ''; modalNo.textContent='No'; modalNo.style.width = ''; };
}

// AUTH CHECK
onAuthStateChanged(auth, user => {
  const link = document.getElementById('authLink');
  const mLink = document.getElementById('mobileAuthLink');
  
  if(user){
     const txt = "My Account"; const href = "account.html";
     link.textContent = txt; link.href = href;
     mLink.textContent = txt; mLink.href = href;
     
     if(user.email === "phoeaung2076@gmail.com") {
        isAdmin = true;
        document.getElementById('adminPanel').style.display = 'block';
     }
  } else {
     const txt = "Sign In"; const href = "signin.html";
     link.textContent = txt; link.href = href;
     mLink.textContent = txt; mLink.href = href;
     isAdmin = false;
     document.getElementById('adminPanel').style.display = 'none';
  }
  loadEvents(); 
});

// LOAD EVENTS
async function loadEvents(){
  const q = query(collection(db, "events"), orderBy("date")); 
  const snap = await getDocs(q);
  
  ['groupA','groupB','groupC','groupD','groupE'].forEach(id => {
      document.getElementById(id).innerHTML = '';
  });

  let hasEvents = { groupA:false, groupB:false, groupC:false, groupD:false, groupE:false };

  snap.forEach(d => {
    const data = d.data();
    const list = document.getElementById(data.group);
    if(list){
      hasEvents[data.group] = true;
      const el = document.createElement('div');
      el.className = 'event-item';
      
      let adminControls = '';
      if(isAdmin){
          // Embed data into button attributes to avoid closure issues
          adminControls = `
            <div class="event-actions">
                <button class="event-btn-icon btn-edit" 
                    data-id="${d.id}" data-group="${data.group}" data-date="${data.date}" data-desc="${data.desc}">
                    <i class="fa-solid fa-pen"></i>
                </button>
                <button class="event-btn-icon btn-del" data-id="${d.id}">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
          `;
      }

      el.innerHTML = `
        <div style="display:flex; align-items:center; flex:1;">
            <span class="date">${data.date}</span>
            <span class="desc">${data.desc}</span>
        </div>
        ${adminControls}
      `;
      list.appendChild(el);
    }
  });

  for(const [gid, has] of Object.entries(hasEvents)){
      if(!has) {
          document.getElementById(gid).innerHTML = '<div class="empty-msg">No upcoming events listed.</div>';
      }
  }

  if(isAdmin){
      // Attach Delete Listeners
      document.querySelectorAll('.btn-del').forEach(btn => {
          btn.addEventListener('click', () => {
              showConfirm("Delete Event", "Are you sure you want to remove this event?", async () => {
                  await deleteDoc(doc(db, "events", btn.dataset.id));
                  loadEvents();
              });
          });
      });
      // Attach Edit Listeners
      document.querySelectorAll('.btn-edit').forEach(btn => {
          btn.addEventListener('click', () => {
              document.getElementById('editingEventId').value = btn.dataset.id;
              document.getElementById('newEvGroup').value = btn.dataset.group;
              document.getElementById('newEvDate').value = btn.dataset.date;
              document.getElementById('newEvDesc').value = btn.dataset.desc;
              document.getElementById('addEvBtn').textContent = "Update Event";
              document.getElementById('cancelEditBtn').style.display = "inline-block";
              window.scrollTo(0,0);
          });
      });
  }
}

document.getElementById('cancelEditBtn').addEventListener('click', () => {
    resetForm();
});

function resetForm() {
    document.getElementById('editingEventId').value = '';
    document.getElementById('newEvDate').value = '';
    document.getElementById('newEvDesc').value = '';
    document.getElementById('addEvBtn').textContent = "Add Event";
    document.getElementById('cancelEditBtn').style.display = "none";
}

// ADD / UPDATE EVENT
document.getElementById('addEvBtn').addEventListener('click', async () => {
    const id = document.getElementById('editingEventId').value;
    const group = document.getElementById('newEvGroup').value;
    const date = document.getElementById('newEvDate').value;
    const desc = document.getElementById('newEvDesc').value;

    if(!date || !desc) return showAlert("Missing Info", "Please fill in date and description");

    if(id) {
        // Update
        await updateDoc(doc(db, "events", id), { group, date, desc });
    } else {
        // Add
        await addDoc(collection(db, "events"), {
            group, date, desc,
            createdAt: new Date()
        });
    }
    
    resetForm();
    loadEvents();
});

// TABS Logic
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabContents.forEach(c => c.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
    });
});

// CALENDAR FILTER Logic
const calButtons = document.querySelectorAll('.calendar-btn');
const eventLists = document.querySelectorAll('.event-list');
calButtons.forEach(b => {
    b.addEventListener('click', () => {
        calButtons.forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        eventLists.forEach(l => l.classList.remove('active'));
        document.getElementById(b.dataset.group).classList.add('active');
    });
});
</script>
</body>
</html>