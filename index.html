<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Mount Aetheria - World Map</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1a1a1a">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Mount Aetheria">
<link rel="apple-touch-icon" href="/icons/icon-192.png">


<style>
:root{
  --bg: #1a1a1a;
  --panel: #252525;
  --border: #333;
  --accent: #ffcc66;
  --text: #ddd;
  --pin-kingdom: #e74c3c;
  --pin-town: #3498db;
  --pin-landmark: #2ecc71;
  --pin-event: #f1c40f;
  --pin-npc: #9b59b6;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Arial,sans-serif;} 
body{padding-top:60px; display:flex; flex-direction:column;}

/* --- NAV --- */
.top-nav {
  position:fixed; top:0; left:0; right:0; height:50px;
  background:#000; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 15px; z-index:2000;
}
.nav-brand { font-family:'Uncial Antiqua'; color:var(--accent); font-size:18px; text-decoration:none; }
.nav-links { display:flex; gap:20px; }
.nav-links a { color:#888; text-decoration:none; font-size:14px; font-weight:bold; }
.nav-links a:hover { color:#fff; }
#hamburgerBtn { display:none; background:none; border:none; color:#fff; font-size:24px; cursor:pointer; }
#mobileMenu {
  display:none; position:fixed; top:50px; left:0; width:100%; background:#111;
  border-bottom:1px solid var(--accent); flex-direction:column; z-index:1999;
}
#mobileMenu.show { display:flex; }
#mobileMenu a { padding:15px 20px; color:#fff; text-decoration:none; border-bottom:1px solid #333; font-family:'Uncial Antiqua'; }

/* --- PAGE HEADER --- */
.page-header {
  padding: 10px;
  text-align: center;
}
.map-tabs {
  display:flex; gap:5px; justify-content:center; flex-wrap:wrap; margin-bottom: 10px;
  
}
.map-tab {
  padding: 8px 16px; background:var(--panel); color:#888; border:1px solid var(--border);
  cursor:pointer; font-weight:bold; transition:0.2s; font-size:0.9em;
}
.map-tab:hover, .map-tab.active {
  background:var(--accent); color:#000; border-color:var(--accent);
}
.map-tabs-mobile-btn { display:none; width:100%; padding:10px; margin-bottom:10px; background:var(--panel); color:var(--accent); border:1px solid var(--border); cursor:pointer; font-family:'Uncial Antiqua'; }

/* --- MAIN LAYOUT --- */
.main-layout {
  display: flex;
  flex: 1;
  width: 100%;
  max-width: 1600px;
  margin: 0 auto;
  padding: 10px 20px;
  gap: 20px;
  height: calc(100vh - 160px); 
  min-height: 500px;
  position: relative;
  justify-content: space-between;
}

/* --- MAP WRAPPER (Holds Viewport + Legend) --- */
.map-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
  min-width: 0;
}

/* --- MAP VIEWPORT --- */
.map-viewport {
  flex: 1; 
  position: relative;
  border: 2px solid var(--accent);
  background: #0d0d0d;
  overflow: hidden; 
  cursor: grab;
  touch-action: none;
  border-radius: 4px;
  box-shadow: 0 0 15px rgba(0,0,0,0.5);
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.map-viewport:active { cursor: grabbing; }

.map-content {
  position: absolute; top: 0; left: 0; transform-origin: 0 0; will-change: transform;
}
.map-img { display: block; pointer-events: none; user-select: none; }

/* --- LEGEND (PC) --- */
.legend {
  position: absolute; bottom: 0; left: 0; right: 0; 
  height: 40px;
  background: rgba(20,20,20,0.9); border-top: 1px solid var(--accent);
  display: flex; align-items: center; justify-content: center; gap: 20px; 
  z-index: 90;
}
.legend-item { display:flex; align-items:center; gap:6px; font-size:0.8em; color:#ccc; }

/* --- SIDEBAR INFO PANEL (PC) --- */
.info-sidebar {
  width: 350px;
  background: var(--panel);
  border: 1px solid var(--border);
  display: flex; 
  flex-direction: column;
  overflow-y: auto;
  padding: 20px;
  border-radius: 4px;
  box-shadow: -5px 0 15px rgba(0,0,0,0.3);
  margin-left: auto;
  flex-shrink: 0; 
}

.info-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px; }
.info-title { font-family:'Uncial Antiqua'; color:var(--accent); margin:0; font-size:1.6em; }
.close-info { display: none; background:none; border:none; color:#888; cursor:pointer; font-size:1.2em; }
.info-img { width:100%; height:200px; object-fit:cover; background:#333; margin-bottom:15px; border:1px solid #444; border-radius:4px; display:none; }
.info-desc { font-size:0.95em; color:#ccc; line-height:1.5; }
.info-empty-state { text-align: center; color: #666; margin-top: 50px; font-style: italic; }

/* --- PINS --- */
.pin {
  position: absolute;
  width: 30px; height: 30px;
  transform: translate(-50%, -100%); 
  transform-origin: bottom center;
  cursor: pointer;
  color: #fff;
  font-size: 24px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.9);
  z-index: 10;
  display:flex; justify-content:center; align-items:center;
}
.pin:hover { z-index:20; color:var(--accent); }
.pin.dragging { opacity: 0.7; cursor: grabbing; }
.pin[data-type="kingdom"] { color: var(--pin-kingdom); }
.pin[data-type="town"] { color: var(--pin-town); }
.pin[data-type="landmark"] { color: var(--pin-landmark); }
.pin[data-type="event"] { color: var(--pin-event); }
.pin[data-type="npc"] { color: var(--pin-npc); }

/* --- ADMIN --- */
#adminBar {
  display:none; align-items:center; justify-content:center; gap:15px;
  background:#2a1a1a; border:1px solid #633; color:#eaa; padding:8px; margin-bottom:10px; font-size:0.85em;
}
.edit-form { display:none; flex-direction:column; gap:8px; margin-top:20px; border-top:1px solid #444; padding-top:15px; }
.edit-form input, .edit-form textarea, .edit-form select { background:#111; border:1px solid #444; color:#fff; padding:8px; }
.btn { padding:8px; cursor:pointer; border:none; font-weight:bold; margin-top:5px; border-radius:3px; }
.btn-save { background:var(--accent); color:#000; }
.btn-del { background:#a33; color:#fff; }

/* --- ZOOM CONTROLS --- */
.zoom-controls {
  position: absolute; bottom: 50px; right: 20px;
  display: flex; flex-direction: column; gap: 5px; z-index: 100;
}
.zoom-btn {
  width: 36px; height: 36px; background: rgba(0,0,0,0.8); border: 1px solid var(--border);
  color: #fff; font-size: 16px; cursor: pointer; border-radius: 4px;
}
.zoom-btn:hover { background: var(--accent); color: #000; }

/* --- MOBILE RESPONSIVE --- */
@media(max-width: 768px) {
  .nav-links{display:none} #hamburgerBtn{display:block}
  
  .page-header { padding: 5px; }
  .map-tabs { display:none; flex-direction:column; position:absolute; top:100%; left:0; right:0; z-index:50; }
  .map-tabs.show { display:flex; background:#111; border-bottom: 1px solid var(--accent);}
  .map-tabs-mobile-btn { display:block; }

  .main-layout {
    flex-direction: column;
    height: auto; 
    padding: 10px;
    gap: 15px;
    display: block; 
  }
  
  .map-wrapper {
    width: 100%;
    margin-bottom: 20px;
    display: block;
  }

  .map-viewport {
    height: 50vh; 
    min-height: 400px;
    width: 100%;
    border-radius: 4px;
  }
  
  .zoom-controls { bottom: 20px; right: 10px; }

  .legend {
    position: relative;
    top: auto; bottom: auto; left: auto; right: auto;
    background: #111;
    border: 1px solid #333;
    border-radius: 4px;
    margin-top: 10px;
    height: auto;
    padding: 10px;
    flex-wrap: wrap; 
    justify-content: center;
    gap: 10px 15px;
  }
  .legend-item {
    background: #222; border: 1px solid #333;
    padding: 4px 8px; border-radius: 4px;
  }

  .info-sidebar {
    display: none; 
    position: fixed; top: 0; bottom: 0; left: 0; right: 0;
    width: 100%; height: 100%;
    z-index: 3000;
    margin: 0; border: none;
    padding-top: 60px; 
  }
  .info-sidebar.active { display: flex; }
  .close-info { display: block; } 
  .info-empty-state { display: none; }
}
</style>
</head>
<body>

<nav class="top-nav">
  <button id="hamburgerBtn" aria-label="menu"><i class="fa-solid fa-bars"></i></button>
  <a href="index.html" class="nav-brand">Mount Aetheria</a>
  <div class="nav-links">
    <a href="story.html">Story</a>
    <a href="tools.html">Tools</a>
    <a href="characters.html">Sheet</a>
    <a href="map.html" class="active">Map</a>
    <a href="signin.html" id="authLink">Sign In</a>
  </div>
</nav>

<div id="mobileMenu" aria-hidden="true">
  <a href="story.html">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Sheet</a>
  <a href="map.html">Map</a>
  <a href="signin.html" id="mobileAuthLink">Sign In</a>
</div>

<div class="page-header">
  <div id="adminBar">
    <span><i class="fa-solid fa-hammer"></i> <b>Admin Mode</b></span>
    <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
      <input type="checkbox" id="adminToggle"> Enable Edit
    </label>
    <span style="color:#888;">(DblClick Map to Add)</span>
  </div>

  <div style="max-width:1100px; margin:0 auto; position:relative;">
    <button class="map-tabs-mobile-btn" id="mapMenuBtn">
      <i class="fa-solid fa-map"></i> Change Map <i class="fa-solid fa-caret-down"></i>
    </button>
    <div class="map-tabs" id="mapTabs">
      <div class="map-tab active" data-map="world">World Map</div>
      <div class="map-tab" data-map="darkgrasp">Dark Grasp</div>
      <div class="map-tab" data-map="raen">Ra'en Legacy</div>
      <div class="map-tab" data-map="scourge">Scourgefall</div>
      <div class="map-tab" data-map="unknown">Unknown</div>
      <div class="map-tab" data-map="secret">???</div>
    </div>
  </div>
</div>

<div class="main-layout">
  
  <div class="map-wrapper">
    <div class="map-viewport" id="viewport">
      <div class="map-content" id="mapContent">
        <img src="map.jpg" alt="Map" class="map-img" id="mapImage">
        <div id="pinsLayer"></div>
      </div>

      <div class="zoom-controls">
        <button class="zoom-btn" id="zoomInBtn"><i class="fa-solid fa-plus"></i></button>
        <button class="zoom-btn" id="zoomOutBtn"><i class="fa-solid fa-minus"></i></button>
        <button class="zoom-btn" id="resetViewBtn"><i class="fa-solid fa-compress"></i></button>
      </div>
    </div>
    
    <div class="legend">
      <div class="legend-item"><i class="fa-solid fa-chess-rook" style="color:var(--pin-kingdom)"></i> Kingdom</div>
      <div class="legend-item"><i class="fa-solid fa-house" style="color:var(--pin-town)"></i> Town</div>
      <div class="legend-item"><i class="fa-solid fa-mountain" style="color:var(--pin-landmark)"></i> Landmark</div>
      <div class="legend-item"><i class="fa-solid fa-scroll" style="color:var(--pin-event)"></i> Event</div>
      <div class="legend-item"><i class="fa-solid fa-user" style="color:var(--pin-npc)"></i> NPC</div>
    </div>
  </div>

  <aside class="info-sidebar" id="infoPanel">
    <div class="info-header">
      <h2 class="info-title" id="infoTitle">Information</h2>
      <button class="close-info" id="closeInfoBtn"><i class="fa-solid fa-xmark"></i></button>
    </div>
    
    <div class="info-empty-state" id="emptyState">
      <i class="fa-solid fa-location-dot" style="font-size:3em; margin-bottom:15px; opacity:0.5;"></i><br>
      Select a pin on the map<br>to view details.
    </div>

    <div id="infoContent" style="display:none;">
      <img src="" class="info-img" id="infoImg">
      <div class="info-desc" id="infoDesc"></div>
    </div>

    <div class="edit-form" id="adminEditForm">
      <strong>Edit Pin Details</strong>
      <input type="text" id="editName" placeholder="Name">
      <select id="editType">
        <option value="kingdom">Kingdom</option>
        <option value="town">Town</option>
        <option value="landmark">Landmark</option>
        <option value="event">Event</option>
        <option value="npc">NPC</option>
      </select>
      <textarea id="editDesc" rows="5" placeholder="Description..."></textarea>
      <input type="text" id="editImg" placeholder="Image URL">
      <button class="btn btn-save" id="savePinBtn">Save Changes</button>
      <button class="btn btn-del" id="delPinBtn">Delete Pin</button>
    </div>
  </aside>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw",
  authDomain: "mount-aetheria.firebaseapp.com",
  projectId: "mount-aetheria",
  storageBucket: "mount-aetheria.firebasestorage.app",
  messagingSenderId: "492855693446",
  appId: "1:492855693446:web:f9948569254a7220c38107",
  measurementId: "G-0PF84KDN7L"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// State
let currentUser = null;
let isAdmin = false;
let adminMode = false;
let currentMap = "world";
let pinsData = [];

// Zoom/Pan Variables
let scale = 1; 
let pointX = 0;
let pointY = 0;
let isPanning = false;
let startX = 0, startY = 0;
let isDraggingPin = false;

// DOM
const viewport = document.getElementById('viewport');
const mapContent = document.getElementById('mapContent');
const mapImage = document.getElementById('mapImage');
const pinsLayer = document.getElementById('pinsLayer');
const infoPanel = document.getElementById('infoPanel');
const emptyState = document.getElementById('emptyState');
const infoContent = document.getElementById('infoContent');

/* 1. AUTH & ADMIN */
onAuthStateChanged(auth, user => {
  currentUser = user;
  const link = document.getElementById('authLink');
  const mLink = document.getElementById('mobileAuthLink');
  
  if(user){
    link.textContent = "Account"; link.href = "account.html";
    mLink.textContent = "Account"; mLink.href = "account.html";
    if(user.email === "phoeaung2076@gmail.com"){
      isAdmin = true;
      document.getElementById('adminBar').style.display = "flex";
    }
  } else {
    link.textContent = "Sign In"; link.href = "signin.html";
    mLink.textContent = "Sign In"; mLink.href = "signin.html";
    isAdmin = false;
    document.getElementById('adminBar').style.display = "none";
  }
});

document.getElementById('adminToggle').addEventListener('change', (e) => {
  adminMode = e.target.checked;
  document.querySelectorAll('.pin').forEach(p => p.style.cursor = adminMode ? 'grab' : 'pointer');
  if(adminMode && window.innerWidth < 768) infoPanel.classList.remove('active');
});

/* 2. MAP TABS */
const tabs = document.querySelectorAll('.map-tab');
tabs.forEach(t => {
  t.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    currentMap = t.dataset.map;
    document.getElementById('mapTabs').classList.remove('show');
    loadPins(); 
    resetView();
  });
});
document.getElementById('mapMenuBtn').addEventListener('click', () => {
  document.getElementById('mapTabs').classList.toggle('show');
});

/* 3. ZOOM LOGIC & VIEW RESET */

function getMinScale() {
  const vpRect = viewport.getBoundingClientRect();
  const imgW = mapImage.naturalWidth || 2000;
  const imgH = mapImage.naturalHeight || 1500;
  
  // Calculate Min scale to fit perfectly
  const scaleX = vpRect.width / imgW;
  const scaleY = vpRect.height / imgH;
  return Math.max(scaleX, scaleY);
}

function clampPosition() {
  const vpRect = viewport.getBoundingClientRect();
  const imgW = mapImage.naturalWidth * scale;
  const imgH = mapImage.naturalHeight * scale;

  if (imgW < vpRect.width) {
    pointX = (vpRect.width - imgW) / 2;
  } else {
    if (pointX > 0) pointX = 0;
    if (pointX < vpRect.width - imgW) pointX = vpRect.width - imgW;
  }

  if (imgH < vpRect.height) {
    pointY = (vpRect.height - imgH) / 2;
  } else {
    if (pointY > 0) pointY = 0;
    if (pointY < vpRect.height - imgH) pointY = vpRect.height - imgH;
  }
}

function updateTransform() {
  // Ensure we don't go below min scale here just in case, but primary logic is in handlers now
  const minScale = getMinScale();
  if (scale < minScale) scale = minScale; 
  if (scale > 5) scale = 5;

  clampPosition();

  mapContent.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
  
  const pinScale = 1 / scale;
  document.querySelectorAll('.pin').forEach(p => {
    p.style.transform = `translate(-50%, -100%) scale(${pinScale})`;
  });
}

function resetView() {
  if(!mapImage.complete || mapImage.naturalWidth === 0) {
    requestAnimationFrame(resetView);
    return;
  }
  scale = getMinScale();
  
  const vpRect = viewport.getBoundingClientRect();
  const imgW = mapImage.naturalWidth * scale;
  const imgH = mapImage.naturalHeight * scale;
  pointX = (vpRect.width - imgW) / 2;
  pointY = (vpRect.height - imgH) / 2;
  
  updateTransform();
}

window.addEventListener('resize', () => { updateTransform(); });
mapImage.onload = resetView;
if(mapImage.complete) resetView();

/* CONTROLS */
viewport.addEventListener('mousedown', (e) => {
  if(e.target.closest('.pin')) return;
  isPanning = true;
  startX = e.clientX - pointX;
  startY = e.clientY - pointY;
  viewport.style.cursor = 'grabbing';
});

window.addEventListener('mousemove', (e) => {
  if(!isPanning) return;
  e.preventDefault();
  pointX = e.clientX - startX;
  pointY = e.clientY - startY;
  updateTransform();
});

window.addEventListener('mouseup', () => {
  isPanning = false;
  viewport.style.cursor = 'grab';
});

viewport.addEventListener('wheel', (e) => {
  e.preventDefault();
  const rect = viewport.getBoundingClientRect();
  
  // 1. Calculate the 'target' zoom level
  let newScale = scale;
  const delta = -e.deltaY;
  (delta > 0) ? (newScale *= 1.1) : (newScale /= 1.1);

  // 2. Clamp the new scale BEFORE calculating position
  const minScale = getMinScale();
  if (newScale < minScale) newScale = minScale;
  if (newScale > 5) newScale = 5;

  // 3. Calculate position based on the CLAMPED scale
  // The cursor position relative to the image (0-1 range) remains constant
  const xs = (e.clientX - rect.left - pointX) / scale;
  const ys = (e.clientY - rect.top - pointY) / scale;

  pointX = (e.clientX - rect.left) - xs * newScale;
  pointY = (e.clientY - rect.top) - ys * newScale;
  
  scale = newScale;
  updateTransform();
}, {passive: false});

// --- TOUCH ZOOM FIX ---
let lastScale = 1;
let initialDist = 0;

viewport.addEventListener('touchstart', (e) => {
  if(e.touches.length === 1) {
    if(e.target.closest('.pin')) return;
    isPanning = true;
    startX = e.touches[0].clientX - pointX;
    startY = e.touches[0].clientY - pointY;
  } else if (e.touches.length === 2) {
    isPanning = false;
    initialDist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    lastScale = scale;
  }
}, {passive: false});

viewport.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if(isDraggingPin) return;
  
  // Single finger panning
  if(e.touches.length === 1 && isPanning) {
    pointX = e.touches[0].clientX - startX;
    pointY = e.touches[0].clientY - startY;
    updateTransform();
    
  // Two finger zooming
  } else if (e.touches.length === 2) {
    const dist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    
    // 1. Calculate proposed scale
    let newScale = lastScale * (dist / initialDist);
    
    // 2. Clamp proposed scale BEFORE position calc
    const minScale = getMinScale();
    if (newScale < minScale) newScale = minScale;
    if (newScale > 5) newScale = 5;

    // 3. Calculate position centered on pinch
    const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
    const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    const rect = viewport.getBoundingClientRect();
    const vcx = cx - rect.left;
    const vcy = cy - rect.top;

    // Use ratio of change from CURRENT scale to NEW clamped scale
    const factor = newScale / scale;

    pointX = vcx - (vcx - pointX) * factor;
    pointY = vcy - (vcy - pointY) * factor;
    
    scale = newScale;
    updateTransform();
  }
}, {passive: false});

viewport.addEventListener('touchend', () => isPanning = false);

document.getElementById('zoomInBtn').onclick = () => { scale *= 1.2; updateTransform(); };
document.getElementById('zoomOutBtn').onclick = () => { scale /= 1.2; updateTransform(); };
document.getElementById('resetViewBtn').onclick = resetView;

/* 4. PIN LOGIC */
function renderPin(data){
  const el = document.createElement('div');
  el.className = 'pin';
  el.dataset.id = data.id;
  el.style.left = data.x + '%';
  el.style.top = data.y + '%';
  el.style.transform = `translate(-50%, -100%) scale(${1/scale})`;
  
  const icons = { kingdom:'fa-chess-rook', town:'fa-house', landmark:'fa-mountain', event:'fa-scroll', npc:'fa-user' };
  el.innerHTML = `<i class="fa-solid ${icons[data.type] || 'fa-map-pin'}"></i>`;
  el.dataset.type = data.type;
  
  el.addEventListener('mousedown', (e) => startPinDrag(e, data.id, el));
  el.addEventListener('touchstart', (e) => startPinDrag(e, data.id, el));
  el.addEventListener('click', (e) => handlePinClick(e, data));
  
  pinsLayer.appendChild(el);
}

async function loadPins(){
  pinsLayer.innerHTML = '';
  const q = query(collection(db, "pins"), where("mapId", "==", currentMap));
  const snap = await getDocs(q);
  pinsData = [];
  snap.forEach(d => {
    const p = d.data(); p.id = d.id;
    pinsData.push(p);
    renderPin(p);
  });
}

function handlePinClick(e, data){
  e.stopPropagation();
  if(adminMode) return; 

  emptyState.style.display = 'none';
  infoContent.style.display = 'block';
  document.getElementById('adminEditForm').style.display='none';

  document.getElementById('infoTitle').textContent = data.name;
  document.getElementById('infoDesc').textContent = data.desc || "No description.";
  const img = document.getElementById('infoImg');
  if(data.img) { img.src = data.img; img.style.display='block'; }
  else img.style.display='none';
  
  if(window.innerWidth < 768) {
    infoPanel.classList.add('active');
  }
}

document.getElementById('closeInfoBtn').onclick = () => {
  infoPanel.classList.remove('active');
};

viewport.addEventListener('dblclick', async (e) => {
  if(!adminMode || !isAdmin) return;
  const rect = mapContent.getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width) * 100;
  const y = ((e.clientY - rect.top) / rect.height) * 100;
  
  try {
    const ref = await addDoc(collection(db, "pins"), {
      mapId: currentMap, x: x.toFixed(2), y: y.toFixed(2), type:'landmark', name:'New', desc:'', img:''
    });
    const newP = { id:ref.id, mapId:currentMap, x:x.toFixed(2), y:y.toFixed(2), type:'landmark', name:'New', desc:'', img:'' };
    renderPin(newP);
    openEdit(newP);
  } catch(e) { alert(e.message); }
});

function startPinDrag(e, id, el){
  if(!adminMode || !isAdmin) return;
  e.stopPropagation(); e.preventDefault();
  isDraggingPin = true;
  
  const isTouch = e.type === 'touchstart';
  let hasMoved = false;

  const move = (ev) => {
    hasMoved = true;
    el.classList.add('dragging');
    let cx, cy;
    if(ev.type === 'touchmove') { cx = ev.touches[0].clientX; cy = ev.touches[0].clientY; }
    else { cx = ev.clientX; cy = ev.clientY; }

    const rect = mapContent.getBoundingClientRect();
    let nx = ((cx - rect.left) / rect.width) * 100;
    let ny = ((cy - rect.top) / rect.height) * 100;
    
    if(nx<0) nx=0; if(nx>100) nx=100;
    if(ny<0) ny=0; if(ny>100) ny=100;

    el.style.left = nx + '%';
    el.style.top = ny + '%';
  };

  const end = async () => {
    isDraggingPin = false;
    el.classList.remove('dragging');
    window.removeEventListener(isTouch?'touchmove':'mousemove', move);
    window.removeEventListener(isTouch?'touchend':'mouseup', end);

    if(!hasMoved) openEdit(pinsData.find(p=>p.id===id));
    else await updateDoc(doc(db, "pins", id), { x: parseFloat(el.style.left).toFixed(2), y: parseFloat(el.style.top).toFixed(2) });
  };

  window.addEventListener(isTouch?'touchmove':'mousemove', move, {passive:false});
  window.addEventListener(isTouch?'touchend':'mouseup', end);
}

function openEdit(data){
  if(window.innerWidth < 768) infoPanel.classList.add('active');
  emptyState.style.display = 'none';
  infoContent.style.display = 'none';
  document.getElementById('adminEditForm').style.display = 'flex';
  
  document.getElementById('infoTitle').textContent = "Edit: " + data.name;
  document.getElementById('editName').value = data.name;
  document.getElementById('editType').value = data.type;
  document.getElementById('editDesc').value = data.desc || "";
  document.getElementById('editImg').value = data.img || "";
  
  const sBtn = document.getElementById('savePinBtn');
  const nS = sBtn.cloneNode(true); sBtn.parentNode.replaceChild(nS, sBtn);
  nS.onclick = async () => {
    await updateDoc(doc(db, "pins", data.id), {
      name: document.getElementById('editName').value,
      type: document.getElementById('editType').value,
      desc: document.getElementById('editDesc').value,
      img: document.getElementById('editImg').value
    });
    if(window.innerWidth < 768) infoPanel.classList.remove('active');
    else {
        document.getElementById('adminEditForm').style.display = 'none';
        emptyState.style.display = 'block';
    }
    loadPins();
  };

  const dBtn = document.getElementById('delPinBtn');
  const nD = dBtn.cloneNode(true); dBtn.parentNode.replaceChild(nD, dBtn);
  nD.onclick = async () => {
    if(confirm("Delete pin?")){
      await deleteDoc(doc(db, "pins", data.id));
      if(window.innerWidth < 768) infoPanel.classList.remove('active');
      else {
          document.getElementById('adminEditForm').style.display = 'none';
          emptyState.style.display = 'block';
      }
      document.querySelector(`.pin[data-id="${data.id}"]`).remove();
    }
  };
}

const hamb = document.getElementById('hamburgerBtn');
const mobileMenu = document.getElementById('mobileMenu');
hamb.addEventListener('click', () => mobileMenu.classList.toggle('show'));

loadPins();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(reg => console.log('Service Worker registered:', reg))
    .catch(err => console.error('Service Worker failed:', err));
}

</script>
</body>
</html>