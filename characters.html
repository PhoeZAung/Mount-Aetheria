<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Character Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
/* --- BASE VARIABLES & THEME --- */
:root { --bg: #1a1a1a; --panel: #252525; --border: #333; --accent: #ffcc66; --text: #ddd; --input-bg: #111; }
body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding-top: 50px; padding-bottom: 50px; }
* { box-sizing: border-box; }

/* --- NAVIGATION --- */
.top-nav { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #000; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 2000; }
.nav-brand { font-family: 'Uncial Antiqua'; color: var(--accent); font-size: 18px; text-decoration: none; }
.nav-links { display: flex; gap: 20px; }
.nav-links a { color: #888; text-decoration: none; font-size: 14px; font-weight: bold; }
.nav-links a:hover, .nav-links a.active { color: #fff; }
#hamburgerBtn { display: none; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; }
#mobileMenu { display: none; position: fixed; top: 50px; left: 0; width: 100%; background: #111; border-bottom: 1px solid var(--accent); flex-direction: column; z-index: 1999; }
#mobileMenu.show { display: flex; }
#mobileMenu a { padding: 15px 20px; color: #fff; text-decoration: none; border-bottom: 1px solid #333; font-family: 'Uncial Antiqua'; }

/* --- MAIN TABS (Sticky) --- */
.main-tabs { display: flex; width: 100%; background: #000; border-bottom: 1px solid var(--accent); position: sticky; top: 50px; z-index: 900; }
.tab-btn { flex: 1; border: none; background: transparent; color: #888; padding: 12px 0; cursor: pointer; font-family: 'Uncial Antiqua'; font-size: 14px; text-align: center; border-bottom: 3px solid transparent; transition: 0.2s; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: #111; }

/* --- CONTENT AREA --- */
.tab-content { display: none; padding: 15px; max-width: 800px; margin: 0 auto; }
.tab-content.active { display: block; animation: fade 0.2s; }
@keyframes fade { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
h2, h3, h4 { color: var(--accent); font-family: 'Uncial Antiqua'; margin-top: 0; text-align: center; }

/* --- FORMS & INPUTS --- */
input, textarea, select { background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; width: 100%; font-size: 14px; }
input:focus, textarea:focus { border-color: var(--accent); outline: none; }
label { color: #aaa; font-size: 12px; font-weight: bold; margin-bottom: 4px; display: block; }

/* --- BIO GRID --- */
.bio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.bio-item { display: flex; flex-direction: column; }

/* --- STATS & COMBAT (Compact) --- */
.combat-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; background: var(--panel); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
.stat-box { display: flex; flex-direction: column; align-items: center; }
.stat-dual { display: flex; align-items: center; gap: 5px; }
.stat-dual input { text-align: center; }

/* --- SUB TABS (Hamburger Style on Mobile) --- */
.sub-nav-container { margin-bottom: 15px; position: relative; }
.sub-nav { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
.sub-btn { background: none; border: 1px solid transparent; color: #888; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 13px; }
.sub-btn.active { background: var(--accent); color: #000; }
.sub-toggle { display: none; width: 100%; background: #333; color: var(--accent); border: none; padding: 10px; font-weight: bold; cursor: pointer; text-align: left; }

/* --- LISTS (Details) --- */
details { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; overflow: hidden; }
summary { padding: 10px; background: #2a2a2a; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; user-select: none; }
summary a { color: var(--accent); text-decoration: none; position: relative; z-index: 50; }
summary a:hover { text-decoration: underline; }
.details-body { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
.item-row { display: flex; gap: 10px; align-items: flex-start; }
.item-img { width: 50px; height: 50px; background: #000; border: 1px solid #444; object-fit: cover; flex-shrink: 0; }

/* --- UPDATED ATTRIBUTE ROW STYLING --- */
.attr-row { display: flex; gap: 5px; margin-top: 5px; align-items: center; }
.attr-row .attr-n { flex: 3; min-width: 0; } /* 30% ratio */
.attr-row .attr-v { flex: 7; min-width: 0; } /* 70% ratio */
.attr-row input { font-size: 12px; padding: 4px; }
.attr-row .btn-del { flex: 0 0 auto; width: auto; }

/* --- NESTED FEAT TABS --- */
.feat-tabs { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid #444; }
.feat-tab { background: #333; border: none; color: #888; padding: 5px 10px; font-size: 12px; cursor: pointer; border-radius: 4px 4px 0 0; }
.feat-tab.active { background: var(--accent); color: #000; }

/* --- SKILLS TABLE --- */
.skills-container { background: var(--panel); border-radius: 8px; overflow: hidden; }
#skillsTable th, #skillsTable td { padding: 8px 5px; border-bottom: 1px solid var(--border); text-align: center; }
#skillsTable th { background: #000; }
#skillsTable td:nth-child(2) { text-align: left; } 
#skillsTable input[type="number"] { max-width: 50px; padding: 4px; text-align: center; }

/* --- MOBILE BREAKPOINTS --- */
@media (max-width: 600px) {
  .nav-links { display: none; }
  #hamburgerBtn { display: block; }
  .tab-btn { font-size: 11px; padding: 10px 2px; }
  .combat-stats { display: flex; flex-direction: column; gap: 8px; }
  .stat-box { flex-direction: row; justify-content: space-between; width: 100%; border-bottom: 1px solid #333; padding-bottom: 4px; }
  .stat-box label { margin: 0; font-size: 14px; }
  .stat-box input, .stat-dual { width: 50%; justify-content: flex-end; }
  .stat-dual input { width: 48%; }
  .sub-nav { display: none; flex-direction: column; background: #222; position: absolute; top: 100%; left: 0; right: 0; z-index: 10; border: 1px solid var(--accent); }
  .sub-nav.show { display: flex; }
  .sub-btn { width: 100%; text-align: left; padding: 12px; border-radius: 0; border-bottom: 1px solid #333; }
  .sub-toggle { display: block; }
  .sub-toggle::after { content: ' â–¼'; float: right; }
  
  #mobileSkillHeader { display: flex !important; justify-content: space-between; padding: 0 10px 5px 10px; }
  #skillsTable { display: block; width: 100%; }
  #skillsTable thead { display: none; } 
  #skillsTable tbody { display: block; }
  #skillsTable tr { display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; margin-bottom: 8px; padding: 10px; border-radius: 6px; background: var(--panel); }
  #skillsTable td { border: none; padding: 0; white-space: nowrap; text-align: left; }
  #skillsTable tr td:nth-child(1), #skillsTable tr td:nth-child(3) { display: none; }
  #skillsTable tr td:nth-child(2) { flex-basis: 45%; font-weight: bold; font-size: 15px; text-overflow: ellipsis; overflow: hidden; }
  #skillsTable tr td:nth-child(4) { display: flex; align-items: center; gap: 5px; padding: 0; flex-basis: 35%; justify-content: flex-end; }
  #skillsTable tr td:nth-child(4) input { max-width: 40px; padding: 2px 4px !important; font-size: 14px; margin-left: 5px; }
  #skillsTable tr td:nth-child(5) { flex-basis: 20%; text-align: right; font-size: 16px; }
}

.btn-add { width: 100%; background: var(--accent); border: none; color: #000; padding: 10px; font-weight: bold; margin-top: 10px; border-radius: 4px; cursor: pointer; }
.btn-del { background: #ff4444; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor:pointer; }
.status-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #000; color: #888; font-size: 11px; padding: 4px 10px; text-align: right; border-top: 1px solid #333; z-index: 2000; display: flex; justify-content: space-between; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; display: inline-block; margin-right: 5px; }
.status-dot.live { background: #4caf50; box-shadow: 0 0 5px #4caf50; }
</style>
</head>
<body>

<nav class="top-nav">
  <button id="hamburgerBtn" onclick="document.getElementById('mobileMenu').classList.toggle('show')">&#9776;</button>
  <a href="index.html" class="nav-brand">Mount Aetheria</a>
  <div class="nav-links">
    <a href="story.html">Story</a>
    <a href="tools.html">Tools</a>
    <a href="characters.html" class="active" style="color:var(--accent)">Sheet</a>
    <a href="discussions.html">Discussion</a>
    <a href="signin.html" id="authLink">Sign In</a>
  </div>
</nav>

<div id="mobileMenu">
  <a href="story.html">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html" style="color:var(--accent)">Character Sheet</a>
  <a href="discussions.html">Discussion</a>
  <a href="signin.html" id="mobileAuthLink">Sign In</a>
</div>

<div class="main-tabs">
  <button class="tab-btn active" onclick="switchTab('character')">Character</button>
  <button class="tab-btn" onclick="switchTab('combat')">Combat</button>
  <button class="tab-btn" onclick="switchTab('skills')">Skills</button>
  <button class="tab-btn" onclick="switchTab('items')">Items</button>
  <button class="tab-btn" onclick="switchTab('notes')">Notes</button>
</div>

<div id="character" class="tab-content active">
  <div class="bio-grid">
    <div class="bio-item"><label>Name</label><input id="charName" class="live-field"></div>
    <div class="bio-item"><label>Race</label><input id="race" class="live-field"></div>
    <div class="bio-item"><label>Class</label><input id="class" class="live-field"></div>
    <div class="bio-item"><label>Align</label><input id="alignment" class="live-field"></div>
    <div class="bio-item"><label>Size</label><input id="size" class="live-field"></div>
    <div class="bio-item"><label>Langs</label><input id="languages" class="live-field"></div>
  </div>
  <h3>Ability Scores</h3>
  <div style="background:var(--panel); border-radius:8px; overflow:hidden;">
    <table style="width:100%; border-collapse:collapse; text-align:center;">
        <tr style="background:#000; color:#888; font-size:12px;"><th>Stat</th><th>Score</th><th>Mod</th></tr>
        <script>
            ['str','dex','con','int','wis','cha'].forEach(s => {
                document.write(`<tr style="border-top:1px solid #333;"><td style="font-weight:bold; color:var(--accent); text-transform:uppercase;">${s}</td><td style="padding:8px;"><input type="number" id="${s}" class="live-field calc-trigger" style="text-align:center; background:#111; border:1px solid #444; color:#fff; border-radius:4px;"></td><td id="mod-${s}">+0</td></tr>`);
            });
        </script>
    </table>
  </div>
</div>

<div id="combat" class="tab-content">
  <div class="combat-stats">
    <div class="stat-box"><label>HP (Cur/Max)</label><div class="stat-dual"><input id="hp_curr" class="live-field" placeholder="Curr"><span style="color:#666">/</span><input id="hp_max" class="live-field" placeholder="Max"></div></div>
    <div class="stat-box"><label>MP (Cur/Max)</label><div class="stat-dual"><input id="mp_curr" class="live-field" placeholder="Curr"><span style="color:#666">/</span><input id="mp_max" class="live-field" placeholder="Max"></div></div>
    <div class="stat-box"><label>Speed</label><input id="speed" class="live-field"></div>
    <div class="stat-box"><label>Init Mod</label><input id="init_bonus" class="live-field"></div>
    <div class="stat-box"><label>AC Total</label><input id="ac_total" class="live-field"></div>
  </div>
  <div class="sub-nav-container">
    <button class="sub-toggle" onclick="toggleSubMenu()">Combat Sections</button>
    <div class="sub-nav" id="subNav">
        <button class="sub-btn active" onclick="switchSub('offense')">Offense</button>
        <button class="sub-btn" onclick="switchSub('defense')">Defense</button>
        <button class="sub-btn" onclick="switchSub('spells')">Spells</button>
        <button class="sub-btn" onclick="switchSub('feats')">Feats/Abils</button>
    </div>
  </div>
  
  <div id="offense" class="sub-group active">
    <div class="combat-stats" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="stat-box"><label>BAB</label><input id="bab" class="live-field"></div>
        <div class="stat-box"><label>Touch</label><input id="atk_touch" class="live-field"></div>
        <div class="stat-box"><label>Ranged Touch</label><input id="atk_rtouch" class="live-field"></div>
    </div>
    <h3>Weapons</h3><div id="weaponList"></div><button class="btn-add" onclick="addWeapon()">+ Add Weapon</button>
  </div>

  <div id="defense" class="sub-group" style="display:none">
    <div class="combat-stats">
        <div class="stat-box"><label>Touch AC</label><input id="ac_touch" class="live-field"></div>
        <div class="stat-box"><label>Flat-Foot</label><input id="ac_flat" class="live-field"></div>
        <div class="stat-box"><label>CMD</label><input id="cmd_total" class="live-field"></div>
        <div class="stat-box"><label>DR</label><input id="dr_val" class="live-field"></div>
        <div class="stat-box"><label>SR</label><input id="sr_val" class="live-field"></div>
    </div>
    <h3>Saves</h3>
    <div class="combat-stats"><div class="stat-box"><label>Fortitude</label><div class="stat-dual"><input id="fort_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="fort_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div><div class="stat-box"><label>Reflex</label><div class="stat-dual"><input id="ref_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="ref_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div><div class="stat-box"><label>Will</label><div class="stat-dual"><input id="will_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="will_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div></div>
  </div>

  <div id="spells" class="sub-group" style="display:none">
      <div class="stat-box" style="margin-bottom:10px;"><label>Spell DC Base</label><input id="spell_dc_base" class="live-field"></div>
      <div id="spellList"></div>
      <button class="btn-add" onclick="addSpell()">+ Add Spell</button>
  </div>

  <div id="feats" class="sub-group" style="display:none">
      <div class="feat-tabs">
          <button class="feat-tab active" onclick="switchFeatTab('f-active')">Active</button>
          <button class="feat-tab" onclick="switchFeatTab('f-passive')">Passive</button>
          <button class="feat-tab" onclick="switchFeatTab('f-feats')">Feats</button>
      </div>

      <div id="f-active" class="feat-content active">
          <h3>Active Abilities</h3>
          <div id="activeList"></div>
          <button class="btn-add" onclick="addActive()">+ Add Active</button>
      </div>

      <div id="f-passive" class="feat-content" style="display:none">
          <h3>Passive Abilities</h3>
          <div id="passiveList"></div>
          <button class="btn-add" onclick="addPassive()">+ Add Passive</button>
      </div>

      <div id="f-feats" class="feat-content" style="display:none">
          <h3>Feats</h3>
          <div id="featList"></div>
          <button class="btn-add" onclick="addFeat()">+ Add Feat</button>
          <br><br>
          <label>Proficiencies</label>
          <textarea id="proficiencies" class="live-field" style="height:80px"></textarea>
      </div>
  </div>
</div>

<div id="skills" class="tab-content">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><span>Skill Points Unused:</span><input id="skill_points" class="live-field" style="width:60px; text-align:center;"></div>
  <div id="mobileSkillHeader" style="display:none; color:#888; font-size:12px;"><span style="display:inline-block; width:45%;"></span><span style="display:inline-block; width:35%; text-align:right; padding-right: 5px;">RANKS</span><span style="display:inline-block; width:20%; text-align:right;">TOTAL</span></div>
  <div class="skills-container">
    <table id="skillsTable" style="width:100%; border-collapse:collapse; font-size:14px; text-align:center;">
        <thead><tr style="background:#000; color:var(--accent); font-weight:bold;"><th style="width:30px">CS</th><th style="text-align:left;">Skill Name</th><th style="width:40px">Mod</th><th style="width:50px">Ranks</th><th style="width:40px" id="skillHeaderTotal">Total</th></tr></thead>
        <tbody id="skillsTableBody"></tbody>
    </table>
  </div>
</div>

<div id="items" class="tab-content"><div class="combat-stats" style="grid-template-columns: 1fr 1fr;"><div class="stat-box"><label>ðŸ’° Gil</label><input id="currency_gil" class="live-field"></div><div class="stat-box"><label>Moogle Pts</label><input id="currency_moogle" class="live-field"></div></div><div id="itemList"></div><button class="btn-add" onclick="addItem()">+ Add Item</button></div>
<div id="notes" class="tab-content"><textarea id="notesArea" class="live-field" style="height:400px; font-family:sans-serif; line-height:1.5;"></textarea></div>
<div class="status-bar"><span id="uidDisplay">Loading...</span><div><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting</span></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw", authDomain: "mount-aetheria.firebaseapp.com", projectId: "mount-aetheria", storageBucket: "mount-aetheria.firebasestorage.app", messagingSenderId: "492855693446", appId: "1:492855693446:web:f99485569254a7220c38107", measurementId: "G-0PF84KDN7L" };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let saveTimeout = null;
let isRemoteUpdate = false; 

// UI HELPERS
window.switchTab = (id) => { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); document.getElementById(id).classList.add('active'); };
window.switchSub = (id) => { document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.sub-group').forEach(c => c.style.display = 'none'); event.target.classList.add('active'); document.getElementById(id).style.display = 'block'; document.getElementById('subNav').classList.remove('show'); };
window.switchFeatTab = (id) => { document.querySelectorAll('.feat-tab').forEach(b => b.classList.remove('active')); document.querySelectorAll('.feat-content').forEach(c => c.style.display = 'none'); event.target.classList.add('active'); document.getElementById(id).style.display = 'block'; };
window.toggleSubMenu = () => { document.getElementById('subNav').classList.toggle('show'); };

onAuthStateChanged(auth, (user) => {
    const link = document.getElementById('authLink');
    const mLink = document.getElementById('mobileAuthLink');
    if(user){
        currentUser = user;
        document.getElementById('uidDisplay').textContent = user.email;
        link.textContent = "My Account"; link.href = "account.html";
        mLink.textContent = "My Account"; mLink.href = "account.html";
        initSkills();
        startSync();
    } else {
        window.location.href = "signin.html";
    }
});

function startSync() {
    const docRef = doc(db, 'users', currentUser.uid, 'sheet', 'character');
    onSnapshot(docRef, (snap) => {
        if(snap.exists()) {
            document.getElementById('statusDot').classList.add('live');
            document.getElementById('statusText').textContent = "Live Sync";
            isRemoteUpdate = true; populate(snap.data()); isRemoteUpdate = false;
        }
    });
}

function populate(data) {
    document.querySelectorAll('.live-field').forEach(el => { if(document.activeElement !== el && data[el.id] !== undefined) el.value = data[el.id]; });
    
    if(!document.activeElement?.closest('.sub-group, #items')) {
        const wList = document.getElementById('weaponList'); wList.innerHTML = ''; 
        if(data.weapons) data.weapons.forEach(w => addWeapon(w));

        const sList = document.getElementById('spellList'); sList.innerHTML = ''; 
        if(data.spells) {
            // Sort Spells: Cantrip(0) -> 1 -> 9
            const sortedSpells = data.spells.sort((a,b) => {
                const map = { "Cantrip": 0, "1st": 1, "2nd": 2, "3rd": 3, "4th": 4, "5th": 5, "6th": 6, "7th": 7, "8th": 8, "9th": 9 };
                return (map[a.lvl] || 0) - (map[b.lvl] || 0);
            });
            sortedSpells.forEach(s => addSpell(s));
        }

        document.getElementById('activeList').innerHTML = ''; if(data.activeAbilities) data.activeAbilities.forEach(a => addActive(a));
        document.getElementById('passiveList').innerHTML = ''; if(data.passiveAbilities) data.passiveAbilities.forEach(a => addPassive(a));
        document.getElementById('featList').innerHTML = ''; if(data.feats) data.feats.forEach(f => addFeat(f));
        document.getElementById('itemList').innerHTML = ''; if(data.items) data.items.forEach(i => addItem(i));
    }
    
    if(data.skills) {
        const rows = document.querySelectorAll('#skillsTableBody tr');
        data.skills.forEach((s, i) => { if(rows[i] && document.activeElement !== rows[i].querySelector('input')) { rows[i].querySelector('.skill-cs').checked = s.cs; rows[i].querySelector('.skill-ranks').value = s.lvl; } });
    }
    updateCalcs();
}

function save() {
    if(isRemoteUpdate) return;
    document.getElementById('statusDot').className = 'status-dot'; 
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
        const payload = {};
        document.querySelectorAll('.live-field').forEach(el => payload[el.id] = el.value);
        
        // Custom Scrape for Weapons with attributes
        payload.weapons = [];
        document.getElementById('weaponList').querySelectorAll('details').forEach(d => {
            const attrs = [];
            d.querySelectorAll('.attr-row').forEach(row => {
                attrs.push({ name: row.querySelector('.attr-n').value, val: row.querySelector('.attr-v').value });
            });
            payload.weapons.push({
                name: d.querySelector('.w-name').value,
                mod: d.querySelector('.w-mod').value,
                attrs: attrs
            });
        });

        payload.spells = scrape('spellList', ['.n-val','.l-val','.k-val','.d-val'], ['name','lvl','link','desc']);
        payload.activeAbilities = scrape('activeList', ['.n-val','.u-val','.t-val','.d-val'], ['name','uses','type','desc']);
        payload.passiveAbilities = scrape('passiveList', ['.n-val','.d-val'], ['name','desc']);
        payload.feats = scrape('featList', ['.n-val','.l-val','.d-val'], ['name','link','desc']);
        payload.items = scrape('itemList', ['.n-val','.t-val','.c-val','.d-val','.i-data'], ['name','tags','cost','desc','img']);
        
        payload.skills = [];
        document.querySelectorAll('#skillsTableBody tr').forEach(r => { payload.skills.push({ cs: r.querySelector('.skill-cs').checked, lvl: Number(r.querySelector('.skill-ranks').value)||0 }); });
        
        await setDoc(doc(db,'users',currentUser.uid,'sheet','character'), payload);
        document.getElementById('statusDot').classList.add('live');
    }, 1000);
}

function scrape(id, sels, keys) {
    const arr = [];
    document.getElementById(id).querySelectorAll('details').forEach(d => { const obj = {}; sels.forEach((s,i) => obj[keys[i]] = d.querySelector(s)?.value || ''); arr.push(obj); });
    return arr;
}

function createRow(pid, summaryFunc, html, d={}) {
    const el = document.createElement('details');
    el.innerHTML = `<summary>${summaryFunc(d)} <button class="btn-del">x</button></summary><div class="details-body">${html}</div>`;
    document.getElementById(pid).appendChild(el);
    el.querySelector('.btn-del').onclick = (e) => { e.preventDefault(); el.remove(); save(); };
    el.querySelectorAll('input, textarea, select').forEach(i => i.addEventListener('input', () => { 
        el.querySelector('summary').innerHTML = summaryFunc(scrapeRow(el)) + ` <button class="btn-del">x</button>`;
        el.querySelector('.btn-del').onclick = (e) => { e.preventDefault(); el.remove(); save(); };
        save(); 
    }));
    return el;
}

// Helper to scrape data from a live row to update its summary immediately
function scrapeRow(el){
    const d = {};
    const map = {'.w-name':'name', '.w-mod':'mod', '.n-val':'name', '.l-val':'lvl', '.k-val':'link', '.u-val':'uses', '.t-val':'type'};
    for(let k in map) d[map[k]] = el.querySelector(k)?.value || '';
    return d;
}

window.addWeapon = (d={}) => {
    let attrHtml = '';
    if(d.attrs) d.attrs.forEach(a => attrHtml += `<div class="attr-row"><input class="attr-n" value="${a.name}" placeholder="Attr"><input class="attr-v" value="${a.val}" placeholder="Val"><button class="btn-del" onclick="this.parentElement.remove();save()">x</button></div>`);
    
    const html = `
      <div class="item-row">
        <input class="w-name" value="${d.name||''}" placeholder="Weapon Name">
        <select class="w-mod" style="width:80px">
          <option ${d.mod==='STR'?'selected':''}>STR</option><option ${d.mod==='DEX'?'selected':''}>DEX</option>
          <option ${d.mod==='CON'?'selected':''}>CON</option><option ${d.mod==='INT'?'selected':''}>INT</option>
          <option ${d.mod==='WIS'?'selected':''}>WIS</option><option ${d.mod==='CHA'?'selected':''}>CHA</option>
        </select>
      </div>
      <div class="attr-container">${attrHtml}</div>
      <button class="btn-add" style="padding:5px; font-size:12px; margin-top:5px;" onclick="addWeaponAttr(this)">+ Add Attribute</button>
    `;
    const el = createRow('weaponList', x => x.name||'New Weapon', html, d);
}

window.addWeaponAttr = (btn) => {
    const div = document.createElement('div'); div.className = 'attr-row';
    // REMOVED style="width:60px" so CSS flex rules take over
    div.innerHTML = `<input class="attr-n" placeholder="Attr"><input class="attr-v" placeholder="Val"><button class="btn-del" onclick="this.parentElement.remove();save()">x</button>`;
    btn.previousElementSibling.appendChild(div);
    div.querySelectorAll('input').forEach(i => i.addEventListener('input', save));
};

const SPELL_LVLS = ["Cantrip","1st","2nd","3rd","4th","5th","6th","7th","8th","9th"];
window.addSpell = (d={}) => {
    let opts = ""; SPELL_LVLS.forEach(l => opts += `<option ${d.lvl===l?'selected':''}>${l}</option>`);
    
    const summary = (x) => {
        const nameDisplay = x.link ? `<a href="${x.link}" target="_blank">${x.name||'New Spell'}</a>` : (x.name||'New Spell');
        return `[${x.lvl||'-'}] ${nameDisplay}`;
    };

    const html = `
        <div class="item-row">
            <select class="l-val" style="width:80px">${opts}</select>
            <input class="n-val" value="${d.name||''}" placeholder="Name">
        </div>
        <input class="k-val" value="${d.link||''}" placeholder="Link URL">
        <textarea class="d-val">${d.desc||''}</textarea>
    `;
    createRow('spellList', summary, html, d);
}

const ACTION_TYPES = ["Standard","Move","Swift","Full","Free","Immediate","Reaction"];
window.addActive = (d={}) => {
    let opts = ""; ACTION_TYPES.forEach(t => opts += `<option ${d.type===t?'selected':''}>${t}</option>`);
    const summary = (x) => `<span>${x.name||'Ability'}: <small style="color:#aaa">${x.type||'-'}</small></span> <span>${x.uses||''}</span>`;
    
    const html = `
        <input class="n-val" value="${d.name||''}" placeholder="Name">
        <div class="item-row" style="margin-top:5px;">
             <select class="t-val">${opts}</select>
             <input class="u-val" value="${d.uses||''}" placeholder="Uses (e.g. 3/day)">
        </div>
        <textarea class="d-val">${d.desc||''}</textarea>
    `;
    createRow('activeList', summary, html, d);
}

window.addPassive = (d={}) => createRow('passiveList', x => x.name||'New Passive', `<input class="n-val" value="${d.name||''}" placeholder="Name"><textarea class="d-val">${d.desc||''}</textarea>`, d);
window.addFeat = (d={}) => createRow('featList', x => x.name||'New Feat', `<input class="n-val" value="${d.name||''}" placeholder="Name"><input class="l-val" value="${d.link||''}" placeholder="Link"><textarea class="d-val">${d.desc||''}</textarea>`, d);
window.addItem = (d={}) => createRow('itemList', x => x.name||'New Item', `<div class="item-row"><div style="flex:1"><input class="n-val" value="${d.name||''}" placeholder="Name" style="margin-bottom:5px"><input class="t-val" value="${d.tags||''}" placeholder="Tags" style="margin-bottom:5px"><input class="c-val" value="${d.cost||''}" placeholder="Cost"><input type="hidden" class="i-data" value="${d.img||''}"><input type="file" onchange="encodeImg(this)" style="margin-top:5px; font-size:11px;"></div><img src="${d.img||''}" class="item-img"></div><textarea class="d-val">${d.desc||''}</textarea>`, d);

window.encodeImg = (inp) => { const f = inp.files[0]; if(f){ const r = new FileReader(); r.onload = e => { const p = inp.parentElement; p.querySelector('.i-data').value = e.target.result; p.nextElementSibling.src = e.target.result; save(); }; r.readAsDataURL(f); } };

const SKILLS_DB = [{n:"Acrobatics",s:"dex"}, {n:"Appraise",s:"int"}, {n:"Bluff",s:"cha"}, {n:"Climb",s:"str"}, {n:"Diplomacy",s:"cha"}, {n:"Disable Device",s:"dex"}, {n:"Disguise",s:"cha"}, {n:"Escape Artist",s:"dex"}, {n:"Fly",s:"dex"}, {n:"Heal",s:"wis"}, {n:"Intimidate",s:"cha"}, {n:"Knw: Arcana",s:"int"}, {n:"Knw: Dungeoneering",s:"int"}, {n:"Knw: Engineering",s:"int"}, {n:"Knw: Geography",s:"int"}, {n:"Knw: History",s:"int"}, {n:"Knw: Local",s:"int"}, {n:"Knw: Nature",s:"int"}, {n:"Knw: Nobility",s:"int"}, {n:"Knw: Planes",s:"int"}, {n:"Knw: Religion",s:"int"}, {n:"Linguistics",s:"int"}, {n:"Perception",s:"wis"}, {n:"Ride",s:"dex"}, {n:"Sense Motive",s:"wis"}, {n:"Sleight of Hand",s:"dex"}, {n:"Spellcraft",s:"int"}, {n:"Stealth",s:"dex"}, {n:"Survival",s:"wis"}, {n:"Swim",s:"str"}, {n:"Use Magic Device",s:"cha"}];

function initSkills() {
    const cont = document.getElementById('skillsTableBody'); cont.innerHTML = '';
    SKILLS_DB.forEach(s => {
        const tr = document.createElement('tr'); tr.className = 'skill-row-data'; tr.dataset.stat = s.s;
        tr.innerHTML = `<td><input type="checkbox" class="skill-cs"></td><td style="text-align:left; font-weight:bold;">${s.n} <small style="color:#888; font-weight:normal;">(${s.s})</small></td><td class="skill-mod">0</td><td><input type="number" class="skill-ranks" style="width:40px; text-align:center; background:var(--input-bg); border:1px solid var(--border); padding:4px; border-radius:3px;"></td><td class="skill-total" style="color:var(--accent); font-weight:bold;">0</td>`;
        cont.appendChild(tr); tr.querySelectorAll('input').forEach(i => i.addEventListener('input', () => { updateCalcs(); save(); }));
    });
}
function getMod(id) { const v = document.getElementById(id).value; return v ? Math.floor((v-10)/2) : 0; }
function updateCalcs() {
    ['str','dex','con','int','wis','cha'].forEach(s => { const m = getMod(s); document.getElementById('mod-'+s).textContent = (m>=0?'+':'')+m; });
    const con = getMod('con'), dex = getMod('dex'), wis = getMod('wis');
    const f = (Number(document.getElementById('fort_bonus').value)||0) + con;
    const r = (Number(document.getElementById('ref_bonus').value)||0) + dex;
    const w = (Number(document.getElementById('will_bonus').value)||0) + wis;
    document.getElementById('fort_total').textContent = (f>=0?'+':'')+f; document.getElementById('ref_total').textContent = (r>=0?'+':'')+r; document.getElementById('will_total').textContent = (w>=0?'+':'')+w;
    document.querySelectorAll('#skillsTableBody tr').forEach(row => {
        const mod = getMod(row.dataset.stat); const ranks = Number(row.querySelector('.skill-ranks').value)||0; const cs = row.querySelector('.skill-cs').checked;
        const total = mod + ranks + (cs && ranks>0 ? 3 : 0); row.querySelector('.skill-mod').textContent = mod; row.querySelector('.skill-total').textContent = (total>=0?'+':'')+total;
    });
}
document.body.addEventListener('input', e => { if(e.target.classList.contains('live-field')) { updateCalcs(); save(); } });
</script>
</body>
</html>