<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Character Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
/* --- BASE VARIABLES & THEME --- */
:root { --bg: #1a1a1a; --panel: #252525; --border: #333; --accent: #ffcc66; --text: #ddd; --input-bg: #111; }
body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding-top: 50px; padding-bottom: 50px; }
* { box-sizing: border-box; }

/* --- NAVIGATION --- */
.top-nav { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #000; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 2000; }
.nav-brand { font-family: 'Uncial Antiqua'; color: var(--accent); font-size: 18px; text-decoration: none; }
.nav-links { display: flex; gap: 20px; }
.nav-links a { color: #888; text-decoration: none; font-size: 14px; font-weight: bold; }
.nav-links a:hover, .nav-links a.active { color: #fff; }
#hamburgerBtn { display: none; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; }
#mobileMenu { display: none; position: fixed; top: 50px; left: 0; width: 100%; background: #111; border-bottom: 1px solid var(--accent); flex-direction: column; z-index: 1999; }
#mobileMenu.show { display: flex; }
#mobileMenu a { padding: 15px 20px; color: #fff; text-decoration: none; border-bottom: 1px solid #333; font-family: 'Uncial Antiqua'; }

/* --- MAIN TABS (Sticky) --- */
.main-tabs { display: flex; width: 100%; background: #000; border-bottom: 1px solid var(--accent); position: sticky; top: 50px; z-index: 900; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
.main-tabs::-webkit-scrollbar { display: none; }
.tab-btn { flex: 1 0 auto; min-width: 70px; border: none; background: transparent; color: #888; padding: 12px 10px; cursor: pointer; font-family: 'Uncial Antiqua'; font-size: 14px; text-align: center; border-bottom: 3px solid transparent; transition: 0.2s; white-space: nowrap; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: #111; }

/* --- CONTENT AREA --- */
.tab-content { display: none; padding: 15px; max-width: 800px; margin: 0 auto; }
.tab-content.active { display: block; animation: fade 0.2s; }
@keyframes fade { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
h2, h3, h4 { color: var(--accent); font-family: 'Uncial Antiqua'; margin-top: 0; text-align: center; }

/* --- FORMS & INPUTS --- */
input, textarea, select { background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; width: 100%; font-size: 14px; }
input:focus, textarea:focus { border-color: var(--accent); outline: none; }
label { color: #aaa; font-size: 12px; font-weight: bold; margin-bottom: 4px; display: block; }

/* --- BIO GRID --- */
.bio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.bio-item { display: flex; flex-direction: column; }

/* --- STATS & COMBAT (Default Desktop) --- */
.combat-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; background: var(--panel); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
.stat-box { display: flex; flex-direction: column; align-items: center; }
.stat-dual { display: flex; align-items: center; gap: 5px; width: 100%; justify-content: center; }
.stat-dual input { text-align: center; }

/* --- SUB TABS --- */
.sub-nav-container { margin-bottom: 15px; position: relative; }
.sub-nav { display: flex; justify-content: center; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
.sub-btn { background: none; border: 1px solid transparent; color: #888; padding: 6px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 14px; }
.sub-btn.active { background: var(--accent); color: #000; }

/* --- LISTS (Details) --- */
details { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; overflow: hidden; }
summary { padding: 10px; background: #2a2a2a; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; user-select: none; }
summary a { color: var(--accent); text-decoration: none; position: relative; z-index: 50; }
summary a:hover { text-decoration: underline; }
.details-body { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
.item-row { display: flex; gap: 10px; align-items: flex-start; }
.item-img { width: 50px; height: 50px; background: #000; border: 1px solid #444; object-fit: cover; flex-shrink: 0; }

.attr-row { display: flex; gap: 5px; margin-top: 5px; align-items: center; }
.attr-row .attr-n { flex: 3; min-width: 0; }
.attr-row .attr-v { flex: 7; min-width: 0; }
.attr-row input { font-size: 12px; padding: 4px; }
.attr-row .btn-del { flex: 0 0 auto; width: auto; }

/* --- SKILLS TABLE --- */
.skills-container { background: var(--panel); border-radius: 8px; overflow: hidden; }
#skillsTable th, #skillsTable td { padding: 8px 5px; border-bottom: 1px solid var(--border); text-align: center; }
#skillsTable th { background: #000; }
#skillsTable td:nth-child(2) { text-align: left; } 
#skillsTable input[type="number"] { max-width: 50px; padding: 4px; text-align: center; }
.trained-untrained { color: #ff4444; transition: color 0.3s; }
.trained-trained { color: #fff; }

/* --- FLOATING SUMMON MENU --- */
#summonFab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5); align-items: center; justify-content: center; cursor: pointer; z-index: 2500; font-size: 24px; color: #000; font-weight: bold; border: 2px solid #fff; touch-action: none; user-select: none; display: none; }
#summonFab:active { transform: scale(0.95); }
#summonMenu { display: none; position: fixed; background: #222; border: 1px solid var(--accent); border-radius: 8px; width: 200px; z-index: 2499; overflow: hidden; flex-direction: column; }
#summonMenu.show { display: flex; }
.summon-opt { padding: 12px; border-bottom: 1px solid #333; color: #fff; cursor: pointer; text-align: left; background: none; border-left: none; border-right: none; border-top: none; font-family: sans-serif; }
.summon-opt:hover { background: #333; }
.summon-opt.active { background: var(--accent); color: #000; font-weight: bold; }

/* --- MODAL FOR COLLECTION --- */
#imageModal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; padding: 10px; }
#imageModal img { 
    max-width: 95vw; 
    max-height: 85vh; 
    width: auto; 
    height: auto; 
    border: 2px solid var(--accent); 
    border-radius: 4px; 
    object-fit: contain; 
}
#imageModal button { margin-top: 15px; padding: 10px 20px; background: var(--accent); border: none; font-weight: bold; cursor: pointer; border-radius:4px; font-size:16px; }

/* --- ITEM SUMMARY VIEW BUTTON --- */
.btn-view { background: var(--accent); color: #000; border: none; border-radius: 3px; font-size: 11px; padding: 2px 8px; font-weight: bold; margin-right: 10px; cursor: pointer; }

.btn-add { width: 100%; background: var(--accent); border: none; color: #000; padding: 10px; font-weight: bold; margin-top: 10px; border-radius: 4px; cursor: pointer; }
.btn-del { background: #ff4444; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor:pointer; }
.btn-danger { background: #990000; color: #fff; width: 100%; padding: 12px; border:none; border-radius: 4px; font-weight: bold; margin-top: 20px; cursor: pointer; }

.status-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #000; color: #888; font-size: 11px; padding: 4px 10px; text-align: right; border-top: 1px solid #333; z-index: 2000; display: flex; justify-content: space-between; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; display: inline-block; margin-right: 5px; }
.status-dot.live { background: #4caf50; box-shadow: 0 0 5px #4caf50; }

/* --- MOBILE BREAKPOINTS --- */
@media (max-width: 600px) {
  .nav-links { display: none; }
  #hamburgerBtn { display: block; }
  .tab-btn { font-size: 12px; padding: 12px 8px; }

  /* RESTORE DEFAULT VERTICAL STACK (Used for Saves & General) */
  .combat-stats { display: flex; flex-direction: column; gap: 8px; }
  .stat-box { flex-direction: row; justify-content: space-between; width: 100%; border-bottom: 1px solid #333; padding-bottom: 4px; min-height: auto; background: transparent; padding: 0;}
  .stat-box label { margin: 0; font-size: 14px; text-align: left; width: auto; }
  .stat-box input, .stat-dual { width: 50%; justify-content: flex-end; height: auto; }
  .stat-dual input { width: 48%; }

  /* OVERRIDE: 3-COLUMN COMPACT GRID (Strictly for Top Stats: HP, MP, Speed, Init, BAB, AC) */
  .mobile-3col { 
      display: grid !important; 
      grid-template-columns: repeat(3, 1fr) !important; 
      gap: 5px !important; 
      padding: 5px !important; 
      border-radius: 8px;
  }
  
  /* OVERRIDE: 2-COLUMN GRID (Strictly for CMB/CMD) */
  .mobile-2col {
      display: grid !important; 
      grid-template-columns: 1fr 1fr !important; 
      gap: 5px !important; 
      padding: 5px !important;
  }

  /* SHARED COMPACT BOX STYLES (Only for items inside the grid overrides) */
  .mobile-3col .stat-box, .mobile-2col .stat-box { 
      flex-direction: column !important; 
      justify-content: center !important; 
      width: 100% !important; 
      border-bottom: none !important; 
      padding: 5px !important; 
      background: #2a2a2a; 
      border-radius: 4px;
      min-height: 50px;
  }
  .mobile-3col .stat-box label, .mobile-2col .stat-box label { 
      margin: 0 0 2px 0 !important; 
      font-size: 10px !important; 
      text-align: center;
      width: 100%;
  }
  .mobile-3col .stat-box input, .mobile-2col .stat-box input { 
      width: 100% !important; 
      font-size: 12px !important; 
      text-align: center; 
      height: 25px;
  }
  
  /* SKILL TABLE MOBILE */
  #mobileSkillHeader { display: flex !important; justify-content: space-between; padding: 0 10px 5px 10px; }
  #skillsTable { display: block; width: 100%; }
  #skillsTable thead { display: none; } 
  #skillsTable tbody { display: block; }
  #skillsTable tr { display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; margin-bottom: 8px; padding: 10px; border-radius: 6px; background: var(--panel); }
  #skillsTable td { border: none; padding: 0; white-space: nowrap; text-align: left; }
  #skillsTable tr td:nth-child(1), #skillsTable tr td:nth-child(3) { display: none; }
  #skillsTable tr td:nth-child(2) { flex-basis: 45%; font-weight: bold; font-size: 15px; text-overflow: ellipsis; overflow: hidden; }
  #skillsTable tr td:nth-child(4) { display: flex; align-items: center; gap: 5px; padding: 0; flex-basis: 35%; justify-content: flex-end; }
  #skillsTable tr td:nth-child(4) input { max-width: 40px; padding: 2px 4px !important; font-size: 14px; margin-left: 5px; }
  #skillsTable tr td:nth-child(5) { flex-basis: 20%; text-align: right; font-size: 16px; }
}
</style>
</head>
<body>

<nav class="top-nav">
  <button id="hamburgerBtn" onclick="document.getElementById('mobileMenu').classList.toggle('show')">&#9776;</button>
  <a href="index.html" class="nav-brand">Mount Aetheria</a>
  <div class="nav-links">
    <a href="story.html">Story</a>
    <a href="tools.html">Tools</a>
    <a href="characters.html" class="active" style="color:var(--accent)">Sheet</a>
    <a href="discussions.html">Discussion</a>
    <a href="signin.html" id="authLink">Sign In</a>
  </div>
</nav>

<div id="mobileMenu">
  <a href="story.html">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html" style="color:var(--accent)">Character Sheet</a>
  <a href="discussions.html">Discussion</a>
  <a href="signin.html" id="mobileAuthLink">Sign In</a>
</div>

<div class="main-tabs">
  <button class="tab-btn active" id="btn-character" onclick="switchTab('character')">Character</button>
  <button class="tab-btn" id="btn-combat" onclick="switchTab('combat')">Combat</button>
  <button class="tab-btn" id="btn-skills" onclick="switchTab('skills')">Skills</button>
  <button class="tab-btn" id="btn-items" onclick="switchTab('items')">Items</button>
  <button class="tab-btn" id="btn-notes" onclick="switchTab('notes')">Notes</button>
</div>

<div id="character" class="tab-content active">
  <h2 id="sheetTitle">Character Bio</h2>
  <div class="bio-grid">
    <div class="bio-item"><label>Name</label><input id="charName" class="live-field"></div>
    <div class="bio-item"><label>Race</label><input id="race" class="live-field"></div>
    <div class="bio-item"><label>Class</label><input id="class" class="live-field"></div>
    <div class="bio-item"><label>Align</label><input id="alignment" class="live-field"></div>
    <div class="bio-item"><label>Size</label><input id="size" class="live-field"></div>
    <div class="bio-item"><label>Langs</label><input id="languages" class="live-field"></div>
    <div class="bio-item" style="grid-column: 1 / -1;"><label>Senses</label><input id="senses" class="live-field"></div>
  </div>
  <h3>Ability Scores</h3>
  <div style="background:var(--panel); border-radius:8px; overflow:hidden;">
    <table style="width:100%; border-collapse:collapse; text-align:center;">
        <tr style="background:#000; color:#888; font-size:12px;"><th>Stat</th><th>Score</th><th>Mod</th></tr>
        <script>
            ['str','dex','con','int','wis','cha'].forEach(s => {
                document.write(`<tr style="border-top:1px solid #333;"><td style="font-weight:bold; color:var(--accent); text-transform:uppercase;">${s}</td><td style="padding:8px;"><input type="number" id="${s}" class="live-field calc-trigger" style="text-align:center; background:#111; border:1px solid #444; color:#fff; border-radius:4px;"></td><td id="mod-${s}">+0</td></tr>`);
            });
        </script>
    </table>
  </div>
  <button class="btn-add" id="btnAddSummon" style="background:#444; color:#ccc; margin-top:20px;">+ Add Summoning</button>
  <button id="btnDeleteSummon" class="btn-danger" style="display:none;">Delete Summon</button>
</div>

<div id="combat" class="tab-content">
  <div class="combat-stats mobile-3col">
    <div class="stat-box"><label>HP</label><div class="stat-dual"><input id="hp_curr" class="live-field" placeholder="Cur"><span style="color:#666">/</span><input id="hp_max" class="live-field" placeholder="Max"></div></div>
    <div class="stat-box"><label>MP</label><div class="stat-dual"><input id="mp_curr" class="live-field" placeholder="Cur"><span style="color:#666">/</span><input id="mp_max" class="live-field" placeholder="Max"></div></div>
    <div class="stat-box"><label>AC</label><input id="ac_total" class="live-field"></div>
    <div class="stat-box"><label>Initiative</label><input id="init_bonus" class="live-field"></div>
    <div class="stat-box"><label>BAB</label><input id="bab" class="live-field"></div>
    <div class="stat-box"><label>Speed</label><input id="speed" class="live-field"></div>
  </div>

  <div class="sub-nav-container">
    <div class="sub-nav" id="combatSubNav">
        <button class="sub-btn active" onclick="switchSub('c-general')">General</button>
        <button class="sub-btn" id="abilitiesSubBtn" onclick="switchSub('c-abilities-main')">Abilities</button>
        <button class="sub-btn" id="spellsSubBtn" onclick="switchSub('c-spells')">Spells</button>
    </div>
  </div>
  
  <div id="c-general" class="sub-group active">
    <div class="combat-stats mobile-2col">
        <div class="stat-box"><label>CMB</label><input id="cmb" class="live-field"></div>
        <div class="stat-box"><label>CMD</label><input id="cmd_total" class="live-field"></div>
    </div>
    
    <div id="resistancesBox" style="background:var(--panel); padding:10px; border-radius:8px; margin-bottom:10px;">
        <label>Resistances / Immunities / DR / SR</label>
        <textarea id="resistances" class="live-field" style="height:100px;" placeholder=" "></textarea>
    </div>
    
    <h3>Saves</h3>
    <div class="combat-stats">
        <div class="stat-box"><label>Fortitude</label><div class="stat-dual"><input id="fort_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="fort_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
        <div class="stat-box"><label>Reflex</label><div class="stat-dual"><input id="ref_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="ref_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
        <div class="stat-box"><label>Will</label><div class="stat-dual"><input id="will_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="will_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
    </div>
    
    <h3>Weapons</h3>
    <div id="weaponList"></div><button class="btn-add" onclick="addWeapon()">+ Add Weapon</button>
  </div>

  <div id="c-abilities-main" class="sub-group" style="display:none">
      <div class="sub-nav-container">
        <div class="sub-nav" id="abilitiesSubSubNav">
            <button class="sub-btn active" onclick="switchSubSub('a-active')">Active</button>
            <button class="sub-btn" id="btn-sub-passive" onclick="switchSubSub('a-passive')">Passive</button>
            <button class="sub-btn" onclick="switchSubSub('a-feats')">Feats</button>
        </div>
      </div>
      
      <div id="a-active" class="sub-sub-group active">
          <h3>Active Abilities</h3>
          <div id="activeList"></div>
          <button class="btn-add" onclick="addActive()">+ Add Active</button>
      </div>

      <div id="a-passive" class="sub-sub-group" style="display:none">
          <h3>Passive Abilities</h3>
          <div id="passiveList"></div>
          <button class="btn-add" onclick="addPassive()">+ Add Passive</button>
      </div>

      <div id="a-feats" class="sub-sub-group" style="display:none">
          <h3>Feats</h3>
          <div id="featList"></div>
          <button class="btn-add" onclick="addFeat()">+ Add Feat</button>
          <br><br>
          <label>Proficiencies</label>
          <textarea id="proficiencies" class="live-field" style="height:80px"></textarea>
      </div>
  </div>

  <div id="c-spells" class="sub-group" style="display:none">
      <h3>Spells</h3>
      <div class="stat-box" style="margin-bottom:10px;"><label>Spell DC Base</label><input id="spell_dc_base" class="live-field"></div>
      <div id="spellList"></div>
      <button class="btn-add" onclick="addSpell()">+ Add Spell</button>
  </div>
</div>

<div id="skills" class="tab-content">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><span>Skill Points Unused:</span><input id="skill_points" class="live-field" style="width:60px; text-align:center;"></div>
  <div id="mobileSkillHeader" style="display:none; color:#888; font-size:12px;"><span style="display:inline-block; width:45%;"></span><span style="display:inline-block; width:35%; text-align:right; padding-right: 5px;">RANKS</span><span style="display:inline-block; width:20%; text-align:right;">TOTAL</span></div>
  <div class="skills-container">
    <table id="skillsTable" style="width:100%; border-collapse:collapse; font-size:14px; text-align:center;">
        <thead><tr style="background:#000; color:var(--accent); font-weight:bold;"><th style="width:30px">CS</th><th style="text-align:left;">Skill Name</th><th style="width:40px">Mod</th><th style="width:50px">Ranks</th><th style="width:40px" id="skillHeaderTotal">Total</th></tr></thead>
        <tbody id="skillsTableBody"></tbody>
    </table>
  </div>
</div>

<div id="items" class="tab-content">
  <div class="combat-stats" style="grid-template-columns: 1fr 1fr;"><div class="stat-box"><label>ðŸ’° Gil</label><input id="currency_gil" class="live-field"></div><div class="stat-box"><label>Moogle Pts</label><input id="currency_moogle" class="live-field"></div></div>
  
  <div style="display:flex; gap:10px; margin-bottom:10px;">
    <select id="itemFilterTag" onchange="renderItems()" style="flex:1;">
      <option value="All">All Tags</option>
      <option value="Weapons">Weapons</option>
      <option value="Armor">Armor</option>
      <option value="Gear">Gear</option>
      <option value="Consumables">Consumables</option>
      <option value="Magic Items">Magic Items</option>
      <option value="Collections">Collections</option>
      <option value="Misc">Misc</option>
    </select>
    <select id="itemSort" onchange="renderItems()" style="flex:1;">
      <option value="recent">Recent</option>
      <option value="abc">A-Z</option>
    </select>
  </div>

  <div id="itemList"></div>
  <button class="btn-add" onclick="addItem()">+ Add Item</button>
</div>

<div id="notes" class="tab-content"><textarea id="notesArea" class="live-field" style="height:400px; font-family:sans-serif; line-height:1.5;"></textarea></div>

<div id="summonMenu"></div>
<div id="summonFab">â—Ž</div>

<div id="imageModal" onclick="this.style.display='none'">
  <img id="modalImg" src="">
  <button onclick="document.getElementById('imageModal').style.display='none'">Close</button>
</div>

<div class="status-bar"><span id="uidDisplay">Loading...</span><div><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting</span></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw", authDomain: "mount-aetheria.firebaseapp.com", projectId: "mount-aetheria", storageBucket: "mount-aetheria.firebasestorage.app", messagingSenderId: "492855693446", appId: "1:492855693446:web:f99485569254a7220c38107", measurementId: "G-0PF84KDN7L" };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let saveTimeout = null;
let isRemoteUpdate = false;
let fullData = { summons: [] }; 
let currentSummonId = null; 

// --- TAB SWITCHING & PERSISTENCE ---

window.switchTab = (id) => { 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
    const btn = document.getElementById('btn-' + id);
    if(btn) btn.classList.add('active');
    document.getElementById(id).classList.add('active'); 
};

// Sub Tabs (Combat General/Abilities/Spells)
window.switchSub = (id) => { 
    const container = document.getElementById('combatSubNav');
    Array.from(container.children).forEach(b => b.classList.remove('active'));
    // Find the button that triggers this ID
    const targetBtn = Array.from(container.children).find(b => b.getAttribute('onclick').includes(id));
    if(targetBtn) targetBtn.classList.add('active');
    
    document.getElementById('combat').querySelectorAll('.sub-group').forEach(c => c.style.display = 'none');
    document.getElementById(id).style.display = 'block';

    // Persist choice
    localStorage.setItem('activeCombatSub', id);
};

// Nested Tabs (Active/Passive/Feats)
window.switchSubSub = (id) => {
    const container = document.getElementById('abilitiesSubSubNav');
    Array.from(container.children).forEach(b => b.classList.remove('active'));
    const targetBtn = Array.from(container.children).find(b => b.getAttribute('onclick').includes(id));
    if(targetBtn) targetBtn.classList.add('active');

    document.getElementById('c-abilities-main').querySelectorAll('.sub-sub-group').forEach(c => c.style.display = 'none');
    document.getElementById(id).style.display = 'block'; 

    // Persist choice
    localStorage.setItem('activeAbilSub', id);
};

// --- FAB LOGIC ---
const fab = document.getElementById('summonFab');
const menu = document.getElementById('summonMenu');

fab.onclick = (e) => {
    if(fab.dataset.dragging === "true") return;
    const rect = fab.getBoundingClientRect();
    const menuWidth = 200; 
    const menuHeight = 250;
    const spaceBelow = window.innerHeight - rect.bottom;
    const spaceAbove = rect.top;
    menu.style.bottom = 'auto'; menu.style.top = 'auto';
    if (spaceBelow >= menuHeight || spaceBelow > spaceAbove) { menu.style.top = (rect.bottom + 10) + 'px'; } else { menu.style.bottom = (window.innerHeight - rect.top + 10) + 'px'; }
    const spaceRight = window.innerWidth - rect.right;
    menu.style.left = 'auto'; menu.style.right = 'auto';
    if (spaceRight >= menuWidth) { menu.style.left = rect.left + 'px'; } else { 
        let newRight = (window.innerWidth - rect.right);
        newRight = Math.min(newRight, window.innerWidth - menuWidth - 10);
        menu.style.right = newRight + 'px';
    }
    menu.classList.toggle('show');
};

let isDragging = false;
let dragOffset = { x: 0, y: 0 };
const startDrag = (e) => {
    isDragging = true;
    fab.dataset.dragging = "false";
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const rect = fab.getBoundingClientRect();
    dragOffset.x = clientX - rect.left;
    dragOffset.y = clientY - rect.top;
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('touchmove', onDrag, {passive: false});
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);
};
const onDrag = (e) => {
    if(!isDragging) return;
    e.preventDefault(); 
    fab.dataset.dragging = "true";
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    let newX = clientX - dragOffset.x;
    let newY = clientY - dragOffset.y;
    newX = Math.max(0, Math.min(window.innerWidth - fab.offsetWidth, newX));
    newY = Math.max(0, Math.min(window.innerHeight - fab.offsetHeight, newY));
    fab.style.left = newX + 'px'; fab.style.top = newY + 'px';
};
const endDrag = () => {
    isDragging = false;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('touchmove', onDrag);
    document.removeEventListener('mouseup', endDrag);
    document.removeEventListener('touchend', endDrag);
};
fab.addEventListener('mousedown', startDrag);
fab.addEventListener('touchstart', startDrag, {passive: false});

// --- AUTH & SYNC ---

onAuthStateChanged(auth, (user) => {
    if(user){
        currentUser = user;
        document.getElementById('uidDisplay').textContent = user.email;
        document.getElementById('authLink').textContent = "My Account"; document.getElementById('authLink').href = "account.html";
        document.getElementById('mobileAuthLink').textContent = "My Account"; document.getElementById('mobileAuthLink').href = "account.html";
        initSkills();
        startSync();
    } else {
        window.location.href = "signin.html";
    }
});

function startSync() {
    const docRef = doc(db, 'users', currentUser.uid, 'sheet', 'character');
    onSnapshot(docRef, (snap) => {
        if(snap.metadata.hasPendingWrites) return;

        if(snap.exists()) {
            document.getElementById('statusDot').classList.add('live');
            document.getElementById('statusText').textContent = "Live Sync";
            fullData = snap.data();
            if(!fullData.summons) fullData.summons = [];
            isRemoteUpdate = true;
            loadCurrentSheet();
            updateSummonMenu();
            isRemoteUpdate = false;
        }
    });
}

function loadCurrentSheet() {
    let data;
    if(currentSummonId) {
        data = fullData.summons.find(s => s.id === currentSummonId);
        if(!data) { currentSummonId = null; data = fullData; } 
    } else {
        data = fullData;
    }
    
    if(currentSummonId) {
        document.getElementById('sheetTitle').textContent = "Summoning Sheet";
        document.getElementById('btnAddSummon').style.display = 'none';
        document.getElementById('btnDeleteSummon').style.display = 'block';
        document.getElementById('btnDeleteSummon').onclick = deleteCurrentSummon;
        document.getElementById('btn-skills').style.display = 'none';
        document.getElementById('btn-items').style.display = 'none';
        document.getElementById('spellsSubBtn').style.display = 'none';
        document.getElementById('btn-sub-passive').style.display = 'none';
        const activeTab = document.querySelector('.tab-content.active')?.id;
        if(['skills','items','notes','character'].includes(activeTab)) document.getElementById('btn-combat').click();
    } else {
        document.getElementById('sheetTitle').textContent = "Character Sheet";
        document.getElementById('btnAddSummon').style.display = 'block';
        document.getElementById('btnAddSummon').onclick = createNewSummon;
        document.getElementById('btnDeleteSummon').style.display = 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.style.display = '');
        document.getElementById('spellsSubBtn').style.display = 'block';
        document.getElementById('btn-sub-passive').style.display = 'block';
    }
    
    const savedCombatSub = localStorage.getItem('activeCombatSub') || 'c-general';
    const savedAbilSub = localStorage.getItem('activeAbilSub') || 'a-active';
    switchSub(savedCombatSub);
    switchSubSub(savedAbilSub);

    ['weaponList', 'spellList', 'activeList', 'passiveList', 'featList', 'itemList'].forEach(id => document.getElementById(id).innerHTML = '');

    document.querySelectorAll('.live-field').forEach(el => {
        el.value = ""; 
        if(data[el.id] !== undefined) el.value = data[el.id];
    });
    
    if(data.weapons) data.weapons.forEach(w => addWeapon(w));
    if(data.spells) {
        const sortedSpells = data.spells.sort((a,b) => {
            const map = { "Cantrip": 0, "1st": 1, "2nd": 2, "3rd": 3, "4th": 4, "5th": 5, "6th": 6, "7th": 7, "8th": 8, "9th": 9 };
            return (map[a.lvl] || 0) - (map[b.lvl] || 0);
        });
        sortedSpells.forEach(s => addSpell(s));
    }
    if(data.activeAbilities) data.activeAbilities.forEach(a => addActive(a));
    if(data.passiveAbilities) data.passiveAbilities.forEach(a => addPassive(a));
    if(data.feats) data.feats.forEach(f => addFeat(f));
    
    renderItems(); 
    
    if(data.skills) {
        const rows = document.querySelectorAll('#skillsTableBody tr');
        rows.forEach(r => { r.querySelector('.skill-cs').checked = false; r.querySelector('.skill-ranks').value = ""; });
        data.skills.forEach((s, i) => { if(rows[i]) { rows[i].querySelector('.skill-cs').checked = s.cs; rows[i].querySelector('.skill-ranks').value = s.lvl; } });
    }
    updateCalcs();
}

function updateSummonMenu() {
    const fab = document.getElementById('summonFab');
    if(fullData.summons && fullData.summons.length > 0) { fab.style.display = 'flex'; } else { fab.style.display = 'none'; menu.classList.remove('show'); }
    const menuEl = document.getElementById('summonMenu');
    menuEl.innerHTML = '';
    const mainBtn = document.createElement('button');
    mainBtn.className = `summon-opt ${currentSummonId === null ? 'active' : ''}`;
    mainBtn.textContent = fullData.charName || "Main Character";
    mainBtn.onclick = () => { currentSummonId = null; loadCurrentSheet(); menuEl.classList.remove('show'); };
    menuEl.appendChild(mainBtn);
    fullData.summons.forEach(s => {
        const btn = document.createElement('button');
        btn.className = `summon-opt ${currentSummonId === s.id ? 'active' : ''}`;
        btn.textContent = s.charName || "Unnamed Summon";
        btn.onclick = () => { currentSummonId = s.id; loadCurrentSheet(); menuEl.classList.remove('show'); };
        menuEl.appendChild(btn);
    });
}

window.createNewSummon = async () => {
    const newId = 'sum_' + Date.now();
    const template = { id: newId, charName: 'New Summon', summons: [] }; 
    if(!fullData.summons) fullData.summons = [];
    fullData.summons.push(template);
    currentSummonId = newId;
    save(true);
    loadCurrentSheet();
    updateSummonMenu();
}

window.deleteCurrentSummon = async () => {
    if(!confirm("Are you sure you want to delete this Summon sheet?")) return;
    fullData.summons = fullData.summons.filter(s => s.id !== currentSummonId);
    currentSummonId = null;
    save(true);
    loadCurrentSheet();
    updateSummonMenu();
}

// --- SAVING ---

function scrapeCurrentSheet() {
    const payload = {};
    document.querySelectorAll('.live-field').forEach(el => payload[el.id] = el.value);
    
    payload.weapons = [];
    document.getElementById('weaponList').querySelectorAll('details').forEach(d => {
        const attrs = [];
        d.querySelectorAll('.attr-row').forEach(row => {
            attrs.push({ name: row.querySelector('.attr-n').value, val: row.querySelector('.attr-v').value });
        });
        payload.weapons.push({
            name: d.querySelector('.w-name').value,
            mod: d.querySelector('.w-mod').value,
            attrs: attrs
        });
    });

    payload.spells = scrape('spellList', ['.n-val','.l-val','.k-val','.d-val'], ['name','lvl','link','desc']);
    payload.activeAbilities = scrape('activeList', ['.n-val','.u-val','.t-val','.d-val'], ['name','uses','type','desc']);
    payload.passiveAbilities = scrape('passiveList', ['.n-val','.d-val'], ['name','desc']);
    payload.feats = scrape('featList', ['.n-val','.l-val','.d-val'], ['name','link','desc']);
    
    if(currentSummonId) {
        const s = fullData.summons.find(x => x.id === currentSummonId);
        payload.items = s.items || [];
    } else {
        payload.items = fullData.items || [];
    }

    payload.skills = [];
    document.querySelectorAll('#skillsTableBody tr').forEach(r => { payload.skills.push({ cs: r.querySelector('.skill-cs').checked, lvl: Number(r.querySelector('.skill-ranks').value)||0 }); });
    
    return payload;
}

function save(force = false) {
    if(isRemoteUpdate && !force) return;
    document.getElementById('statusDot').className = 'status-dot'; 
    clearTimeout(saveTimeout);
    
    saveTimeout = setTimeout(async () => {
        const currentSheetData = scrapeCurrentSheet();
        
        if(currentSummonId) {
            currentSheetData.id = currentSummonId;
            const index = fullData.summons.findIndex(s => s.id === currentSummonId);
            if(index >= 0) fullData.summons[index] = currentSheetData;
        } else {
            const summonsBackup = fullData.summons;
            fullData = { ...currentSheetData, summons: summonsBackup, items: fullData.items };
        }

        await setDoc(doc(db,'users',currentUser.uid,'sheet','character'), fullData);
        document.getElementById('statusDot').classList.add('live');
        if(!force) updateSummonMenu(); 
    }, 1000);
}

function scrape(id, sels, keys) {
    const arr = [];
    document.getElementById(id).querySelectorAll('details').forEach(d => { const obj = {}; sels.forEach((s,i) => obj[keys[i]] = d.querySelector(s)?.value || ''); arr.push(obj); });
    return arr;
}

// --- DYNAMIC ROWS ---

function createRow(pid, summaryFunc, html, d={}) {
    const el = document.createElement('details');
    el.innerHTML = `<summary>${summaryFunc(d)} <button class="btn-del">x</button></summary><div class="details-body">${html}</div>`;
    document.getElementById(pid).appendChild(el);
    el.querySelector('.btn-del').onclick = (e) => { e.preventDefault(); el.remove(); save(); };
    el.querySelectorAll('input, textarea, select').forEach(i => i.addEventListener('input', () => { 
        el.querySelector('summary').innerHTML = summaryFunc(scrapeRow(el)) + ` <button class="btn-del">x</button>`;
        el.querySelector('.btn-del').onclick = (e) => { e.preventDefault(); el.remove(); save(); };
        save(); 
    }));
    return el;
}

function scrapeRow(el){
    const d = {};
    const map = {'.w-name':'name', '.w-mod':'mod', '.n-val':'name', '.l-val':'lvl', '.k-val':'link', '.u-val':'uses', '.t-val':'type'};
    for(let k in map) d[map[k]] = el.querySelector(k)?.value || '';
    return d;
}

window.addWeapon = (d={}) => {
    let attrHtml = '';
    if(d.attrs) d.attrs.forEach(a => attrHtml += `<div class="attr-row"><input class="attr-n" value="${a.name}" placeholder="Attr"><input class="attr-v" value="${a.val}" placeholder="Val"><button class="btn-del" onclick="this.parentElement.remove();save()">x</button></div>`);
    const html = `
      <div class="item-row">
        <input class="w-name" value="${d.name||''}" placeholder="Weapon Name">
        <select class="w-mod" style="width:80px"><option ${d.mod==='STR'?'selected':''}>STR</option><option ${d.mod==='DEX'?'selected':''}>DEX</option><option ${d.mod==='CON'?'selected':''}>CON</option><option ${d.mod==='INT'?'selected':''}>INT</option><option ${d.mod==='WIS'?'selected':''}>WIS</option><option ${d.mod==='CHA'?'selected':''}>CHA</option></select>
      </div>
      <div class="attr-container">${attrHtml}</div>
      <button class="btn-add" style="padding:5px; font-size:12px; margin-top:5px;" onclick="addWeaponAttr(this)">+ Add Attribute</button>
    `;
    createRow('weaponList', x => x.name||'New Weapon', html, d);
}
window.addWeaponAttr = (btn) => {
    const div = document.createElement('div'); div.className = 'attr-row';
    div.innerHTML = `<input class="attr-n" placeholder="Attr"><input class="attr-v" placeholder="Val"><button class="btn-del" onclick="this.parentElement.remove();save()">x</button>`;
    btn.previousElementSibling.appendChild(div);
    div.querySelectorAll('input').forEach(i => i.addEventListener('input', save));
};

const SPELL_LVLS = ["Cantrip","1st","2nd","3rd","4th","5th","6th","7th","8th","9th"];
window.addSpell = (d={}) => {
    let opts = ""; SPELL_LVLS.forEach(l => opts += `<option ${d.lvl===l?'selected':''}>${l}</option>`);
    const summary = (x) => { const nameDisplay = x.link ? `<a href="${x.link}" target="_blank">${x.name||'New Spell'}</a>` : (x.name||'New Spell'); return `[${x.lvl||'-'}] ${nameDisplay}`; };
    const html = `<div class="item-row"><select class="l-val" style="width:80px">${opts}</select><input class="n-val" value="${d.name||''}" placeholder="Name"></div><input class="k-val" value="${d.link||''}" placeholder="Link URL"><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('spellList', summary, html, d);
}

const ACTION_TYPES = ["Standard","Move","Swift","Full","Free","Immediate","Reaction"];
window.addActive = (d={}) => {
    let opts = ""; ACTION_TYPES.forEach(t => opts += `<option ${d.type===t?'selected':''}>${t}</option>`);
    const summary = (x) => `<span>${x.name||'Ability'}: <small style="color:#aaa">${x.type||'-'}</small></span> <span>${x.uses||''}</span>`;
    const html = `<input class="n-val" value="${d.name||''}" placeholder="Name"><div class="item-row" style="margin-top:5px;"><select class="t-val">${opts}</select><input class="u-val" value="${d.uses||''}" placeholder="Uses (e.g. 3/day)"></div><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('activeList', summary, html, d);
}

window.addPassive = (d={}) => createRow('passiveList', x => x.name||'New Passive', `<input class="n-val" value="${d.name||''}" placeholder="Name"><textarea class="d-val">${d.desc||''}</textarea>`, d);
window.addFeat = (d={}) => createRow('featList', x => x.name||'New Feat', `<input class="n-val" value="${d.name||''}" placeholder="Name"><input class="l-val" value="${d.link||''}" placeholder="Link"><textarea class="d-val">${d.desc||''}</textarea>`, d);

// --- ITEMS OVERHAUL ---
const ITEM_TAGS = ["Weapons", "Armor", "Gear", "Consumables", "Magic Items", "Misc"];

window.addItem = (d={}) => {
    if(!fullData.items && !currentSummonId) fullData.items = [];
    let targetArr = currentSummonId ? fullData.summons.find(s=>s.id===currentSummonId).items : fullData.items;
    if(!targetArr) targetArr = [];
    
    if(Object.keys(d).length === 0) {
        targetArr.push({ name: '', tags: 'Misc', cost: '', desc: '' });
    }
    if(currentSummonId) fullData.summons.find(s=>s.id===currentSummonId).items = targetArr;
    else fullData.items = targetArr;
    
    save();
    renderItems();
};

window.renderItems = () => {
    const container = document.getElementById('itemList');
    container.innerHTML = '';
    
    let items = currentSummonId ? (fullData.summons.find(s=>s.id===currentSummonId)?.items || []) : (fullData.items || []);
    const tagFilter = document.getElementById('itemFilterTag').value;
    let filtered = items.filter(i => {
        if(tagFilter === "All") return true;
        return i.tags === tagFilter;
    });

    const sortType = document.getElementById('itemSort').value;
    if(sortType === "abc") {
        filtered.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    } else {
        filtered.reverse();
    }

    filtered.forEach(item => {
        const sourceIndex = items.indexOf(item); 
        const el = document.createElement('details');
        const isCollection = item.tags === "Collections";
        
        // --- SUMMARY WITH VIEW BUTTON ---
        const viewBtn = (isCollection && item.img) ? `<button class="btn-view" onclick="event.stopPropagation(); viewCollection('${item.img}')">View Collection</button>` : '';

        el.innerHTML = `
            <summary>
                <div style="display:flex; align-items:center; overflow:hidden;">
                    <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.name || 'New Item'} <small style="color:#888; font-weight:normal">(${item.tags})</small></span>
                </div>
                <div style="flex-shrink:0;">
                    ${viewBtn}
                    <button class="btn-del">x</button>
                </div>
            </summary>
            <div class="details-body">
                <input class="n-val" value="${item.name||''}" placeholder="Name" style="margin-bottom:5px">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    ${isCollection ? 
                        `<input disabled value="Collections" style="flex:1; color:#888">` : 
                        `<select class="t-val" style="flex:1">
                            ${ITEM_TAGS.map(t => `<option ${item.tags===t?'selected':''}>${t}</option>`).join('')}
                         </select>`
                    }
                    <input class="c-val" value="${item.cost||''}" placeholder="Cost" style="flex:1">
                </div>
                <textarea class="d-val" placeholder="Description">${item.desc||''}</textarea>
            </div>
        `;

        container.appendChild(el);

        const updateData = () => {
             item.name = el.querySelector('.n-val').value;
             if(!isCollection) item.tags = el.querySelector('.t-val').value;
             item.cost = el.querySelector('.c-val').value;
             item.desc = el.querySelector('.d-val').value;
             
             // Update Summary
             const newViewBtn = (isCollection && item.img) ? `<button class="btn-view" onclick="event.stopPropagation(); viewCollection('${item.img}')">View Collection</button>` : '';
             el.querySelector('summary').innerHTML = `
                <div style="display:flex; align-items:center; overflow:hidden;">
                    <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.name || 'New Item'} <small style="color:#888; font-weight:normal">(${item.tags})</small></span>
                </div>
                <div style="flex-shrink:0;">
                    ${newViewBtn}
                    <button class="btn-del">x</button>
                </div>
             `;
             // Re-bind delete
             el.querySelector('.btn-del').onclick = (e) => { e.preventDefault(); items.splice(sourceIndex, 1); save(); renderItems(); };
             save();
        };

        el.querySelectorAll('input, textarea, select').forEach(i => i.addEventListener('input', updateData));
        
        el.querySelector('.btn-del').onclick = (e) => {
            e.preventDefault();
            items.splice(sourceIndex, 1); 
            save();
            renderItems(); 
        };
    });
};

window.viewCollection = (url) => {
    document.getElementById('modalImg').src = url;
    document.getElementById('imageModal').style.display = 'flex';
};

// --- SKILLS LOGIC ---
const SKILLS_DB = [{n:"Acrobatics",s:"dex"}, {n:"Appraise",s:"int"}, {n:"Bluff",s:"cha"}, {n:"Climb",s:"str"}, {n:"Diplomacy",s:"cha"}, {n:"Disable Device",s:"dex"}, {n:"Disguise",s:"cha"}, {n:"Escape Artist",s:"dex"}, {n:"Fly",s:"dex"}, {n:"Handle Animal",s:"cha"}, {n:"Heal",s:"wis"}, {n:"Intimidate",s:"cha"}, {n:"Knw: Arcana",s:"int"}, {n:"Knw: Dungeoneering",s:"int"}, {n:"Knw: Engineering",s:"int"}, {n:"Knw: Geography",s:"int"}, {n:"Knw: History",s:"int"}, {n:"Knw: Local",s:"int"}, {n:"Knw: Nature",s:"int"}, {n:"Knw: Nobility",s:"int"}, {n:"Knw: Planes",s:"int"}, {n:"Knw: Religion",s:"int"}, {n:"Linguistics",s:"int"}, {n:"Perception",s:"wis"}, {n:"Profession",s:"wis"}, {n:"Ride",s:"dex"}, {n:"Sense Motive",s:"wis"}, {n:"Sleight of Hand",s:"dex"}, {n:"Spellcraft",s:"int"}, {n:"Stealth",s:"dex"}, {n:"Survival",s:"wis"}, {n:"Swim",s:"str"}, {n:"Use Magic Device",s:"cha"}];

const TRAINED_ONLY_LIST = ["Disable Device", "Handle Animal", "Knw: Arcana", "Knw: Dungeoneering", "Knw: Engineering", "Knw: Geography", "Knw: History", "Knw: Local", "Knw: Nature", "Knw: Nobility", "Knw: Planes", "Knw: Religion", "Linguistics", "Profession", "Use Magic Device"];

function initSkills() {
    const cont = document.getElementById('skillsTableBody'); cont.innerHTML = '';
    SKILLS_DB.forEach(s => {
        const tr = document.createElement('tr'); tr.className = 'skill-row-data'; tr.dataset.stat = s.s;
        tr.innerHTML = `<td><input type="checkbox" class="skill-cs"></td><td style="text-align:left; font-weight:bold;" class="skill-name-cell">${s.n} <small style="color:#888; font-weight:normal;">(${s.s})</small></td><td class="skill-mod">0</td><td><input type="number" class="skill-ranks" style="width:40px; text-align:center; background:var(--input-bg); border:1px solid var(--border); padding:4px; border-radius:3px;"></td><td class="skill-total" style="color:var(--accent); font-weight:bold;">0</td>`;
        cont.appendChild(tr); tr.querySelectorAll('input').forEach(i => i.addEventListener('input', () => { updateCalcs(); save(); }));
    });
}
function getMod(id) { const v = document.getElementById(id).value; return v ? Math.floor((v-10)/2) : 0; }
function updateCalcs() {
    ['str','dex','con','int','wis','cha'].forEach(s => { const m = getMod(s); document.getElementById('mod-'+s).textContent = (m>=0?'+':'')+m; });
    const con = getMod('con'), dex = getMod('dex'), wis = getMod('wis');
    const f = (Number(document.getElementById('fort_bonus').value)||0) + con;
    const r = (Number(document.getElementById('ref_bonus').value)||0) + dex;
    const w = (Number(document.getElementById('will_bonus').value)||0) + wis;
    document.getElementById('fort_total').textContent = (f>=0?'+':'')+f; document.getElementById('ref_total').textContent = (r>=0?'+':'')+r; document.getElementById('will_total').textContent = (w>=0?'+':'')+w;
    
    document.querySelectorAll('#skillsTableBody tr').forEach(row => {
        const mod = getMod(row.dataset.stat); const ranks = Number(row.querySelector('.skill-ranks').value)||0; const cs = row.querySelector('.skill-cs').checked;
        const total = mod + ranks + (cs && ranks>0 ? 3 : 0); row.querySelector('.skill-mod').textContent = mod; row.querySelector('.skill-total').textContent = (total>=0?'+':'')+total;

        const skillNameFull = row.querySelector('.skill-name-cell').textContent;
        const skillName = skillNameFull.split(' (')[0].trim();
        
        if(TRAINED_ONLY_LIST.includes(skillName)) {
            const nameCell = row.querySelector('.skill-name-cell');
            if(ranks < 1) {
                nameCell.classList.add('trained-untrained');
                nameCell.classList.remove('trained-trained');
            } else {
                nameCell.classList.remove('trained-untrained');
                nameCell.classList.add('trained-trained');
            }
        }
    });
}
document.body.addEventListener('input', e => { if(e.target.classList.contains('live-field')) { updateCalcs(); save(); } });
</script>
</body>
</html>