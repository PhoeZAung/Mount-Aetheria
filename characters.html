<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Character Sheet</title>
<meta name="theme-color" content="#1a1a1a">
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
/* --- BASE VARIABLES & THEME --- */
:root { --bg: #1a1a1a; --panel: #252525; --border: #333; --accent: #ffcc66; --text: #ddd; --input-bg: #111; }
body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding-top: 50px; padding-bottom: 50px; height: 100vh; display: flex; flex-direction: column; }
* { box-sizing: border-box; }

/* --- NAVIGATION --- */
.top-nav { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #000; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 2000; }
.nav-brand { font-family: 'Uncial Antiqua'; color: var(--accent); font-size: 18px; text-decoration: none; }
.nav-links { display: flex; gap: 20px; }
.nav-links a { color: #888; text-decoration: none; font-size: 14px; font-weight: bold; }
.nav-links a:hover, .nav-links a.active { color: #fff; }
#hamburgerBtn { display: none; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; }
#mobileMenu { display: none; position: fixed; top: 50px; left: 0; width: 100%; background: #111; border-bottom: 1px solid var(--accent); flex-direction: column; z-index: 1999; }
#mobileMenu.show { display: flex; }
#mobileMenu a { padding: 15px 20px; color: #fff; text-decoration: none; border-bottom: 1px solid #333; font-family: 'Uncial Antiqua'; }

/* --- MAIN TABS (Sticky) --- */
.main-tabs { display: flex; width: 100%; background: #000; border-bottom: 1px solid var(--accent); position: sticky; top: 50px; z-index: 900; flex-shrink: 0; overflow-x: auto; scrollbar-width: none; justify-content: flex-start; padding-right: 20px; }
.tab-btn { flex: 1 0 auto; min-width: 70px; border: none; background: transparent; color: #888; padding: 12px 10px; cursor: pointer; font-family: 'Uncial Antiqua'; font-size: 14px; text-align: center; border-bottom: 3px solid transparent; transition: 0.2s; white-space: nowrap; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: #111; }

/* --- CONTENT AREA --- */
.tab-content { display: none; padding: 15px; max-width: 800px; margin: 0 auto; width: 100%; flex-grow: 1; overflow-y: auto; }
.tab-content.active { display: block; animation: fade 0.2s; }
@keyframes fade { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
h2, h3, h4 { color: var(--accent); font-family: 'Uncial Antiqua'; margin-top: 0; text-align: center; }

/* --- FORMS & INPUTS --- */
input, textarea, select { background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; width: 100%; font-size: 14px; }
input:focus, textarea:focus { border-color: var(--accent); outline: none; }
label { color: #aaa; font-size: 12px; font-weight: bold; margin-bottom: 4px; display: block; }
textarea { resize: none; overflow-y: hidden; min-height: 80px; }

/* --- BIO GRID --- */
.bio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.bio-item { display: flex; flex-direction: column; }

/* --- VITALS (HP/MP) --- */
.vital-row { display: flex; gap: 10px; margin-bottom: 15px; }
.vital-box { flex: 1; background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; }
.vital-box label { font-size: 14px; color: var(--accent); margin-bottom: 5px; }
.vital-inputs { display: flex; align-items: center; gap: 5px; width: 100%; }
.vital-inputs input { text-align: center; font-size: 18px; font-weight: bold; padding: 10px 5px; background: #111; border: 1px solid #444; }
.vital-inputs span { color: #666; font-size: 20px; }

/* --- STATS & COMBAT --- */
.combat-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; background: var(--panel); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
.stat-box { display: flex; flex-direction: column; align-items: center; }
.stat-dual { display: flex; align-items: center; gap: 2px; width: 100%; justify-content: center; }
.stat-dual input { text-align: center; padding: 8px 2px; }

/* --- LIST ROWS --- */
.list-row { background: var(--panel); padding: 10px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent; }
.list-row:hover { background: #333; border-color: #555; }
.row-content { flex-grow: 1; display: flex; flex-direction: column; padding-right: 10px; min-width: 0; }
.row-actions { flex-shrink: 0; display: flex; align-items: center; gap: 5px; }

/* Active Ability Specific Layout */
.row-content.active-ability-layout { flex-direction: row; align-items: center; justify-content: space-between; gap: 10px; }
.active-name { font-weight: bold; color: var(--accent); flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.active-type { color: #888; font-size: 12px; margin-right: 10px; white-space: nowrap; }

.list-row-title { font-weight: bold; color: var(--accent); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-row-meta { color: #888; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* --- INLINE INPUTS FOR ABILITIES --- */
.inline-input-group { display: flex; align-items: center; gap: 2px; margin-right: 5px; }
.inline-input-group input { width: 35px; padding: 4px 0; text-align: center; background: #111; border: 1px solid #444; border-radius: 4px; font-size: 13px; color: var(--accent); height: 28px; }
.inline-input-group span { color: #666; font-size: 14px; font-weight: bold; }

/* --- MODALS (Shared) --- */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(3px); }
.modal-content { background: #222; border: 1px solid var(--accent); border-radius: 8px; width: 100%; max-width: 500px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
.modal-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; border-radius: 8px 8px 0 0; flex-shrink: 0; }
.modal-header h3 { margin: 0; font-size: 18px; color: var(--accent); font-family: 'Uncial Antiqua'; }
.modal-body { padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; overflow-x: hidden; } 
.view-text { color: #eee; font-size: 15px; margin-bottom: 12px; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.5; max-width: 100%; }
.view-label { color: #888; font-size: 11px; text-transform: uppercase; margin-bottom: 2px; font-weight: bold; }
.view-attr-block { display: block; background: #333; padding: 6px; border-radius: 4px; font-size: 13px; margin-bottom: 5px; border: 1px solid #444; color: #eee; }

/* --- BUTTONS --- */
.btn-add { width: 100%; background: var(--accent); border: none; color: #000; padding: 10px; font-weight: bold; margin-top: 10px; border-radius: 4px; cursor: pointer; }
.btn-del { background: #ff4444; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor:pointer; font-weight: bold; }
.btn-edit { background: #444; color: #ccc; border: 1px solid #666; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor:pointer; font-weight: bold; transition: 0.2s; }
.btn-edit:hover { background: var(--accent); color: #000; border-color: var(--accent); }
.btn-link-small { background: #4488ff; color: #fff; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; text-decoration: none; display: inline-block; font-weight: bold; margin-right: 5px; cursor: pointer;}
.btn-save { background: var(--accent); color: #000; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer;}
.btn-close { background: transparent; border: none; color: #888; font-size: 24px; cursor: pointer; padding: 0; line-height: 1; }

/* --- SUB TABS --- */
.sub-nav-container { margin-bottom: 15px; }
.sub-nav { display: flex; justify-content: center; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
.sub-btn { background: none; border: 1px solid transparent; color: #888; padding: 6px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 14px; }
.sub-btn.active { background: var(--accent); color: #000; }

/* --- ATTRIBUTES IN MODAL --- */
.attr-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
.attr-row input { font-size: 13px; padding: 6px; }

/* --- SKILLS TABLE --- */
.skills-container { background: var(--panel); border-radius: 8px; overflow: hidden; }
#skillsTable th, #skillsTable td { padding: 8px 5px; border-bottom: 1px solid var(--border); text-align: center; }
#skillsTable th { background: #000; }
#skillsTable td:nth-child(2) { text-align: left; } 
#skillsTable input[type="number"] { max-width: 50px; padding: 4px; text-align: center; }
.trained-untrained { color: #ff4444; }
.trained-trained { color: #fff; }

/* --- FAB --- */
#summonFab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5); align-items: center; justify-content: center; cursor: pointer; z-index: 2500; font-size: 24px; color: #000; font-weight: bold; border: 2px solid #fff; display: none; }
#summonMenu { display: none; position: fixed; background: #222; border: 1px solid var(--accent); border-radius: 8px; width: 200px; z-index: 2499; overflow: hidden; flex-direction: column; }
#summonMenu.show { display: flex; }
.summon-opt { padding: 12px; border-bottom: 1px solid #333; color: #fff; cursor: pointer; text-align: left; background: none; border:none; }
.summon-opt.active { background: var(--accent); color: #000; font-weight: bold; }

/* --- IMAGE MODAL --- */
#imageModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3100; justify-content: center; align-items: center; flex-direction: column; padding: 10px; }
#imageModal img { max-width: 95vw; max-height: 85vh; border: 2px solid var(--accent); border-radius: 4px; object-fit: contain; }

.status-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #000; color: #888; font-size: 11px; padding: 4px 10px; text-align: right; border-top: 1px solid #333; z-index: 2000; display: flex; justify-content: space-between; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; display: inline-block; margin-right: 5px; }
.status-dot.live { background: #4caf50; box-shadow: 0 0 5px #4caf50; }

/* --- HEART MODAL (Mobile Only) --- */
#mobileHeartBtn { display: none; width: 100%; background: none; border: none; font-size: 40px; cursor: pointer; margin-bottom: 10px; animation: heartIdle 3s infinite ease-in-out; }
@keyframes heartIdle { 0%,100%{transform:scale(1);} 50%{transform:scale(1.1);} }

#heartModalContainer { display: block; }
#heartCloseBtn { display: none; font-size: 60px; cursor: pointer; margin-bottom: 20px; animation: heartGlow 1.5s infinite alternate; text-shadow: 0 0 20px red; }
@keyframes heartGlow { 
    from { transform: scale(1); text-shadow: 0 0 10px red; filter: brightness(1); } 
    to { transform: scale(1.2); text-shadow: 0 0 30px #ff0055, 0 0 50px red; filter: brightness(1.3); } 
}

/* --- MOBILE --- */
@media (max-width: 600px) {
  .nav-links { display: none; }
  #hamburgerBtn { display: block; }
  .tab-btn { font-size: 12px; padding: 12px 8px; }
  
  /* HEART MODAL ACTIVATION */
  #mobileHeartBtn { display: block; }
  #heartModalContainer { display: none; } /* Hidden by default on mobile */
  
  /* The Active Modal State */
  #heartModalContainer.active-heart-modal {
      display: flex;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); /* Transparent black background */
      backdrop-filter: blur(5px);
      z-index: 5000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
  }
  
  /* Show the close button inside modal */
  #heartModalContainer.active-heart-modal #heartCloseBtn { display: block; }

  /* Adjust inputs inside modal */
  #heartModalContainer.active-heart-modal .vital-row { width: 100%; margin-bottom: 20px; }
  #heartModalContainer.active-heart-modal .combat-stats { width: 100%; }

  /* 2x2 Grid for AC/Init/etc */
  .mobile-2col { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 5px !important; padding: 5px !important; }
  .mobile-2col .stat-box { flex-direction: column !important; justify-content: center !important; width: 100% !important; border-bottom: none !important; padding: 5px !important; background: #2a2a2a; border-radius: 4px; min-height: 50px; }
  .mobile-2col .stat-box label { text-align: center; width: 100%; font-size: 10px !important; margin-bottom: 2px !important; }
  .mobile-2col .stat-box input { width: 100% !important; font-size: 12px !important; text-align: center; height: 25px; }
  
  /* SAVES MOBILE LAYOUT (Stacked) */
  #savesContainer { grid-template-columns: 1fr !important; }
  #savesContainer .stat-box { flex-direction: row !important; justify-content: space-between; align-items: center; padding: 10px 15px; width: 100%; background: #2a2a2a; border-radius: 4px; min-height: auto; }
  #savesContainer label { width: auto !important; margin-bottom: 0 !important; font-size: 14px !important; text-align: left; }
  #savesContainer .stat-dual { width: auto !important; gap: 10px; }
  #savesContainer .stat-dual input { width: 50px !important; }
  
  /* Inline Inputs on Mobile */
  .inline-input-group input { width: 30px; font-size: 12px; }

  /* SKILLS MOBILE */
  #mobileSkillHeader { display: flex !important; justify-content: space-between; padding: 0 10px 5px 10px; }
  #skillsTable thead { display: none; } 
  #skillsTable tr { display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; margin-bottom: 8px; padding: 10px; border-radius: 6px; background: var(--panel); }
  #skillsTable td { border: none; padding: 0; }
  #skillsTable tr td:nth-child(1), #skillsTable tr td:nth-child(3) { display: none; }
  #skillsTable tr td:nth-child(2) { flex-basis: 45%; font-weight: bold; font-size: 15px; }
  #skillsTable tr td:nth-child(4) { display: flex; align-items: center; justify-content: flex-end; flex-basis: 35%; }
  #skillsTable tr td:nth-child(5) { flex-basis: 20%; text-align: right; font-size: 16px; }
}

/* NOTES SPECIFIC - REMOVE RESIZE & FIX VISUALS */
#notes { display: none; flex-direction: column; height: 100%; box-sizing: border-box; }
#notes.active { display: flex; }
#notesArea { flex-grow: 1; border: 1px solid var(--border); border-radius: 6px; background: #111; padding: 10px; font-family: sans-serif; line-height: 1.6; font-size: 16px; width: 100%; margin-bottom: 20px; }
</style>
</head>
<body>

<nav class="top-nav">
  <button id="hamburgerBtn" onclick="document.getElementById('mobileMenu').classList.toggle('show')">&#9776;</button>
  <a href="index.html" class="nav-brand">Mount Aetheria</a>
  <div class="nav-links">
    <a href="story.html">Story</a>
    <a href="tools.html">Tools</a>
    <a href="characters.html" class="active" style="color:var(--accent)">Sheet</a>
    <a href="discussions.html">Discussion</a>
    <a href="signin.html" id="authLink">Sign In</a>
  </div>
</nav>

<div id="mobileMenu">
  <a href="story.html">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html" style="color:var(--accent)">Character Sheet</a>
  <a href="discussions.html">Discussion</a>
  <a href="signin.html" id="mobileAuthLink">Sign In</a>
</div>

<div class="main-tabs">
  <button class="tab-btn active" id="btn-character" onclick="switchTab('character')">Character</button>
  <button class="tab-btn" id="btn-combat" onclick="switchTab('combat')">Combat</button>
  <button class="tab-btn" id="btn-skills" onclick="switchTab('skills')">Skills</button>
  <button class="tab-btn" id="btn-notes" onclick="switchTab('notes')">Notes</button>
  <button class="tab-btn" id="btn-items" onclick="switchTab('items')">Items</button>
</div>

<div id="character" class="tab-content active">
  <h2 id="sheetTitle">Character Bio</h2>
  <div class="bio-grid">
    <div class="bio-item"><label>Name</label><input id="charName" class="live-field"></div>
    <div class="bio-item"><label>Race</label><input id="race" class="live-field"></div>
    <div class="bio-item"><label>Class</label><input id="class" class="live-field"></div>
    <div class="bio-item"><label>Align</label><input id="alignment" class="live-field"></div>
    <div class="bio-item"><label>Size</label><input id="size" class="live-field"></div>
    <div class="bio-item"><label>Languages</label><input id="languages" class="live-field"></div>
    <div class="bio-item" style="grid-column: 1 / -1;"><label>Senses</label><input id="senses" class="live-field"></div>
  </div>
  <h3>Ability Scores</h3>
  <div style="background:var(--panel); border-radius:8px; overflow:hidden;">
    <table style="width:100%; border-collapse:collapse; text-align:center;">
        <tr style="background:#000; color:#888; font-size:12px;"><th>Stat</th><th>Score</th><th>Mod</th></tr>
        <script>
            ['str','dex','con','int','wis','cha'].forEach(s => {
                document.write(`<tr style="border-top:1px solid #333;"><td style="font-weight:bold; color:var(--accent); text-transform:uppercase;">${s}</td><td style="padding:8px;"><input type="number" id="${s}" class="live-field calc-trigger" style="text-align:center; background:#111; border:1px solid #444; color:#fff; border-radius:4px;"></td><td id="mod-${s}">+0</td></tr>`);
            });
        </script>
    </table>
  </div>
  <button class="btn-add" id="btnAddSummon" style="background:#444; color:#ccc; margin-top:20px;">+ Add Summoning</button>
  <button id="btnDeleteSummon" class="btn-del" style="background:#990000; width:100%; padding:12px; margin-top:20px; display:none;">Delete Summon</button>
</div>

<div id="combat" class="tab-content">
  
  <button id="mobileHeartBtn" onclick="toggleHeartStats()">‚ù§Ô∏è</button>

  <div id="heartModalContainer">
      <div id="heartCloseBtn" onclick="toggleHeartStats()">‚ù§Ô∏è</div>
      
      <div class="vital-row">
          <div class="vital-box">
              <label>‚ù§Ô∏è HP</label>
              <div class="vital-inputs">
                  <input id="hp_curr" class="live-field" placeholder="Cur">
                  <span>/</span>
                  <input id="hp_max" class="live-field" placeholder="Max">
              </div>
          </div>
          <div class="vital-box">
              <label>üíß MP</label>
              <div class="vital-inputs">
                  <input id="mp_curr" class="live-field" placeholder="Cur">
                  <span>/</span>
                  <input id="mp_max" class="live-field" placeholder="Max">
              </div>
          </div>
      </div>

      <div class="combat-stats mobile-2col">
        <div class="stat-box"><label>AC</label><input id="ac_total" class="live-field"></div>
        <div class="stat-box"><label>Initiative</label><input id="init_bonus" class="live-field"></div>
        <div class="stat-box"><label>BAB</label><input id="bab" class="live-field"></div>
        <div class="stat-box"><label>Speed</label><input id="speed" class="live-field"></div>
      </div>
  </div>
  <div class="sub-nav-container">
    <div class="sub-nav" id="combatSubNav">
        <button class="sub-btn active" onclick="switchSub('c-general')">General</button>
        <button class="sub-btn" id="abilitiesSubBtn" onclick="switchSub('c-abilities-main')">Abilities</button>
        <button class="sub-btn" id="spellsSubBtn" onclick="switchSub('c-spells')">Spells</button>
    </div>
  </div>
  
  <div id="c-general" class="sub-group active">
    <div class="combat-stats mobile-2col">
        <div class="stat-box"><label>CMB</label><input id="cmb" class="live-field"></div>
        <div class="stat-box"><label>CMD</label><input id="cmd_total" class="live-field"></div>
    </div>
    
    <div id="resistancesBox" style="background:var(--panel); padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid var(--border);">
        <label>Resist</label>
        <textarea id="resistances" class="live-field" placeholder="Resistances, Immunities, DR, SR"></textarea>
    </div>
    
    <h3>Saves</h3>
    <div id="savesContainer" class="combat-stats">
        <div class="stat-box"><label>Fortitude</label><div class="stat-dual"><input id="fort_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="fort_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
        <div class="stat-box"><label>Reflex</label><div class="stat-dual"><input id="ref_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="ref_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
        <div class="stat-box"><label>Will</label><div class="stat-dual"><input id="will_bonus" type="number" class="live-field calc-trigger" placeholder="Bonus"><span id="will_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
    </div>
    
    <h3>Weapons</h3>
    <div id="weaponList"></div>
    <button class="btn-add" onclick="addNewItem('weapon')">+ Add Weapon</button>
  </div>

  <div id="c-abilities-main" class="sub-group" style="display:none">
      <div class="sub-nav-container">
        <div class="sub-nav" id="abilitiesSubSubNav">
            <button class="sub-btn active" onclick="switchSubSub('a-active')">Active</button>
            <button class="sub-btn" id="btn-sub-passive" onclick="switchSubSub('a-passive')">Passive</button>
            <button class="sub-btn" onclick="switchSubSub('a-feats')">Feats</button>
        </div>
      </div>
      
      <div id="a-active" class="sub-sub-group active">
          <div id="activeList"></div>
          <button class="btn-add" onclick="addNewItem('active')">+ Add Active Ability</button>
      </div>

      <div id="a-passive" class="sub-sub-group" style="display:none">
          <div id="passiveList"></div>
          <button class="btn-add" onclick="addNewItem('passive')">+ Add Passive Ability</button>
      </div>

      <div id="a-feats" class="sub-sub-group" style="display:none">
          <div id="featList"></div>
          <button class="btn-add" onclick="addNewItem('feat')">+ Add Feat</button>
          <br><br>
          <div style="background:var(--panel); padding:10px; border-radius:8px; border:1px solid var(--border);">
            <label>Proficiencies</label>
            <textarea id="proficiencies" class="live-field"></textarea>
          </div>
      </div>
  </div>

  <div id="c-spells" class="sub-group" style="display:none">
      <h3>Spells</h3>
      <div class="stat-box" style="margin-bottom:10px;"><label>Spell DC Base</label><input id="spell_dc_base" class="live-field"></div>
      <div id="spellList"></div>
      <button class="btn-add" onclick="addNewItem('spell')">+ Add Spell</button>
  </div>
</div>

<div id="skills" class="tab-content">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><span>Skill Points Unused:</span><input id="skill_points" class="live-field" style="width:60px; text-align:center;"></div>
  <div id="mobileSkillHeader" style="display:none; color:#888; font-size:12px;"><span style="display:inline-block; width:45%;"></span><span style="display:inline-block; width:35%; text-align:right; padding-right: 5px;">RANKS</span><span style="display:inline-block; width:20%; text-align:right;">TOTAL</span></div>
  <div class="skills-container">
    <table id="skillsTable" style="width:100%; border-collapse:collapse; font-size:14px; text-align:center;">
        <thead><tr style="background:#000; color:var(--accent); font-weight:bold;"><th style="width:30px">CS</th><th style="text-align:left;">Skill Name</th><th style="width:40px">Mod</th><th style="width:50px">Ranks</th><th style="width:40px" id="skillHeaderTotal">Total</th></tr></thead>
        <tbody id="skillsTableBody"></tbody>
    </table>
  </div>
</div>

<div id="items" class="tab-content">
  <div class="combat-stats" style="grid-template-columns: 1fr 1fr;"><div class="stat-box"><label>üí∞ Gil</label><input id="currency_gil" class="live-field"></div><div class="stat-box"><label>Moogle Pts</label><input id="currency_moogle" class="live-field"></div></div>
  <div style="display:flex; gap:10px; margin-bottom:10px;">
    <select id="itemFilterTag" onchange="renderItems()" style="flex:1;">
      <option value="All">All Tags</option>
      <option value="Weapons">Weapons</option>
      <option value="Armor">Armor</option>
      <option value="Gear">Gear</option>
      <option value="Consumables">Consumables</option>
      <option value="Magic Items">Magic Items</option>
      <option value="Collections">Collections</option>
      <option value="Misc">Misc</option>
    </select>
    <select id="itemSort" onchange="renderItems()" style="flex:1;">
      <option value="recent">Recent</option>
      <option value="abc">A-Z</option>
    </select>
  </div>
  <div id="itemList"></div>
  <button class="btn-add" onclick="addNewItem('item')">+ Add Item</button>
</div>

<div id="notes" class="tab-content">
    <textarea id="notesArea" class="live-field" placeholder="Type your notes here..."></textarea>
</div>

<div id="summonMenu"></div>
<div id="summonFab">‚óé</div>

<div id="viewModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="viewTitle">Item Name</h3>
            <button class="btn-close" onclick="document.getElementById('viewModal').style.display='none'">&times;</button>
        </div>
        <div id="viewBody" class="modal-body">
            </div>
        <div style="padding:10px; text-align:right; border-top:1px solid #333;">
            <button class="btn-save" onclick="document.getElementById('viewModal').style.display='none'">Close</button>
        </div>
    </div>
</div>

<div id="editorModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Edit</h3>
            <div class="modal-actions">
                <a id="modalLinkBtn" href="#" target="_blank" class="btn-link" style="display:none">Link</a>
                <button class="btn-save" onclick="closeModal()">Done</button>
            </div>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div style="padding:15px; border-top:1px solid #333; background:#1a1a1a; border-radius:0 0 8px 8px;">
            <button id="modalDeleteBtn" class="btn-del" style="width:100%">Delete</button>
        </div>
    </div>
</div>

<div id="imageModal" onclick="this.style.display='none'">
  <img id="modalImg" src="">
  <button onclick="document.getElementById('imageModal').style.display='none'" style="margin-top:15px; padding:10px 20px; background:var(--accent); border:none; font-weight:bold; cursor:pointer;">Close</button>
</div>

<div class="status-bar"><span id="uidDisplay">Loading...</span><div><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting</span></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw", authDomain: "mount-aetheria.firebaseapp.com", projectId: "mount-aetheria", storageBucket: "mount-aetheria.firebasestorage.app", messagingSenderId: "492855693446", appId: "1:492855693446:web:f99485569254a7220c38107", measurementId: "G-0PF84KDN7L" };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let saveTimeout = null;
let isRemoteUpdate = false;
let fullData = { summons: [], items: [], weapons: [], spells: [], activeAbilities: [], passiveAbilities: [], feats: [] }; 
let currentSummonId = null; 

// --- TAB LOGIC ---
window.switchTab = (id) => { 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
    const btn = document.getElementById('btn-' + id);
    if(btn) btn.classList.add('active');
    document.getElementById(id).classList.add('active'); 
};
window.switchSub = (id) => { 
    const container = document.getElementById('combatSubNav');
    Array.from(container.children).forEach(b => b.classList.remove('active'));
    const targetBtn = Array.from(container.children).find(b => b.getAttribute('onclick').includes(id));
    if(targetBtn) targetBtn.classList.add('active');
    document.getElementById('combat').querySelectorAll('.sub-group').forEach(c => c.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    localStorage.setItem('activeCombatSub', id);
};
window.switchSubSub = (id) => {
    const container = document.getElementById('abilitiesSubSubNav');
    Array.from(container.children).forEach(b => b.classList.remove('active'));
    const targetBtn = Array.from(container.children).find(b => b.getAttribute('onclick').includes(id));
    if(targetBtn) targetBtn.classList.add('active');
    document.getElementById('c-abilities-main').querySelectorAll('.sub-sub-group').forEach(c => c.style.display = 'none');
    document.getElementById(id).style.display = 'block'; 
    localStorage.setItem('activeAbilSub', id);
};

// --- AUTH & SYNC ---
onAuthStateChanged(auth, (user) => {
    if(user){
        currentUser = user;
        document.getElementById('uidDisplay').textContent = user.email;
        document.getElementById('authLink').textContent = "My Account"; document.getElementById('authLink').href = "account.html";
        document.getElementById('mobileAuthLink').textContent = "My Account"; document.getElementById('mobileAuthLink').href = "account.html";
        initSkills();
        startSync();
    } else {
        window.location.href = "signin.html";
    }
});

function startSync() {
    const docRef = doc(db, 'users', currentUser.uid, 'sheet', 'character');
    onSnapshot(docRef, (snap) => {
        if(snap.metadata.hasPendingWrites) return;
        if(snap.exists()) {
            document.getElementById('statusDot').classList.add('live');
            document.getElementById('statusText').textContent = "Live Sync";
            const remote = snap.data();
            fullData = { summons: [], items: [], weapons: [], spells: [], activeAbilities: [], passiveAbilities: [], feats: [], ...remote };
            isRemoteUpdate = true;
            loadCurrentSheet();
            updateSummonMenu();
            isRemoteUpdate = false;
        }
    });
}

function getActiveData() {
    if(currentSummonId) {
        return fullData.summons.find(s => s.id === currentSummonId) || {};
    }
    return fullData;
}

// --- LOAD SHEET ---
function loadCurrentSheet() {
    const data = getActiveData();

    if(currentSummonId) {
        document.getElementById('sheetTitle').textContent = "Summoning Sheet";
        document.getElementById('btnAddSummon').style.display = 'none';
        document.getElementById('btnDeleteSummon').style.display = 'block';
        document.getElementById('btnDeleteSummon').onclick = deleteCurrentSummon;
        ['btn-skills','btn-items'].forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById('spellsSubBtn').style.display = 'none';
        document.getElementById('btn-sub-passive').style.display = 'none';
    } else {
        document.getElementById('sheetTitle').textContent = "Character Sheet";
        document.getElementById('btnAddSummon').style.display = 'block';
        document.getElementById('btnAddSummon').onclick = createNewSummon;
        document.getElementById('btnDeleteSummon').style.display = 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.style.display = '');
        document.getElementById('spellsSubBtn').style.display = 'block';
        document.getElementById('btn-sub-passive').style.display = 'block';
    }
    
    const savedCombatSub = localStorage.getItem('activeCombatSub') || 'c-general';
    const savedAbilSub = localStorage.getItem('activeAbilSub') || 'a-active';
    switchSub(savedCombatSub);
    switchSubSub(savedAbilSub);

    document.querySelectorAll('.live-field').forEach(el => {
        el.value = (data[el.id] !== undefined) ? data[el.id] : "";
    });
    
    // Auto-expand global textareas
    document.querySelectorAll('textarea.live-field').forEach(tx => {
       autoExpand(tx);
       tx.addEventListener('input', () => autoExpand(tx));
    });
    
    renderWeapons();
    renderSpells();
    renderAbilities('active');
    renderAbilities('passive');
    renderAbilities('feat');
    renderItems();
    
    if(data.skills) {
        const rows = document.querySelectorAll('#skillsTableBody tr');
        rows.forEach(r => { r.querySelector('.skill-cs').checked = false; r.querySelector('.skill-ranks').value = ""; });
        data.skills.forEach((s, i) => { if(rows[i]) { rows[i].querySelector('.skill-cs').checked = s.cs; rows[i].querySelector('.skill-ranks').value = s.lvl; } });
    }
    updateCalcs();
}

function autoExpand(el) {
    el.style.height = 'auto';
    el.style.height = (el.scrollHeight + 5) + 'px';
}

// --- RENDERING LISTS ---
const listContainerIds = {
    weapon: 'weaponList',
    spell: 'spellList',
    active: 'activeList',
    passive: 'passiveList',
    feat: 'featList',
    item: 'itemList'
};

function createListRow(containerId, title, meta, type, index, onViewClick, onEditClick) {
    const container = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = 'list-row';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'row-content';
    contentDiv.innerHTML = `<span class="list-row-title">${title}</span><span class="list-row-meta">${meta}</span>`;
    contentDiv.onclick = onViewClick;

    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'row-actions';
    const editBtn = document.createElement('button');
    editBtn.className = 'btn-edit';
    editBtn.textContent = 'Edit';
    editBtn.onclick = (e) => { e.stopPropagation(); onEditClick(); };

    div.appendChild(contentDiv);
    div.appendChild(actionsDiv);
    actionsDiv.appendChild(editBtn);
    container.appendChild(div);
}

window.openView = (type, index) => {
    const data = getActiveData();
    let collectionName = '';
    if(type === 'active') collectionName = 'activeAbilities';
    else if(type === 'passive') collectionName = 'passiveAbilities';
    else if(type === 'feat') collectionName = 'feats';
    else collectionName = type + 's';
    
    const item = data[collectionName][index];
    populateViewModal(type, item);
};

window.openEditor = (type, index) => {
    const data = getActiveData();
    let collectionName = '';
    if(type === 'active') collectionName = 'activeAbilities';
    else if(type === 'passive') collectionName = 'passiveAbilities';
    else if(type === 'feat') collectionName = 'feats';
    else collectionName = type + 's';
    
    const item = data[collectionName][index];
    populateEditorModal(type, item, index, collectionName);
};

function renderWeapons() {
    const data = getActiveData().weapons || [];
    document.getElementById('weaponList').innerHTML = '';
    data.forEach((w, i) => {
        createListRow('weaponList', w.name||'New Weapon', w.mod||'', 'weapon', i, 
            () => openView('weapon', i), 
            () => openEditor('weapon', i)
        );
    });
}

function renderSpells() {
    const data = getActiveData().spells || [];
    const sorted = [...data].sort((a,b) => {
        const map = { "Cantrip": 0, "1st": 1, "2nd": 2, "3rd": 3, "4th": 4, "5th": 5, "6th": 6, "7th": 7, "8th": 8, "9th": 9 };
        return (map[a.lvl] || 0) - (map[b.lvl] || 0);
    });
    
    const container = document.getElementById('spellList');
    container.innerHTML = '';

    sorted.forEach((s) => {
        const originalIndex = data.indexOf(s);
        const div = document.createElement('div');
        div.className = 'list-row';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'row-content';
        contentDiv.innerHTML = `<span class="list-row-title">[${s.lvl || '-'}] ${s.name || 'New Spell'}</span>`;
        contentDiv.onclick = () => openView('spell', originalIndex);

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'row-actions';
        
        // Add Link Button if exists
        if(s.link) {
            const linkBtn = document.createElement('a');
            linkBtn.className = 'btn-link-small';
            linkBtn.href = s.link;
            linkBtn.target = "_blank";
            linkBtn.textContent = "Link";
            linkBtn.onclick = (e) => e.stopPropagation();
            actionsDiv.appendChild(linkBtn);
        }

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-edit';
        editBtn.textContent = 'Edit';
        editBtn.onclick = (e) => { e.stopPropagation(); openEditor('spell', originalIndex); };
        
        div.appendChild(contentDiv);
        div.appendChild(actionsDiv);
        actionsDiv.appendChild(editBtn);
        container.appendChild(div);
    });
}

// UPDATED: Active Ability Render Logic
function renderAbilities(subType) {
    let prop = 'activeAbilities';
    if(subType === 'passive') prop = 'passiveAbilities';
    if(subType === 'feat') prop = 'feats';
    
    const data = getActiveData()[prop] || [];
    const container = document.getElementById(listContainerIds[subType]);
    container.innerHTML = '';

    data.forEach((a, i) => {
        const div = document.createElement('div');
        div.className = 'list-row';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'row-content';
        
        if(subType === 'active') {
            // New Active Layout: Name | Type
            contentDiv.classList.add('active-ability-layout');
            contentDiv.innerHTML = `<span class="active-name">${a.name||'New Ability'}</span><span class="active-type">${a.type||''}</span>`;
        } else {
            contentDiv.innerHTML = `<span class="list-row-title">${a.name||`New ${subType}`}</span>`;
        }
        
        contentDiv.onclick = () => openView(subType, i);

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'row-actions';
        actionsDiv.style.display = 'flex';
        actionsDiv.style.alignItems = 'center';

        // INJECT INPUTS for Active Abilities
        if(subType === 'active') {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'inline-input-group';
            
            const iCur = document.createElement('input');
            iCur.type = 'number';
            iCur.value = a.u_curr || 0;
            iCur.onclick = (e) => e.stopPropagation(); 
            iCur.onchange = (e) => { 
                a.u_curr = Number(e.target.value); 
                saveDataOnly(); 
            };

            const sep = document.createElement('span');
            sep.textContent = '/';

            const iMax = document.createElement('input');
            iMax.type = 'number';
            iMax.value = a.u_max || 0;
            iMax.onclick = (e) => e.stopPropagation();
            iMax.onchange = (e) => { 
                a.u_max = Number(e.target.value); 
                saveDataOnly(); 
            };

            inputGroup.appendChild(iCur);
            inputGroup.appendChild(sep);
            inputGroup.appendChild(iMax);
            actionsDiv.appendChild(inputGroup);
        }

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-edit';
        editBtn.textContent = 'Edit';
        editBtn.onclick = (e) => { e.stopPropagation(); openEditor(subType, i); };

        div.appendChild(contentDiv);
        div.appendChild(actionsDiv);
        actionsDiv.appendChild(editBtn);
        container.appendChild(div);
    });
}

window.renderItems = () => {
    const data = getActiveData().items || [];
    const container = document.getElementById('itemList');
    container.innerHTML = '';
    
    const tagFilter = document.getElementById('itemFilterTag').value;
    const sortType = document.getElementById('itemSort').value;
    
    let filtered = data.filter(i => tagFilter === "All" || i.tags === tagFilter);
    if(sortType === "abc") filtered.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    else filtered.reverse();

    filtered.forEach(item => {
        const originalIndex = data.indexOf(item);
        
        const div = document.createElement('div');
        div.className = 'list-row';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'row-content';
        contentDiv.innerHTML = `<span class="list-row-title">${item.name || 'New Item'} <small style="color:#888; font-weight:normal">(${item.tags})</small></span>`;
        contentDiv.onclick = () => openView('item', originalIndex);

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'row-actions';
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '5px';

        if(item.tags === "Collections" && item.img) {
            const imgBtn = document.createElement('button');
            imgBtn.className = 'btn-save';
            imgBtn.style.fontSize = "10px"; imgBtn.style.padding = "4px 8px";
            imgBtn.textContent = "IMG";
            imgBtn.onclick = (e) => { e.stopPropagation(); viewCollection(item.img); };
            actionsDiv.appendChild(imgBtn);
        }

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-edit';
        editBtn.textContent = 'Edit';
        editBtn.onclick = (e) => { e.stopPropagation(); openEditor('item', originalIndex); };
        actionsDiv.appendChild(editBtn);

        div.appendChild(contentDiv);
        div.appendChild(actionsDiv);
        container.appendChild(div);
    });
};

// --- VIEW MODAL LOGIC (READ ONLY) ---
function populateViewModal(type, item) {
    const title = document.getElementById('viewTitle');
    const body = document.getElementById('viewBody');
    body.innerHTML = '';
    title.textContent = item.name || "Unnamed";
    document.getElementById('viewModal').style.display = 'flex';

    const addLine = (label, text) => {
        if(!text) return;
        const l = document.createElement('div'); l.className = 'view-label'; l.textContent = label;
        const t = document.createElement('div'); t.className = 'view-text'; t.textContent = text;
        body.appendChild(l); body.appendChild(t);
    };

    if(type === 'weapon') {
        // Removed Modifier display as requested
        if(item.attrs && item.attrs.length > 0) {
            const l = document.createElement('div'); l.className = 'view-label'; l.textContent = "Attributes"; body.appendChild(l);
            const d = document.createElement('div'); d.style.marginBottom = "10px";
            // Attributes each on their own line
            item.attrs.forEach(a => {
                const s = document.createElement('div'); s.className = 'view-attr-block';
                s.textContent = `${a.name}: ${a.val}`;
                d.appendChild(s);
            });
            body.appendChild(d);
        }
    }
    
    if(type === 'spell') {
        addLine("Level", item.lvl);
        if(item.link) {
            const btn = document.createElement('a'); btn.href = item.link; btn.target = "_blank";  btn.style.marginBottom = "15px";
            body.appendChild(btn);
        }
    }
    
    if(type === 'active') {
        // Removed Type and Uses from popup as requested (now in row)
        // Only showing Description
    }
    
    if(type === 'feat' && item.link) {
         const btn = document.createElement('a'); btn.href = item.link; btn.target = "_blank"; btn.className = "btn-link"; btn.textContent = "View Feat Source"; btn.style.marginBottom = "15px";
         body.appendChild(btn);
    }
    
    if(type === 'item') {
        if(item.tags) addLine("Type", item.tags);
        if(item.cost) addLine("Cost", item.cost);
    }

    if(item.desc) addLine("Description", item.desc);
}

// --- EDITOR MODAL LOGIC ---
const modal = document.getElementById('editorModal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
const modalDelBtn = document.getElementById('modalDeleteBtn');
const modalLinkBtn = document.getElementById('modalLinkBtn');
let currentEditContext = null; 

function populateEditorModal(type, item, index, collectionName) {
    currentEditContext = { type, index, collectionName };
    modalTitle.textContent = "Edit " + (type.charAt(0).toUpperCase() + type.slice(1));
    modalBody.innerHTML = '';
    modalLinkBtn.style.display = 'none';

    if((type === 'spell' || type === 'feat') && item.link) {
        modalLinkBtn.href = item.link;
        modalLinkBtn.style.display = 'inline-block';
    }

    createInput('Name', item.name, 'name');

    if(type === 'weapon') {
        createSelect('Modifier', item.mod, 'mod', ['STR','DEX','CON','INT','WIS','CHA']);
        const attrLabel = document.createElement('label'); attrLabel.textContent = "Attributes"; modalBody.appendChild(attrLabel);
        const attrCont = document.createElement('div'); attrCont.id = 'modalAttrCont';
        modalBody.appendChild(attrCont);
        (item.attrs || []).forEach((a, ai) => addAttrRow(attrCont, a, ai));
        const addAttrBtn = document.createElement('button');
        addAttrBtn.className = 'btn-add'; addAttrBtn.textContent = "+ Add Attribute";
        addAttrBtn.style.fontSize = "12px"; addAttrBtn.style.padding = "5px";
        addAttrBtn.onclick = () => {
            if(!item.attrs) item.attrs = [];
            item.attrs.push({name:'', val:''});
            addAttrRow(attrCont, item.attrs[item.attrs.length-1], item.attrs.length-1);
            saveDataOnly(); 
        };
        modalBody.appendChild(addAttrBtn);
    }
    
    if(type === 'spell') {
        createSelect('Level', item.lvl, 'lvl', ["Cantrip","1st","2nd","3rd","4th","5th","6th","7th","8th","9th"]);
        createInput('Link URL', item.link, 'link');
    }
    
    if(type === 'active') {
        createSelect('Type', item.type, 'type', ["Standard","Move","Swift","Full","Free","Immediate","Reaction"]);
        // Split Uses Inputs
        const usesLabel = document.createElement('label'); usesLabel.textContent = "Uses (Current / Max)"; modalBody.appendChild(usesLabel);
        const usesRow = document.createElement('div'); usesRow.style.display = "flex"; usesRow.style.gap = "5px";
        
        const uCurr = document.createElement('input'); uCurr.type = "number"; uCurr.placeholder = "Curr"; uCurr.value = item.u_curr || 0;
        const uMax = document.createElement('input'); uMax.type = "number"; uMax.placeholder = "Max"; uMax.value = item.u_max || 0;
        
        uCurr.oninput = (e) => { updateCurrentItem('u_curr', e.target.value); };
        uMax.oninput = (e) => { updateCurrentItem('u_max', e.target.value); };
        
        usesRow.appendChild(uCurr); usesRow.appendChild(uMax);
        modalBody.appendChild(usesRow);
    }
    
    if(type === 'feat') {
        createInput('Link URL', item.link, 'link');
    }
    
    if(type === 'item') {
        if(item.tags === 'Collections') {
             const lbl = document.createElement('label'); lbl.textContent = "Tag"; modalBody.appendChild(lbl);
             const inp = document.createElement('input'); inp.value = "Collections"; inp.disabled = true; modalBody.appendChild(inp);
             if(item.img) createInput('Image URL', item.img, 'img');
        } else {
             createSelect('Tag', item.tags, 'tags', ["Weapons", "Armor", "Gear", "Consumables", "Magic Items", "Misc"]);
        }
        createInput('Cost', item.cost, 'cost');
    }

    createTextArea('Description', item.desc, 'desc');

    modalDelBtn.onclick = () => {
        const data = getActiveData();
        data[collectionName].splice(index, 1);
        saveDataOnly();
        closeModal();
    };

    modal.style.display = 'flex';
}

function createInput(label, value, key) {
    const lbl = document.createElement('label'); lbl.textContent = label;
    const inp = document.createElement('input'); 
    inp.value = value || ''; 
    inp.oninput = (e) => { updateCurrentItem(key, e.target.value); };
    modalBody.appendChild(lbl); modalBody.appendChild(inp);
}

function createTextArea(label, value, key) {
    const lbl = document.createElement('label'); lbl.textContent = label;
    const txt = document.createElement('textarea'); 
    txt.value = value || ''; 
    setTimeout(() => autoExpand(txt), 0);
    txt.oninput = (e) => { 
        autoExpand(txt);
        updateCurrentItem(key, e.target.value); 
    };
    modalBody.appendChild(lbl); modalBody.appendChild(txt);
}

function createSelect(label, value, key, options) {
    const lbl = document.createElement('label'); lbl.textContent = label;
    const sel = document.createElement('select');
    options.forEach(o => {
        const opt = document.createElement('option'); opt.text = o; opt.value = o;
        if(o === value) opt.selected = true;
        sel.appendChild(opt);
    });
    sel.onchange = (e) => { updateCurrentItem(key, e.target.value); };
    modalBody.appendChild(lbl); modalBody.appendChild(sel);
}

function addAttrRow(container, attrData, index) {
    const row = document.createElement('div'); row.className = 'attr-row';
    const n = document.createElement('input'); n.placeholder = "Attr"; n.value = attrData.name || '';
    const v = document.createElement('input'); v.placeholder = "Val"; v.value = attrData.val || '';
    const del = document.createElement('button'); del.className = 'btn-del'; del.textContent = 'x';
    
    n.oninput = (e) => { attrData.name = e.target.value; saveDataOnly(); };
    v.oninput = (e) => { attrData.val = e.target.value; saveDataOnly(); };
    del.onclick = () => {
        const data = getActiveData();
        const realItem = data.weapons[currentEditContext.index];
        realItem.attrs.splice(index, 1);
        row.remove();
        saveDataOnly();
    };
    
    row.appendChild(n); row.appendChild(v); row.appendChild(del);
    container.appendChild(row);
}

function updateCurrentItem(key, value) {
    const data = getActiveData();
    const item = data[currentEditContext.collectionName][currentEditContext.index];
    item[key] = value;
    
    if(key === 'link') {
        modalLinkBtn.href = value;
        modalLinkBtn.style.display = value ? 'inline-block' : 'none';
    }
    
    // Refresh List if critical info changed
    if(key === 'name' || key === 'lvl' || key === 'tags' || key === 'type' || key === 'u_curr' || key === 'u_max') {
        refreshList(currentEditContext.type);
    }
    
    saveDataOnly();
}

window.closeModal = () => {
    modal.style.display = 'none';
    refreshList(currentEditContext.type); 
};

function refreshList(type) {
    if(type === 'weapon') renderWeapons();
    else if(type === 'spell') renderSpells();
    else if(type === 'item') renderItems();
    else renderAbilities(type);
}

window.addNewItem = (type) => {
    const data = getActiveData();
    let newItem = { name: '' };
    let collectionName = '';
    
    if(type === 'weapon') { collectionName = 'weapons'; newItem.mod = 'STR'; newItem.attrs=[]; }
    else if(type === 'spell') { collectionName = 'spells'; newItem.lvl = 'Cantrip'; }
    else if(type === 'active') { collectionName = 'activeAbilities'; newItem.type = 'Standard'; newItem.u_curr=0; newItem.u_max=0; }
    else if(type === 'passive') { collectionName = 'passiveAbilities'; }
    else if(type === 'feat') { collectionName = 'feats'; }
    else if(type === 'item') { collectionName = 'items'; newItem.tags = 'Misc'; }
    
    if(!data[collectionName]) data[collectionName] = [];
    data[collectionName].push(newItem);
    
    const newIndex = data[collectionName].length - 1;
    saveDataOnly(); 
    refreshList(type);
    openEditor(type, newIndex);
};

// --- SAVING ---
function scrapeCurrentSheet() {
    const payload = {};
    document.querySelectorAll('.live-field').forEach(el => payload[el.id] = el.value);
    
    payload.skills = [];
    document.querySelectorAll('#skillsTableBody tr').forEach(r => { 
        payload.skills.push({ cs: r.querySelector('.skill-cs').checked, lvl: Number(r.querySelector('.skill-ranks').value)||0 }); 
    });
    
    const activeMemory = getActiveData();
    payload.weapons = activeMemory.weapons || [];
    payload.spells = activeMemory.spells || [];
    payload.activeAbilities = activeMemory.activeAbilities || [];
    payload.passiveAbilities = activeMemory.passiveAbilities || [];
    payload.feats = activeMemory.feats || [];
    
    if(currentSummonId) payload.items = activeMemory.items || [];
    else payload.items = fullData.items || []; 

    return payload;
}

function saveDataOnly() {
    save();
}

function save(force = false) {
    if(isRemoteUpdate && !force) return;
    document.getElementById('statusDot').className = 'status-dot'; 
    clearTimeout(saveTimeout);
    
    saveTimeout = setTimeout(async () => {
        const currentSheetData = scrapeCurrentSheet();
        if(currentSummonId) {
            currentSheetData.id = currentSummonId;
            const index = fullData.summons.findIndex(s => s.id === currentSummonId);
            if(index >= 0) fullData.summons[index] = currentSheetData;
        } else {
            const summonsBackup = fullData.summons;
            fullData = { ...currentSheetData, summons: summonsBackup, items: currentSheetData.items };
        }
        await setDoc(doc(db,'users',currentUser.uid,'sheet','character'), fullData);
        document.getElementById('statusDot').classList.add('live');
        if(!force) updateSummonMenu(); 
    }, 1000);
}

// --- SUMMON & UTILS ---
window.createNewSummon = async () => {
    const newId = 'sum_' + Date.now();
    const template = { id: newId, charName: 'New Summon', summons: [] }; 
    if(!fullData.summons) fullData.summons = [];
    fullData.summons.push(template);
    currentSummonId = newId;
    save(true);
    loadCurrentSheet();
    updateSummonMenu();
}
window.deleteCurrentSummon = async () => {
    if(!confirm("Are you sure you want to delete this Summon sheet?")) return;
    fullData.summons = fullData.summons.filter(s => s.id !== currentSummonId);
    currentSummonId = null;
    save(true);
    loadCurrentSheet();
    updateSummonMenu();
}
function updateSummonMenu() {
    const fab = document.getElementById('summonFab');
    if(fullData.summons && fullData.summons.length > 0) { fab.style.display = 'flex'; } else { fab.style.display = 'none'; document.getElementById('summonMenu').classList.remove('show'); }
    const menuEl = document.getElementById('summonMenu');
    menuEl.innerHTML = '';
    const mainBtn = document.createElement('button');
    mainBtn.className = `summon-opt ${currentSummonId === null ? 'active' : ''}`;
    mainBtn.textContent = fullData.charName || "Main Character";
    mainBtn.onclick = () => { currentSummonId = null; loadCurrentSheet(); menuEl.classList.remove('show'); };
    menuEl.appendChild(mainBtn);
    fullData.summons.forEach(s => {
        const btn = document.createElement('button');
        btn.className = `summon-opt ${currentSummonId === s.id ? 'active' : ''}`;
        btn.textContent = s.charName || "Unnamed Summon";
        btn.onclick = () => { currentSummonId = s.id; loadCurrentSheet(); menuEl.classList.remove('show'); };
        menuEl.appendChild(btn);
    });
}

const fab = document.getElementById('summonFab');
const menu = document.getElementById('summonMenu');
fab.onclick = (e) => {
    if(fab.dataset.dragging === "true") return;
    const rect = fab.getBoundingClientRect();
    const menuWidth = 200; const menuHeight = 250;
    const spaceBelow = window.innerHeight - rect.bottom;
    const spaceAbove = rect.top;
    menu.style.bottom = 'auto'; menu.style.top = 'auto';
    if (spaceBelow >= menuHeight || spaceBelow > spaceAbove) { menu.style.top = (rect.bottom + 10) + 'px'; } else { menu.style.bottom = (window.innerHeight - rect.top + 10) + 'px'; }
    const spaceRight = window.innerWidth - rect.right;
    menu.style.left = 'auto'; menu.style.right = 'auto';
    if (spaceRight >= menuWidth) { menu.style.left = rect.left + 'px'; } else { 
        let newRight = (window.innerWidth - rect.right);
        newRight = Math.min(newRight, window.innerWidth - menuWidth - 10);
        menu.style.right = newRight + 'px';
    }
    menu.classList.toggle('show');
};
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
const startDrag = (e) => {
    isDragging = true; fab.dataset.dragging = "false";
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const rect = fab.getBoundingClientRect();
    dragOffset.x = clientX - rect.left; dragOffset.y = clientY - rect.top;
    document.addEventListener('mousemove', onDrag); document.addEventListener('touchmove', onDrag, {passive: false});
    document.addEventListener('mouseup', endDrag); document.addEventListener('touchend', endDrag);
};
const onDrag = (e) => {
    if(!isDragging) return;
    e.preventDefault(); fab.dataset.dragging = "true";
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    let newX = clientX - dragOffset.x; let newY = clientY - dragOffset.y;
    newX = Math.max(0, Math.min(window.innerWidth - fab.offsetWidth, newX));
    newY = Math.max(0, Math.min(window.innerHeight - fab.offsetHeight, newY));
    fab.style.left = newX + 'px'; fab.style.top = newY + 'px';
};
const endDrag = () => {
    isDragging = false;
    document.removeEventListener('mousemove', onDrag); document.removeEventListener('touchmove', onDrag);
    document.removeEventListener('mouseup', endDrag); document.removeEventListener('touchend', endDrag);
};
fab.addEventListener('mousedown', startDrag);
fab.addEventListener('touchstart', startDrag, {passive: false});

const SKILLS_DB = [{n:"Acrobatics",s:"dex"}, {n:"Appraise",s:"int"}, {n:"Bluff",s:"cha"}, {n:"Climb",s:"str"}, {n:"Diplomacy",s:"cha"}, {n:"Disable Device",s:"dex"}, {n:"Disguise",s:"cha"}, {n:"Escape Artist",s:"dex"}, {n:"Fly",s:"dex"}, {n:"Handle Animal",s:"cha"}, {n:"Heal",s:"wis"}, {n:"Intimidate",s:"cha"}, {n:"Knw: Arcana",s:"int"}, {n:"Knw: Dungeoneering",s:"int"}, {n:"Knw: Engineering",s:"int"}, {n:"Knw: Geography",s:"int"}, {n:"Knw: History",s:"int"}, {n:"Knw: Local",s:"int"}, {n:"Knw: Nature",s:"int"}, {n:"Knw: Nobility",s:"int"}, {n:"Knw: Planes",s:"int"}, {n:"Knw: Religion",s:"int"}, {n:"Linguistics",s:"int"}, {n:"Perception",s:"wis"}, {n:"Profession",s:"wis"}, {n:"Ride",s:"dex"}, {n:"Sense Motive",s:"wis"}, {n:"Sleight of Hand",s:"dex"}, {n:"Spellcraft",s:"int"}, {n:"Stealth",s:"dex"}, {n:"Survival",s:"wis"}, {n:"Swim",s:"str"}, {n:"Use Magic Device",s:"cha"}];
const TRAINED_ONLY = ["Disable Device", "Handle Animal", "Knw: Arcana", "Knw: Dungeoneering", "Knw: Engineering", "Knw: Geography", "Knw: History", "Knw: Local", "Knw: Nature", "Knw: Nobility", "Knw: Planes", "Knw: Religion", "Linguistics", "Profession", "Use Magic Device"];
function initSkills() {
    const cont = document.getElementById('skillsTableBody'); cont.innerHTML = '';
    SKILLS_DB.forEach(s => {
        const tr = document.createElement('tr'); tr.className = 'skill-row-data'; tr.dataset.stat = s.s;
        tr.innerHTML = `<td><input type="checkbox" class="skill-cs"></td><td style="text-align:left; font-weight:bold;" class="skill-name-cell">${s.n} <small style="color:#888; font-weight:normal;">(${s.s})</small></td><td class="skill-mod">0</td><td><input type="number" class="skill-ranks" style="width:40px; text-align:center; background:var(--input-bg); border:1px solid var(--border); padding:4px; border-radius:3px;"></td><td class="skill-total" style="color:var(--accent); font-weight:bold;">0</td>`;
        cont.appendChild(tr); tr.querySelectorAll('input').forEach(i => i.addEventListener('input', () => { updateCalcs(); save(); }));
    });
}
function getMod(id) { const v = document.getElementById(id).value; return v ? Math.floor((v-10)/2) : 0; }
function updateCalcs() {
    ['str','dex','con','int','wis','cha'].forEach(s => { const m = getMod(s); document.getElementById('mod-'+s).textContent = (m>=0?'+':'')+m; });
    const con = getMod('con'), dex = getMod('dex'), wis = getMod('wis');
    const f = (Number(document.getElementById('fort_bonus').value)||0) + con;
    const r = (Number(document.getElementById('ref_bonus').value)||0) + dex;
    const w = (Number(document.getElementById('will_bonus').value)||0) + wis;
    document.getElementById('fort_total').textContent = (f>=0?'+':'')+f; document.getElementById('ref_total').textContent = (r>=0?'+':'')+r; document.getElementById('will_total').textContent = (w>=0?'+':'')+w;
    document.querySelectorAll('#skillsTableBody tr').forEach(row => {
        const mod = getMod(row.dataset.stat); const ranks = Number(row.querySelector('.skill-ranks').value)||0; const cs = row.querySelector('.skill-cs').checked;
        const total = mod + ranks + (cs && ranks>0 ? 3 : 0); row.querySelector('.skill-mod').textContent = mod; row.querySelector('.skill-total').textContent = (total>=0?'+':'')+total;
        const skillName = row.querySelector('.skill-name-cell').textContent.split(' (')[0].trim();
        const nameCell = row.querySelector('.skill-name-cell');
        if(TRAINED_ONLY.includes(skillName)) {
            if(ranks < 1) { nameCell.classList.add('trained-untrained'); nameCell.classList.remove('trained-trained'); } 
            else { nameCell.classList.remove('trained-untrained'); nameCell.classList.add('trained-trained'); }
        }
    });
}

// --- TOGGLE HEART MODAL (Mobile) ---
window.toggleHeartStats = () => {
    const container = document.getElementById('heartModalContainer');
    container.classList.toggle('active-heart-modal');
};

window.viewCollection = (url) => { document.getElementById('modalImg').src = url; document.getElementById('imageModal').style.display = 'flex'; };
document.body.addEventListener('input', e => { if(e.target.classList.contains('live-field')) { updateCalcs(); save(); } });
</script>
</body>
</html>