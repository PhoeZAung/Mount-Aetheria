<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mount Aetheria - Story</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(to bottom,#222,#444);display:flex;flex-direction:column;height:100vh;overflow:hidden}

/* NAV STYLES */
.top-nav{width:100%;background:#111;padding:15px 20px;display:flex;justify-content:space-around;align-items:center;position:fixed;top:0;left:0;z-index:2000;}
.top-nav a{color:#fff;text-decoration:none;font-size:18px;font-weight:600;font-family:'Uncial Antiqua',serif}
.top-nav a:hover{color:#ffcc66}
#hamburger{display:none;position:fixed;top:15px;left:15px;background:#111;color:#fff;border:none;padding:10px;font-size:24px;cursor:pointer;z-index:2001;border-radius:5px;}
#navMenu{display:none;flex-direction:column;background:#111;position:fixed;top:60px;left:15px;border-radius:8px;z-index:2000;box-shadow:0 5px 15px rgba(0,0,0,0.8);overflow:hidden;}
#navMenu a{padding:12px 20px;color:#fff;text-decoration:none;border-bottom:1px solid #333;font-family:'Uncial Antiqua',serif;display:block;}

/* LAYOUT */
.content-wrapper { display: flex; height: 100%; padding-top: 60px; }
.sidebar{width:220px;background:#181818;padding:20px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;border-right:1px solid #333;}
.sidebar h3{color:#ffcc66;text-align:center;margin:10px 0;font-family:'Uncial Antiqua',serif;position:relative;}

/* FILTERS */
.filter-btn{background:#333;color:#fff;border:none;padding:10px;cursor:pointer;border-radius:8px;width:100%;margin-bottom:5px;text-align:left;font-weight:bold;transition:0.2s;}
.filter-btn:hover,.filter-btn.active{background:#ffcc66;color:#111;}

/* Mobile Header for Primary Tags */
.mobile-primary-header { display: none; justify-content: center; align-items: center; gap: 10px; margin-bottom: 5px; width: 100%; position: relative;}
#primaryHamburger { background:#111; color:#ffcc66; border:1px solid #333; padding:5px 10px; font-size:18px; cursor:pointer; border-radius:5px; }
#currentPrimaryLabel { font-family: 'Uncial Antiqua', serif; color: #ffcc66; font-size: 18px; }

#secondary-tags { display: flex; flex-direction: column; gap: 5px; }

/* MAIN CONTENT */
.main-content{flex:1;overflow-y:auto;padding:20px;}
.controls-bar { display: flex; justify-content: flex-end; margin-bottom: 15px; }
.sort-select { padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }

/* STORY CARD */
.story-entry{background:#2b2b2b;color:#fff;border-radius:12px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,0.5);border:1px solid #444; cursor: pointer; transition: transform 0.2s;}
.story-entry:hover { transform: translateY(-3px); border-color: #ffcc66; }
.story-header { padding:15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;}
.story-title { font-family:'Uncial Antiqua',serif; color:#ffcc66; font-size: 18px; margin: 0; }
.story-meta { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; justify-content: flex-end; }
.story-cat { font-size:12px; color:#888; }
.sec-tag { font-size:11px; background:#444; padding:2px 6px; border-radius:4px; }

/* MODAL POPUP */
#storyModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
.modal-content { background: #222; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 12px; border: 1px solid #ffcc66; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.8); position: relative; }
.modal-header { padding: 15px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
.modal-header h2 { margin: 0; font-family: 'Uncial Antiqua', serif; color: #ffcc66; font-size: 20px; }
.close-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; font-weight: bold; line-height: 1; }
.modal-body { padding: 20px; overflow-y: auto; color: #ddd; font-size: 16px; line-height: 1.6; }
.modal-images { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
.modal-images img { max-height: 150px; border-radius: 6px; cursor: pointer; border: 1px solid #555; }

/* ADMIN FORM */
#adminPanel { display: none; background: #333; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ffcc66; }
#adminPanel input, #adminPanel textarea, #adminPanel select { width: 100%; margin-bottom: 10px; padding: 8px; background: #222; color: white; border: 1px solid #555; box-sizing: border-box; }
#adminPanel button { background: #ffcc66; color: #000; padding: 10px; font-weight: bold; border: none; cursor: pointer; width: 100%; }

@media(max-width:768px){
  .top-nav { display: none; }
  #hamburger { display: block; }
  .content-wrapper { flex-direction: column; padding-top: 50px; }
  .sidebar { width: 100%; padding: 10px 15px; border-right: none; border-bottom: 1px solid #333; flex-shrink: 0; box-sizing: border-box;}
  .sidebar h3.desktop-only-header { display: none; }
  
  .mobile-primary-header { display: flex; }
  #primary-tags { display:none; flex-direction:column; margin-top: 10px; text-align: center; }
  #primary-tags.show { display:flex; }
  
  #secondary-tags { flex-direction: row; flex-wrap: wrap; justify-content: center; margin-top: 5px; }
  .filter-btn[data-type="secondary"] { width: auto; font-size: 11px; padding: 4px 8px; margin-bottom: 0; }
  
  .main-content { padding: 10px; }
  .story-title { font-size: 16px; }
}
</style>
</head>
<body>

<nav class="top-nav">
  <a href="index.html">Home</a>
  <a href="story.html" class="active">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html">Discussion</a>
  <a href="login.html" id="authLink">Sign In</a>
</nav>

<button id="hamburger">&#9776;</button>
<div id="navMenu">
  <a href="index.html">Home</a>
  <a href="story.html" class="active">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html">Discussion</a>
  <a href="login.html" id="mobileAuthLink">Sign In</a>
</div>

<div id="storyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Story Title</h2>
      <button class="close-btn" onclick="document.getElementById('storyModal').style.display='none'">&times;</button>
    </div>
    <div class="modal-body">
      <div id="modalText"></div>
      <div class="modal-images" id="modalImages"></div>
      <div id="modalAdmin" style="margin-top:20px; border-top:1px solid #444; padding-top:10px; text-align:right;"></div>
    </div>
  </div>
</div>

<div class="content-wrapper">
  <div class="sidebar">
    <h3 class="desktop-only-header">Primary Tag</h3>
    <div class="mobile-primary-header">
      <button id="primaryHamburger">&#9776;</button>
      <span id="currentPrimaryLabel">All</span>
    </div>

    <div id="primary-tags">
        <button class="filter-btn active" data-type="primary" data-filter="all" data-label="All">All</button>
        <button class="filter-btn" data-type="primary" data-filter="mount-aetheria" data-label="Mount Aetheria">Mount Aetheria</button>
        <button class="filter-btn" data-type="primary" data-filter="dark-grasp" data-label="Dark Grasp">Dark Grasp</button>
        <button class="filter-btn" data-type="primary" data-filter="rean-legacy" data-label="Ra'en Legacy">Ra'en Legacy</button>
        <button class="filter-btn" data-type="primary" data-filter="scourgefall" data-label="Scourgefall">Scourgefall</button>
        <button class="filter-btn" data-type="primary" data-filter="unknown" data-label="Unknown">Unknown</button>
        <button class="filter-btn" data-type="primary" data-filter="veil-of-alissa" data-label="Veil of Alissa">Veil of Alissa</button>
    </div>

    <h3 class="desktop-only-header" style="margin-top:20px;">Secondary Tag</h3>
    <div id="secondary-tags"></div>

    <div id="adminControls" style="margin-top:20px; border-top:1px solid #555; padding-top:10px; display:none;">
      <button id="toggleAdminBtn" style="color:#ff6666; font-weight:bold;">+ Add Story</button>
    </div>
  </div>

  <div class="main-content">
    <div id="adminPanel">
      <h3 style="margin-top:0; font-family:'Uncial Antiqua'">Create / Edit Story Entry</h3>
      <input type="text" id="newTitle" placeholder="Story Title">
      <select id="newCategory">
          <option value="mount-aetheria">Mount Aetheria</option>
          <option value="dark-grasp">Dark Grasp</option>
          <option value="rean-legacy">Ra'en Legacy</option>
          <option value="veil-of-alissa">Veil of Alissa</option>
          <option value="scourgefall">Scourgefall</option>
          <option value="unknown">Unknown</option>
      </select>
      <input type="text" id="newSecondaryTag" placeholder="Secondary Tag (comma separated)">
      <textarea id="newText" rows="5" placeholder="Story Content..."></textarea>
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Upload Images (Max 5):</label>
      <input type="file" id="imageInput" multiple accept="image/*">
      <button id="submitStoryBtn">Publish Story</button>
      <div id="uploadStatus" style="text-align:center; margin-top:5px; color:#ffcc66;"></div>
    </div>

    <div class="controls-bar">
      <select id="sortSelect" class="sort-select">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="az">A-Z</option>
        <option value="za">Z-A</option>
      </select>
    </div>

    <div id="story-container">
      <div style="text-align:center; color:#888;">Loading stories...</div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw",
  authDomain: "mount-aetheria.firebaseapp.com",
  projectId: "mount-aetheria",
  storageBucket: "mount-aetheria.firebasestorage.app",
  messagingSenderId: "492855693446",
  appId: "1:492855693446:web:f9948569254a7220c38107",
  measurementId: "G-0PF84KDN7L"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const ADMIN_ID = "U7uyfcMtULSLJvXD0HzJaiMIeGE3"; 
let currentPrimary = "all";
let currentSecondary = "all";
let allStories = [];
let currentUser = null;
let editingStoryId = null;

onAuthStateChanged(auth, user => {
  currentUser = user;
  const link = document.getElementById('authLink');
  const mLink = document.getElementById('mobileAuthLink');
  
  if(user){
     const txt = "My Account";
     const href = "account.html";
     if(link) { link.textContent = txt; link.href = href; }
     if(mLink) { mLink.textContent = txt; mLink.href = href; }
     if(user.uid === ADMIN_ID || user.email === "phoeaung2076@gmail.com") {
         document.getElementById('adminControls').style.display = "block";
     }
  } else {
     const txt = "Sign In";
     const href = "login.html";
     if(link) { link.textContent = txt; link.href = href; }
     if(mLink) { mLink.textContent = txt; mLink.href = href; }
  }
});

document.getElementById('primaryHamburger').addEventListener('click', () => {
    document.getElementById('primary-tags').classList.toggle('show');
});

document.querySelectorAll('.filter-btn[data-type="primary"]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn[data-type="primary"]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentPrimary = btn.dataset.filter;
    currentSecondary = 'all'; 
    document.getElementById('currentPrimaryLabel').textContent = btn.dataset.label || btn.textContent;
    document.getElementById('primary-tags').classList.remove('show');
    updateSecondaryTags();
    renderStories();
  });
});

document.getElementById('toggleAdminBtn').addEventListener('click', () => {
    const panel = document.getElementById('adminPanel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    editingStoryId = null; 
    panel.querySelector('h3').textContent = "Create New Story Entry";
});

document.getElementById('submitStoryBtn').addEventListener('click', async () => {
    const title = document.getElementById('newTitle').value;
    const cat = document.getElementById('newCategory').value;
    const secondaryInput = document.getElementById('newSecondaryTag').value.trim();
    const secondaryTags = secondaryInput.split(',').map(t => t.trim()).filter(t => t.length>0);
    const text = document.getElementById('newText').value;
    const fileInput = document.getElementById('imageInput');
    const status = document.getElementById('uploadStatus');

    if(!title || !text) return alert("Title and Content are required.");
    
    document.getElementById('submitStoryBtn').disabled = true;
    status.textContent = editingStoryId ? "Updating story..." : "Uploading images...";

    const imageUrls = [];
    try {
        if(fileInput.files.length > 0){
            for (const file of fileInput.files) {
                const storageRef = ref(storage, `stories/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                imageUrls.push(url);
            }
        }

        if(editingStoryId){
            const storyRef = doc(db, 'artifacts', 'default-app-id', 'public', 'data', 'stories', editingStoryId);
            await updateDoc(storyRef,{
                title,
                category: cat,
                secondaryTags,
                content: text,
                ...(imageUrls.length>0 && { images: imageUrls })
            });
            alert("Story Updated!");
        } else {
            await addDoc(collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'stories'), {
                title,
                category: cat,
                secondaryTags,
                content: text,
                images: imageUrls,
                createdAt: serverTimestamp()
            });
            alert("Story Published!");
        }

        document.getElementById('newTitle').value = "";
        document.getElementById('newText').value = "";
        document.getElementById('newSecondaryTag').value = "";
        fileInput.value = "";
        document.getElementById('adminPanel').style.display = 'none';
        editingStoryId = null;
        status.textContent = "";

    } catch(e) {
        console.error(e);
        alert("Error: " + e.message);
        status.textContent = "Error occurred.";
    } finally {
        document.getElementById('submitStoryBtn').disabled = false;
    }
});

const storiesRef = collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'stories');
const q = query(storiesRef, orderBy('createdAt', 'desc'));

onSnapshot(q, snapshot => {
    allStories = [];
    snapshot.forEach(doc => allStories.push({id:doc.id, ...doc.data()}));
    updateSecondaryTags();
    renderStories();
});

function renderStories() {
    const container = document.getElementById('story-container');
    const sortVal = document.getElementById('sortSelect').value;
    container.innerHTML = "";

    let displayList = [...allStories];
    displayList.sort((a,b) => {
        const timeA = a.createdAt?.seconds || 0;
        const timeB = b.createdAt?.seconds || 0;
        const titleA = (a.title || "").toLowerCase();
        const titleB = (b.title || "").toLowerCase();

        if(sortVal === 'newest') return timeB - timeA;
        if(sortVal === 'oldest') return timeA - timeB;
        if(sortVal === 'az') return titleA.localeCompare(titleB);
        if(sortVal === 'za') return titleB.localeCompare(titleA);
        return 0;
    });

    if(displayList.length === 0){
        container.innerHTML = "<div style='text-align:center; padding:20px;'>No stories found.</div>";
        return;
    }

    displayList.forEach(story => {
        if(currentPrimary !== 'all' && story.category !== currentPrimary) return;
        if(currentSecondary !== 'all' && (!story.secondaryTags || !story.secondaryTags.map(t=>t.toLowerCase()).includes(currentSecondary.toLowerCase()))) return;

        const entry = document.createElement('div');
        entry.className = 'story-entry';

        let secTagHtml = "";
        if(story.secondaryTags && story.secondaryTags.length>0){
            const sortedTags = story.secondaryTags.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
            secTagHtml = sortedTags.map(tag => `<span class="sec-tag">${tag}</span>`).join('');
        }

        entry.innerHTML = `
            <div class="story-header">
                <div class="story-title">${story.title}</div>
                <div class="story-meta">
                   ${secTagHtml}
                   <span class="story-cat">${story.category}</span>
                </div>
            </div>
        `;

        entry.addEventListener('click', () => openModal(story));
        container.appendChild(entry);
    });
}

function openModal(story) {
    document.getElementById('modalTitle').textContent = story.title;
    document.getElementById('modalText').innerHTML = story.content.replace(/\n/g,'<br>');
    
    const imgContainer = document.getElementById('modalImages');
    imgContainer.innerHTML = "";
    if(story.images && story.images.length > 0){
        story.images.forEach(url => {
            const img = document.createElement('img');
            img.src = url;
            img.onclick = () => window.open(url);
            imgContainer.appendChild(img);
        });
    }

    // Admin controls inside modal
    const adminDiv = document.getElementById('modalAdmin');
    adminDiv.innerHTML = "";
    if(currentUser && (currentUser.uid === ADMIN_ID || currentUser.email === "phoeaung2076@gmail.com")){
         const editBtn = document.createElement('button');
         editBtn.textContent = "Edit Story";
         editBtn.style.cssText = "background:#66ff66;color:#111;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-weight:bold;margin-right:10px;";
         editBtn.onclick = () => {
             document.getElementById('storyModal').style.display = 'none';
             document.getElementById('adminPanel').style.display = 'block';
             document.getElementById('newTitle').value = story.title;
             document.getElementById('newCategory').value = story.category;
             document.getElementById('newSecondaryTag').value = story.secondaryTags.join(', ');
             document.getElementById('newText').value = story.content;
             editingStoryId = story.id;
             document.getElementById('adminPanel').querySelector('h3').textContent = "Edit Story Entry";
             window.scrollTo(0,0);
         };

         const delBtn = document.createElement('button');
         delBtn.textContent = "Delete Story";
         delBtn.style.cssText = "background:#ff6666;color:#111;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-weight:bold;";
         delBtn.onclick = async () => {
             if(confirm("Delete this story?")) {
                 await deleteDoc(doc(db,'artifacts','default-app-id','public','data','stories',story.id));
                 document.getElementById('storyModal').style.display = 'none';
             }
         };
         
         adminDiv.appendChild(editBtn);
         adminDiv.appendChild(delBtn);
    }

    document.getElementById('storyModal').style.display = 'flex';
}

function updateSecondaryTags(){
    const container = document.getElementById('secondary-tags');
    const tagsSet = new Set();
    allStories.forEach(s => {
        if(currentPrimary==='all' || s.category===currentPrimary){
            if(s.secondaryTags) s.secondaryTags.forEach(t => tagsSet.add(t));
        }
    });
    const sortedTags = Array.from(tagsSet).sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));
    
    let html = `<button class="filter-btn ${currentSecondary==='all'?'active':''}" data-type="secondary" data-filter="all">All</button>`;
    sortedTags.forEach(tag => {
        const isActive = currentSecondary.toLowerCase()===tag.toLowerCase()?'active':'';
        html += `<button class="filter-btn ${isActive}" data-type="secondary" data-filter="${tag}">${tag}</button>`;
    });
    container.innerHTML = html;

    container.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = () => {
            currentSecondary = btn.dataset.filter;
            container.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderStories();
        };
    });
}

document.getElementById('sortSelect').addEventListener('change', renderStories);

document.getElementById('hamburger').addEventListener('click', () => {
    const m = document.getElementById('navMenu');
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
});
</script>
</body>
</html>