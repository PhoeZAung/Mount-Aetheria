<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mount Aetheria - Story</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(to bottom,#222,#444);display:flex;flex-direction:column;height:100vh;overflow:hidden}
/* NAV STYLES */
.top-nav{width:100%;background:#111;padding:15px 20px;display:flex;justify-content:space-around;align-items:center;position:fixed;top:0;left:0;z-index:2000}
.top-nav a{color:#fff;text-decoration:none;font-size:18px;font-weight:600;font-family:'Uncial Antiqua',serif}
.top-nav a:hover{color:#ffcc66}
#hamburger{display:none;position:fixed;top:15px;left:15px;background:#111;color:#fff;border:none;padding:10px;font-size:24px;cursor:pointer;z-index:2001;border-radius:5px;}
#navMenu{display:none;flex-direction:column;background:#111;position:fixed;top:60px;left:15px;border-radius:8px;z-index:2000;box-shadow:0 5px 15px rgba(0,0,0,0.8);overflow:hidden;}
#navMenu a{padding:12px 20px;color:#fff;text-decoration:none;border-bottom:1px solid #333;font-family:'Uncial Antiqua',serif;display:block;}

/* LAYOUT */
.content-wrapper { display: flex; height: 100%; padding-top: 60px; }
.sidebar{width:220px;background:#181818;padding:20px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;border-right:1px solid #333;}
.sidebar h3{color:#ffcc66;text-align:center;margin:10px 0;font-family:'Uncial Antiqua',serif;}
.filter-btn{background:#333;color:#fff;border:none;padding:10px;cursor:pointer;border-radius:8px;width:100%;margin-bottom:5px;text-align:left;font-weight:bold;transition:0.2s;}
.filter-btn:hover,.filter-btn.active{background:#ffcc66;color:#111;}

.main-content{flex:1;overflow-y:auto;padding:20px;}
.controls-bar { display: flex; justify-content: flex-end; margin-bottom: 15px; }
.sort-select { padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }

.story-entry{background:#2b2b2b;color:#fff;border-radius:12px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,0.5);border:1px solid #444;}
.story-entry h3{margin:0;padding:15px;cursor:pointer;font-family:'Uncial Antiqua',serif;color:#ffcc66;background:#222;border-radius:12px 12px 0 0;}
.story-entry h3:hover{background:#333;}
.story-entry .content{padding:15px;display:none;border-top:1px solid #444;}
.story-entry .content.show{display:block;animation:fadeIn 0.3s ease-in-out;}
.image-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.small-img{height:100px;width:auto;border-radius:5px;cursor:pointer; object-fit: cover;}

/* ADMIN FORM */
#adminPanel { display: none; background: #333; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ffcc66; }
#adminPanel input, #adminPanel textarea, #adminPanel select { width: 100%; margin-bottom: 10px; padding: 8px; background: #222; color: white; border: 1px solid #555; box-sizing: border-box; }
#adminPanel button { background: #ffcc66; color: #000; padding: 10px; font-weight: bold; border: none; cursor: pointer; width: 100%; }

@media(max-width: 768px){
  .top-nav { display: none; }
  #hamburger { display: block; }
  .content-wrapper { flex-direction: column; }
  .sidebar { width: 100%; height: auto; padding: 10px; border-right: none; border-bottom: 1px solid #333; flex-shrink: 0; }
  .filter-btn { display: inline-block; width: auto; font-size: 12px; padding: 5px 10px; }
  .main-content { padding: 10px; }
}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>

<nav class="top-nav">
  <a href="index.html">Home</a>
  <a href="story.html" class="active">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html">Discussion</a>
  <a href="login.html" id="authLink">Sign In</a>
</nav>

<button id="hamburger">&#9776;</button>
<div id="navMenu">
  <a href="index.html">Home</a>
  <a href="story.html" class="active">Story</a>
  <a href="tools.html">Tools</a>
  <a href="characters.html">Character Sheet</a>
  <a href="discussions.html">Discussion</a>
  <a href="login.html" id="mobileAuthLink">Sign In</a>
</div>

<div class="content-wrapper">
  <div class="sidebar">
    <h3>Primary Tag</h3>
  <div id="primary-tags">
    <button class="filter-btn active" data-type="primary" data-filter="all">All</button>
    <button class="filter-btn" data-type="primary" data-filter="dark-grasp">Dark Grasp</button>
    <button class="filter-btn" data-type="primary" data-filter="rean-legacy">Re'an Legacy</button>
    <button class="filter-btn" data-type="primary" data-filter="alissa-revenge">Alissa's Revenge</button>
    <button class="filter-btn" data-type="primary" data-filter="placeholder1">Placeholder 1</button>
    <button class="filter-btn" data-type="primary" data-filter="placeholder2">Placeholder 2</button>
    <button class="filter-btn" data-type="primary" data-filter="placeholder3">Placeholder 3</button>
  </div>

    
    <h3>Secondary Tag</h3>
    <div id="secondary-tags">
        </div>
    
    <div id="adminControls" style="margin-top:20px; border-top:1px solid #555; padding-top:10px; display:none;">
      <button id="toggleAdminBtn" style="color:#ff6666; font-weight:bold;">+ Add Story</button>
    </div>
  </div>

  <div class="main-content">
    
    <div id="adminPanel">
      <h3 style="margin-top:0; font-family:'Uncial Antiqua'">Create New Story Entry</h3>
      <input type="text" id="newTitle" placeholder="Story Title (e.g. Session 5)">
      <select id="newCategory">
          <option value="dark-grasp">Dark Grasp</option>
          <option value="rean-legacy">Re'an Legacy</option>
          <option value="alissa-revenge">Alissa's Revenge</option>
      </select>
      <input type="text" id="newSecondaryTag" placeholder="Secondary Tag (e.g. Character Name, Location)">
      <textarea id="newText" rows="5" placeholder="Story Content..."></textarea>
      
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Upload Images (Max 5):</label>
      <input type="file" id="imageInput" multiple accept="image/*">
      
      <button id="submitStoryBtn">Publish Story</button>
      <div id="uploadStatus" style="text-align:center; margin-top:5px; color:#ffcc66;"></div>
    </div>

    <div class="controls-bar">
      <select id="sortSelect" class="sort-select">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="az">A-Z</option>
        <option value="za">Z-A</option>
      </select>
    </div>

    <div id="story-container">
      <div style="text-align:center; color:#888;">Loading stories...</div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw",
  authDomain: "mount-aetheria.firebaseapp.com",
  projectId: "mount-aetheria",
  storageBucket: "mount-aetheria.firebasestorage.app",
  messagingSenderId: "492855693446",
  appId: "1:492855693446:web:f9948569254a7220c38107",
  measurementId: "G-0PF84KDN7L"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const ADMIN_ID = "U7uyfcMtULSLJvXD0HzJaiMIeGE3"; 
let currentPrimary = "all";
let currentSecondary = "all";
let allStories = [];
let currentUser = null; // track logged in user

// Auth & Admin Logic
onAuthStateChanged(auth, user => {
  const link = document.getElementById('authLink');
  const mLink = document.getElementById('mobileAuthLink');
  currentUser = user;
  
  if(user){
     const txt = "My Account";
     const href = "account.html";
     if(link) { link.textContent = txt; link.href = href; }
     if(mLink) { mLink.textContent = txt; mLink.href = href; }
     
     // Show admin controls if user is ID or email admin
     if(user.uid === ADMIN_ID || user.email === "phoeaung2076@gmail.com") {
         document.getElementById('adminControls').style.display = "block";
     }
  } else {
     const txt = "Sign In";
     const href = "login.html";
     if(link) { link.textContent = txt; link.href = href; }
     if(mLink) { mLink.textContent = txt; mLink.href = href; }
  }
});

// Submit with Image Upload
document.getElementById('submitStoryBtn').addEventListener('click', async () => {
    const title = document.getElementById('newTitle').value;
    const cat = document.getElementById('newCategory').value;
    const secondaryInput = document.getElementById('newSecondaryTag').value.trim();
    const secondaryTags = secondaryInput.split(',').map(t => t.trim()).filter(t=>t.length>0);
    const text = document.getElementById('newText').value;
    const fileInput = document.getElementById('imageInput');
    const status = document.getElementById('uploadStatus');

    if(!title || !text) return alert("Title and Content are required.");
    
    document.getElementById('submitStoryBtn').disabled = true;
    status.textContent = "Uploading images...";

    const imageUrls = [];
    try {
        if(fileInput.files.length > 0){
             for (const file of fileInput.files) {
                const storageRef = ref(storage, `stories/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                imageUrls.push(url);
             }
        }

        status.textContent = "Saving story...";
        await addDoc(collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'stories'), {
            title: title,
            category: cat,
            secondaryTags, // store as array
            content: text,
            images: imageUrls,
            createdAt: serverTimestamp()
        });
        
        alert("Story Published!");
        status.textContent = "";
        document.getElementById('newTitle').value = "";
        document.getElementById('newText').value = "";
        document.getElementById('newSecondaryTag').value = "";
        fileInput.value = "";
        document.getElementById('adminPanel').style.display = 'none';

    } catch(e) {
        console.error(e);
        alert("Error: " + e.message);
        status.textContent = "Error occurred.";
    } finally {
        document.getElementById('submitStoryBtn').disabled = false;
    }
});

// Sorting Logic
document.getElementById('sortSelect').addEventListener('change', renderStories);

// Load Stories
const storiesRef = collection(db, 'artifacts', 'default-app-id', 'public', 'data', 'stories');
const q = query(storiesRef, orderBy('createdAt', 'desc'));

onSnapshot(q, snapshot => {
    allStories = [];
    snapshot.forEach(doc => allStories.push({id:doc.id, ...doc.data()}));
    updateSecondaryTags();
    renderStories();
});

function renderStories() {
    const container = document.getElementById('story-container');
    const sortVal = document.getElementById('sortSelect').value;
    container.innerHTML = "";
    
    let displayList = [...allStories];
    displayList.sort((a,b) => {
        const timeA = a.createdAt?.seconds || 0;
        const timeB = b.createdAt?.seconds || 0;
        const titleA = (a.title || "").toLowerCase();
        const titleB = (b.title || "").toLowerCase();

        if(sortVal === 'newest') return timeB - timeA;
        if(sortVal === 'oldest') return timeA - timeB;
        if(sortVal === 'az') return titleA.localeCompare(titleB);
        if(sortVal === 'za') return titleB.localeCompare(titleA);
        return 0;
    });

    if(displayList.length === 0) {
        container.innerHTML = "<div style='text-align:center; padding:20px;'>No stories found.</div>";
        return;
    }

    displayList.forEach(story => {
        if(currentPrimary !== 'all' && story.category !== currentPrimary) return;
        if(currentSecondary !== 'all' && (!story.secondaryTags || !story.secondaryTags.map(t=>t.toLowerCase()).includes(currentSecondary.toLowerCase()))) return;

        const entry = document.createElement('div');
        entry.className = 'story-entry';
        
        let imgHtml = "";
        if(story.images && story.images.length > 0) {
            imgHtml = `<div class="image-row">`;
            story.images.forEach(url => {
                imgHtml += `<img src="${url}" class="small-img" onclick="window.open('${url}')">`;
            });
            imgHtml += `</div>`;
        }

        let secTagHtml = "";
        if(story.secondaryTags && story.secondaryTags.length > 0) {
            const sortedTags = story.secondaryTags.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
            secTagHtml = sortedTags.map(tag => 
                `<span style="font-size:11px; background:#444; padding:2px 6px; border-radius:4px; margin-left:5px;">${tag}</span>`
            ).join('');
        }

        entry.innerHTML = `
            <h3>${story.title} ${secTagHtml} <span style="font-size:12px; float:right; color:#888;">${story.category}</span></h3>
            <div class="content">
                <p>${story.content.replace(/\n/g, '<br>')}</p>
                ${imgHtml}
            </div>
        `;

        // Toggle content
        entry.querySelector('h3').addEventListener('click', () => entry.querySelector('.content').classList.toggle('show'));

        // Delete button if admin
        if(currentUser && (currentUser.uid === ADMIN_ID || currentUser.email === "phoeaung2076@gmail.com")) {
            const delBtn = document.createElement('button');
            delBtn.textContent = "Delete";
            delBtn.style.cssText = "float:right; color:#ff6666; margin-left:10px;";
            delBtn.onclick = async () => {
                if(confirm("Delete this story?")) {
                    await deleteDoc(doc(db, 'artifacts', 'default-app-id', 'public', 'data', 'stories', story.id));
                }
            };
            entry.querySelector('h3').appendChild(delBtn);
        }

        container.appendChild(entry);
    });
}

function updateSecondaryTags() {
    const container = document.getElementById('secondary-tags');
    const tagsSet = new Set();
    allStories.forEach(s => {
        if(currentPrimary === 'all' || s.category === currentPrimary) {
            if(s.secondaryTags) s.secondaryTags.forEach(t => tagsSet.add(t));
        }
    });

    const sortedTags = Array.from(tagsSet).sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));

    let html = `<button class="filter-btn ${currentSecondary==='all'?'active':''}" data-type="secondary" data-filter="all">All</button>`;
    sortedTags.forEach(tag => {
        const isActive = currentSecondary.toLowerCase() === tag.toLowerCase() ? 'active' : '';
        html += `<button class="filter-btn ${isActive}" data-type="secondary" data-filter="${tag}">${tag}</button>`;
    });

    container.innerHTML = html;

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = () => {
            const type = btn.dataset.type;
            const filter = btn.dataset.filter;
            if(type === 'primary') {
                currentPrimary = filter;
                currentSecondary = 'all';
                updateSecondaryTags(); 
            } else {
                currentSecondary = filter;
            }
            // Update active states
            if(type==='primary') document.querySelectorAll(`.filter-btn[data-type="primary"]`).forEach(b=>b.classList.remove('active'));
            else document.querySelectorAll(`.filter-btn[data-type="secondary"]`).forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            
            renderStories();
        };
    });
}

// UI toggles (unchanged)
document.getElementById('hamburger').addEventListener('click', () => {
    const m = document.getElementById('navMenu');
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
});
document.getElementById('toggleAdminBtn').addEventListener('click', () => {
    const p = document.getElementById('adminPanel');
    p.style.display = (p.style.display === 'block') ? 'none' : 'block';
});
</script>

</body>
</html>