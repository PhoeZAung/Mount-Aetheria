<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî Master Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
  :root { --bg:#111; --panel:#222; --muted:#aaa; --accent:#ffcc66; --good:#4caf50; --bad:#ff6666; --input-bg:#111; --border:#333; }
  body { margin:0; font-family:Arial,Helvetica,sans-serif; background:#0b0b0b; color:#fff; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
  
  header { height:50px; background:var(--panel); display:flex; align-items:center; padding:0 18px; border-bottom:1px solid #333; flex-shrink:0; justify-content: space-between;}
  header h1 { font-family:'Uncial Antiqua',serif; color:var(--accent); margin:0; font-size:20px; cursor: pointer; text-decoration: none; }

  #layout { display:flex; flex:1; overflow:hidden; position: relative; }
  
  #sidebar { width:250px; background:#181818; border-right:1px solid #333; display:flex; flex-direction:column; flex-shrink:0; transition: transform 0.3s ease; }
  #userSearch { background:#000; border:none; border-bottom:1px solid #333; color:#fff; padding:15px; width:100%; box-sizing:border-box; outline:none; }
  #usersList { flex:1; overflow-y:auto; }
  
  /* --- USER LIST STYLES --- */
  .userItem { padding:10px 15px; cursor:pointer; border-bottom:1px solid #222; transition:0.2s; display:flex; flex-direction: column; }
  .userItem:hover { background:#222; }
  .userItem.selected { background:var(--accent); color:#000; }
  .userItem .uName { font-weight:bold; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .userItem .uMeta { font-size:11px; opacity:0.7; }
  
  /* SUMMON ITEM STYLES */
  .summonItem { padding: 8px 15px 8px 35px; cursor:pointer; border-bottom:1px solid #222; background: #252525; color: #aaa; font-size: 0.95em; position: relative; }
  .summonItem:before { content:"‚Ü≥"; position:absolute; left:15px; opacity:0.5; }
  .summonItem:hover { background: #333; color: #fff; }
  .summonItem.selected { background: var(--accent); color: #000; }

  #editorArea { flex:1; display:flex; flex-direction:column; background:#111; position:relative; overflow:hidden; }
  #emptyState { display:flex; align-items:center; justify-content:center; height:100%; color:#444; font-family:'Uncial Antiqua'; font-size:24px; }
  #backBtnMobile { display: none; background: #333; color: #fff; border: none; padding: 10px; text-align: left; font-weight: bold; cursor: pointer; border-bottom: 1px solid #444; }
  
  #sheetContainer { flex:1; overflow-y:auto; padding:20px; display:none; }
  #sheetContainer.active { display:block; }

  /* --- TABS --- */
  .tabs-container { display: flex; width: 100%; max-width: 1000px; margin: 0 auto; gap:20px; flex-direction: column; }
  .tab-menu { display: flex; flex-wrap: wrap; width: 100%; background: #1a1a1a; padding: 10px; gap: 5px; border-radius:8px; box-sizing: border-box; overflow-x: auto; }
  .tab-btn { flex: 1; min-width: 80px; background: transparent; border: none; color: #888; padding: 10px; cursor: pointer; font-family: 'Uncial Antiqua', serif; text-align: center; border-bottom: 3px solid transparent; }
  .tab-btn:hover, .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: #111; }
  
  .tab-content { display: none; padding: 15px; max-width: 800px; margin: 0 auto; }
  .tab-content.active { display: block; animation: fadeIn 0.3s; }

  h2, h3, h4 { font-family: 'Uncial Antiqua', serif; color: var(--accent); margin-top:0; text-align: center; }
  
  /* --- INPUTS --- */
  input, textarea, select { background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; width: 100%; font-size: 14px; box-sizing: border-box; }
  input:focus, textarea:focus { border-color: var(--accent); outline: none; }
  label { color: #aaa; font-size: 12px; font-weight: bold; margin-bottom: 4px; display: block; }
  
  .bio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .bio-item { display: flex; flex-direction: column; }
  
  /* --- STATS --- */
  .combat-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; background: var(--panel); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
  .stat-box { display: flex; flex-direction: column; align-items: center; }
  .stat-dual { display: flex; align-items: center; gap: 5px; }
  .stat-dual input { text-align: center; }

  /* --- SUB TABS --- */
  .sub-nav-container { margin-bottom: 15px; position: relative; }
  .sub-nav { display: flex; justify-content: center; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
  .sub-btn { background: none; border: 1px solid transparent; color: #888; padding: 6px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 14px; }
  .sub-btn.active { background: var(--accent); color: #000; }
  .sub-group, .sub-sub-group { display: none; }
  .sub-group.active, .sub-sub-group.active { display: block; }

  /* --- LISTS --- */
  details { background: #181818; border: 1px solid #333; border-radius: 4px; margin-bottom: 8px; overflow: hidden; }
  details summary { padding: 8px 12px; cursor: pointer; background: #252525; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
  details summary a { color: var(--accent); text-decoration: none; position: relative; z-index: 50; }
  .details-content { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
  
  .attr-row { display: flex; gap: 5px; margin-top: 5px; align-items: center; }
  .attr-row .attr-n { flex: 3; min-width: 0; }
  .attr-row .attr-v { flex: 7; min-width: 0; }
  .btn-remove { background:#ff4444; color:#fff; border:none; padding:2px 8px; border-radius:2px; cursor:pointer; font-size:12px; }
  
  .btn-add { width:100%; background:var(--accent); color:#000; border:none; padding:8px; font-weight:bold; cursor:pointer; border-radius:4px; margin-top:10px; }
  
  /* --- SKILLS --- */
  .skills-table { width:100%; border-collapse:collapse; font-size:13px; text-align: center; }
  .skills-table th { background: #000; color:var(--accent); border-bottom:1px solid #444; padding:5px; }
  .skills-table td { padding:4px; border-bottom:1px solid #333; }
  .skills-table td:nth-child(2) { text-align: left; font-weight: bold; }
  
  .item-preview { width:40px; height:40px; border:1px solid #444; background:#000; object-fit:cover; }

  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

  #adminBar { position:absolute; bottom:0; left:0; right:0; background:var(--accent); color:#000; padding:5px 10px; font-size:12px; font-weight:bold; display:flex; justify-content:space-between; z-index: 100; }

  @media(max-width:768px){
    #sidebar { width: 100%; position: absolute; z-index: 10; height: 100%; }
    #editorArea { width: 100%; position: absolute; z-index: 20; height: 100%; transform: translateX(100%); transition: transform 0.3s ease; background: #000; }
    
    body.show-editor #sidebar { transform: translateX(-20%); opacity: 0; }
    body.show-editor #editorArea { transform: translateX(0); }
    #backBtnMobile { display: block; }
    
    .combat-stats { display: flex; flex-direction: column; }
    .stat-box { flex-direction: row; justify-content: space-between; border-bottom:1px solid #333; }
    .stat-box input { width: 50%; }
  }
</style>
</head>
<body>

<header>
  <h1 onclick="window.location.href='index.html'">Mount Aetheria</h1>
  <div style="font-size:12px; color:#888;">Admin</div>
</header>

<div id="layout">
  <div id="sidebar">
    <input type="text" id="userSearch" placeholder="Search Users...">
    <div id="usersList"><div style="padding:15px; color:#888;">Loading...</div></div>
  </div>

  <div id="editorArea">
    <button id="backBtnMobile" onclick="closeMobileEditor()">‚Üê Back to User List</button>
    
    <div id="emptyState">Select a user to edit their sheet</div>
    
    <div id="sheetContainer">
      <div class="tabs-container">
        <div class="tab-menu">
          <button class="tab-btn active" id="btn-character" onclick="switchTab('character')">Character</button>
          <button class="tab-btn" id="btn-combat" onclick="switchTab('combat')">Combat</button>
          <button class="tab-btn" id="btn-skills" onclick="switchTab('skills')">Skills</button>
          <button class="tab-btn" id="btn-items" onclick="switchTab('items')">Items</button>
          <button class="tab-btn" id="btn-notes" onclick="switchTab('notes')">Notes</button>
        </div>

        <div class="tab-content active" id="character">
          <h2 id="sheetTitle">Bio & Stats</h2>
          <div class="bio-grid">
            <div class="bio-item"><label>Name</label><input id="charName" class="save-field"></div>
            <div class="bio-item"><label>Race</label><input id="race" class="save-field"></div>
            <div class="bio-item"><label>Class</label><input id="class" class="save-field"></div>
            <div class="bio-item"><label>Align</label><input id="alignment" class="save-field"></div>
            <div class="bio-item"><label>Size</label><input id="size" class="save-field"></div>
            <div class="bio-item"><label>Langs</label><input id="languages" class="save-field"></div>
            <div class="bio-item" style="grid-column: 1 / -1;"><label>Senses</label><input id="senses" class="save-field"></div>
          </div>
          <h3>Ability Scores</h3>
          <div style="background:var(--panel); border-radius:8px; overflow:hidden;">
            <table style="width:100%; border-collapse:collapse; text-align:center;">
                <tr style="background:#000; color:#888; font-size:12px;"><th>Stat</th><th>Score</th><th>Mod</th></tr>
                <script>
                    ['str','dex','con','int','wis','cha'].forEach(s => {
                        document.write(`<tr style="border-top:1px solid #333;"><td style="font-weight:bold; color:var(--accent); text-transform:uppercase;">${s}</td><td style="padding:8px;"><input type="number" id="${s}" class="save-field calc-trigger" style="text-align:center; background:#111; border:1px solid #444; color:#fff; border-radius:4px;"></td><td id="mod-${s}">+0</td></tr>`);
                    });
                </script>
            </table>
          </div>
        </div>

        <div class="tab-content" id="combat">
          <div class="combat-stats" style="grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));">
            <div class="stat-box"><label>HP (Cur/Max)</label><div class="stat-dual"><input id="hp_curr" class="save-field" placeholder="Curr"><span style="color:#666">/</span><input id="hp_max" class="save-field" placeholder="Max"></div></div>
            <div class="stat-box"><label>MP (Cur/Max)</label><div class="stat-dual"><input id="mp_curr" class="save-field" placeholder="Curr"><span style="color:#666">/</span><input id="mp_max" class="save-field" placeholder="Max"></div></div>
            <div class="stat-box"><label>Speed</label><input id="speed" class="save-field"></div>
            <div class="stat-box"><label>Init Mod</label><input id="init_bonus" class="save-field"></div>
            <div class="stat-box"><label>BAB</label><input id="bab" class="save-field"></div>
            <div class="stat-box"><label>AC Total</label><input id="ac_total" class="save-field"></div>
          </div>

          <div class="sub-nav-container">
            <div class="sub-nav" id="combatSubNav">
                <button class="sub-btn active" onclick="switchSub('c-general')">General</button>
                <button class="sub-btn" onclick="switchSub('c-abilities-main')">Abilities</button>
                <button class="sub-btn" id="spellsSubBtn" onclick="switchSub('c-spells')">Spells</button>
            </div>
          </div>

          <div id="c-general" class="sub-group active">
            <div class="combat-stats" style="grid-template-columns: 1fr 1fr;">
                <div class="stat-box"><label>CMB</label><input id="cmb" class="save-field"></div>
                <div class="stat-box"><label>CMD</label><input id="cmd_total" class="save-field"></div>
            </div>
            
            <div style="background:var(--panel); padding:10px; border-radius:8px; margin-bottom:10px;">
                <label>Resistances / Immunities / DR / SR</label>
                <textarea id="resistances" class="save-field" style="height:80px;" placeholder="Fire 10, DR 5/Magic..."></textarea>
            </div>
            
            <h3>Saves</h3>
            <div class="combat-stats">
                <div class="stat-box"><label>Fortitude</label><div class="stat-dual"><input id="fort_bonus" type="number" class="save-field calc-trigger" placeholder="Bonus"><span id="fort_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
                <div class="stat-box"><label>Reflex</label><div class="stat-dual"><input id="ref_bonus" type="number" class="save-field calc-trigger" placeholder="Bonus"><span id="ref_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
                <div class="stat-box"><label>Will</label><div class="stat-dual"><input id="will_bonus" type="number" class="save-field calc-trigger" placeholder="Bonus"><span id="will_total" style="color:var(--accent); font-weight:bold;">+0</span></div></div>
            </div>
            
            <h3>Weapons</h3>
            <div id="weaponList"></div><button class="btn-add" id="btnAddWeapon">+ Add Weapon</button>
          </div>

          <div id="c-abilities-main" class="sub-group" style="display:none">
              <div class="sub-nav-container">
                <div class="sub-nav" id="abilitiesSubSubNav">
                    <button class="sub-btn active" onclick="switchSubSub('a-active')">Active</button>
                    <button class="sub-btn" id="btn-sub-passive" onclick="switchSubSub('a-passive')">Passive</button>
                    <button class="sub-btn" onclick="switchSubSub('a-feats')">Feats</button>
                </div>
              </div>
              
              <div id="a-active" class="sub-sub-group active">
                  <h3>Active Abilities</h3>
                  <div id="activeList"></div>
                  <button class="btn-add" id="btnAddActive">+ Add Active</button>
              </div>

              <div id="a-passive" class="sub-sub-group" style="display:none">
                  <h3>Passive Abilities</h3>
                  <div id="passiveList"></div>
                  <button class="btn-add" id="btnAddPassive">+ Add Passive</button>
              </div>

              <div id="a-feats" class="sub-sub-group" style="display:none">
                  <h3>Feats</h3>
                  <div id="featList"></div>
                  <button class="btn-add" id="btnAddFeat">+ Add Feat</button>
                  <br><br>
                  <label>Proficiencies</label>
                  <textarea id="proficiencies" class="save-field" style="height:80px"></textarea>
              </div>
          </div>

          <div id="c-spells" class="sub-group" style="display:none">
             <h3>Spells</h3>
             <div class="stat-box" style="margin-bottom:10px;"><label>Spell DC Base</label><input id="spell_dc_base" class="save-field"></div>
             <div id="spellList"></div>
             <button class="btn-add" id="btnAddSpell">+ Add Spell</button>
          </div>
        </div>

        <div class="tab-content" id="skills">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><span>Unused Pts:</span><input id="skill_points" class="save-field" style="width:60px; text-align:center;"></div>
            <div class="skills-container">
                <table class="skills-table">
                    <thead><tr><th style="width:30px">CS</th><th style="text-align:left;">Skill Name</th><th style="width:40px">Mod</th><th style="width:50px">Ranks</th><th style="width:40px">Tot</th></tr></thead>
                    <tbody id="skillsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="items">
            <div class="combat-stats" style="grid-template-columns: 1fr 1fr;"><div class="stat-box"><label>üí∞ Gil</label><input id="currency_gil" class="save-field"></div><div class="stat-box"><label>Moogle Pts</label><input id="currency_moogle" class="save-field"></div></div>
            <div id="itemList"></div>
            <button class="btn-add" id="btnAddItem">+ Add Item</button>
        </div>

        <div class="tab-content" id="notes">
            <textarea id="notesArea" class="save-field" style="height:400px; font-family:sans-serif; line-height:1.5;"></textarea>
        </div>

      </div> 
      <div style="height:40px;"></div>
    </div> 
    
    <div id="adminBar">
      <span id="statusText">Ready</span>
      <span id="targetUserUID">No User Selected</span>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw", authDomain: "mount-aetheria.firebaseapp.com", projectId: "mount-aetheria", storageBucket: "mount-aetheria.firebasestorage.app", messagingSenderId: "492855693446", appId: "1:492855693446:web:f9948569254a7220c38107", measurementId: "G-0PF84KDN7L" };
const ADMIN_UID = "U7uyfcMtULSLJvXD0HzJaiMIeGE3";
const ADMIN_EMAIL = "phoeaung2076@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let allUsers = [];
let currentParentUid = null;
let currentSummonId = null; // Null if main, ID string if summon
let fullSheetData = {}; // Stores the entire user sheet including summons
let unsubscribeSheet = null;
let saveTimeout = null;
let isInternalUpdate = false;

// UI TABS
window.switchTab = (id) => { 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
    const btn = document.getElementById('btn-' + id);
    if(btn) btn.classList.add('active');
    document.getElementById(id).classList.add('active'); 
    
    // Reset Combat if selected
    if(id === 'combat') {
        document.querySelectorAll('#combatSubNav .sub-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('#combatSubNav .sub-btn:first-child').classList.add('active');
        document.querySelectorAll('#combat .sub-group').forEach(c => c.style.display = 'none');
        document.getElementById('c-general').style.display = 'block';
    }
};

window.switchSub = (id) => { 
    const container = event.target.parentElement;
    Array.from(container.children).forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    const parentTab = document.getElementById('combat');
    parentTab.querySelectorAll('.sub-group').forEach(c => c.style.display = 'none');
    document.getElementById(id).style.display = 'block';
};

window.switchSubSub = (id) => {
    const container = event.target.parentElement;
    Array.from(container.children).forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    const parent = document.getElementById('c-abilities-main');
    parent.querySelectorAll('.sub-sub-group').forEach(c => c.style.display = 'none');
    document.getElementById(id).style.display = 'block'; 
};

window.closeMobileEditor = () => { document.body.classList.remove('show-editor'); };

const SKILLS_DB = [{n:"Acrobatics",s:"dex"}, {n:"Appraise",s:"int"}, {n:"Bluff",s:"cha"}, {n:"Climb",s:"str"}, {n:"Diplomacy",s:"cha"}, {n:"Disable Device",s:"dex"}, {n:"Disguise",s:"cha"}, {n:"Escape Artist",s:"dex"}, {n:"Fly",s:"dex"}, {n:"Heal",s:"wis"}, {n:"Intimidate",s:"cha"}, {n:"Knw: Arcana",s:"int"}, {n:"Knw: Dungeoneering",s:"int"}, {n:"Knw: Engineering",s:"int"}, {n:"Knw: Geography",s:"int"}, {n:"Knw: History",s:"int"}, {n:"Knw: Local",s:"int"}, {n:"Knw: Nature",s:"int"}, {n:"Knw: Nobility",s:"int"}, {n:"Knw: Planes",s:"int"}, {n:"Knw: Religion",s:"int"}, {n:"Linguistics",s:"int"}, {n:"Perception",s:"wis"}, {n:"Ride",s:"dex"}, {n:"Sense Motive",s:"wis"}, {n:"Sleight of Hand",s:"dex"}, {n:"Spellcraft",s:"int"}, {n:"Stealth",s:"dex"}, {n:"Survival",s:"wis"}, {n:"Swim",s:"str"}, {n:"Use Magic Device",s:"cha"}];

onAuthStateChanged(auth, async (user) => {
  if(!user) { window.location.href="login.html"; return; }
  if(user.uid !== ADMIN_UID && user.email !== ADMIN_EMAIL) {
    document.body.innerHTML = "<h2 style='color:red;padding:20px'>Access Denied: Admin Only</h2>";
    return;
  }
  loadUserList();
});

async function loadUserList(){
    const listEl = document.getElementById('usersList');
    listEl.innerHTML = '<div style="padding:15px">Fetching users...</div>';
    try {
        const snap = await getDocs(collection(db, 'users'));
        allUsers = [];
        // Fetch all user docs
        for (const d of snap.docs) {
            const data = d.data();
            const uid = d.id;
            const name = data.displayName || data.name || "Unknown";
            const email = data.email || "No Email";
            
            // Fetch sheet summary to check for summons
            // Note: In a large production app, fetch summons on demand. 
            // For this scale, pre-fetching is fine for better UX.
            let summons = [];
            try {
                const sheetSnap = await getDoc(doc(db, 'users', uid, 'sheet', 'character'));
                if(sheetSnap.exists() && sheetSnap.data().summons) {
                    summons = sheetSnap.data().summons;
                }
            } catch(e) { console.log("No sheet for " + name); }

            allUsers.push({ uid, name, email, summons });
        }
        
        allUsers.sort((a,b) => a.name.localeCompare(b.name));
        renderUserList(allUsers);
    } catch(e) {
        listEl.innerHTML = `<div style="padding:15px;color:red">Error: ${e.message}</div>`;
    }
}

function renderUserList(users){
    const listEl = document.getElementById('usersList'); listEl.innerHTML = '';
    users.forEach(u => {
        // Main User Item
        const div = document.createElement('div'); div.className = 'userItem';
        div.innerHTML = `<span class="uName">${u.name}</span><span class="uMeta">${u.email}</span>`;
        div.onclick = () => selectUser(u.uid, null, div);
        div.dataset.uid = u.uid;
        listEl.appendChild(div);

        // Summon Items (Indented)
        if(u.summons && u.summons.length > 0) {
            u.summons.forEach(s => {
                const sDiv = document.createElement('div'); sDiv.className = 'summonItem';
                sDiv.textContent = s.charName || "Unnamed Summon";
                sDiv.onclick = (e) => {
                    e.stopPropagation();
                    selectUser(u.uid, s.id, sDiv);
                };
                listEl.appendChild(sDiv);
            });
        }
    });
}

document.getElementById('userSearch').addEventListener('input', (e)=>{
    const txt = e.target.value.toLowerCase();
    const filtered = allUsers.filter(u => u.name.toLowerCase().includes(txt) || u.email.toLowerCase().includes(txt));
    renderUserList(filtered);
});

// SELECT USER (Main or Summon)
function selectUser(uid, summonId, el){
    // Highlight UI
    document.querySelectorAll('.userItem, .summonItem').forEach(d => d.classList.remove('selected'));
    if(el) el.classList.add('selected');

    currentParentUid = uid;
    currentSummonId = summonId;
    
    // Update Admin Bar
    const typeLabel = summonId ? " (Summon)" : " (Main)";
    document.getElementById('targetUserUID').textContent = "Editing: " + uid + typeLabel;
    
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('sheetContainer').style.display = 'block';
    document.getElementById('sheetContainer').classList.add('active');
    document.body.classList.add('show-editor');
    
    initSkillsTable();
    startListening(uid);
}

function startListening(uid){
    if(unsubscribeSheet) unsubscribeSheet();
    
    const docRef = doc(db, 'users', uid, 'sheet', 'character');
    document.getElementById('statusText').textContent = "Syncing...";
    
    unsubscribeSheet = onSnapshot(docRef, (docSnap) => {
        if(docSnap.exists()){
            fullSheetData = docSnap.data(); // Store full data
            isInternalUpdate = true;
            populateSheet(); // Logic decides what to show based on currentSummonId
            isInternalUpdate = false;
            document.getElementById('statusText').textContent = "Synced";
            document.getElementById('statusText').style.color = "#4caf50";
        } else {
            document.getElementById('statusText').textContent = "No Sheet Data (Empty)";
            fullSheetData = {};
        }
    }, (err) => {
        console.error(err);
        document.getElementById('statusText').textContent = "Error Syncing";
        document.getElementById('statusText').style.color = "red";
    });
}

function populateSheet(){
    // Determine which data object to display
    let data = fullSheetData;
    if (currentSummonId) {
        if (fullSheetData.summons) {
            data = fullSheetData.summons.find(s => s.id === currentSummonId) || {};
        } else {
            data = {};
        }
        
        // UI Adjustments for Summon
        document.getElementById('sheetTitle').textContent = "Summon Bio";
        document.getElementById('btn-skills').style.display = 'none';
        document.getElementById('btn-items').style.display = 'none';
        document.getElementById('spellsSubBtn').style.display = 'none'; // Summons usually don't have full spellbooks here
        document.getElementById('btn-sub-passive').style.display = 'none';

        // Force switch to Character or Combat if on hidden tab
        const activeTab = document.querySelector('.tab-content.active').id;
        if(['skills','items','notes'].includes(activeTab)) switchTab('combat');

    } else {
        // Main Character
        document.getElementById('sheetTitle').textContent = "Character Bio";
        document.getElementById('btn-skills').style.display = 'block';
        document.getElementById('btn-items').style.display = 'block';
        document.getElementById('spellsSubBtn').style.display = 'block';
        document.getElementById('btn-sub-passive').style.display = 'block';
    }

    // Populate Fields
    document.querySelectorAll('.save-field').forEach(el => { 
        el.value = "";
        if(data[el.id] !== undefined) el.value = data[el.id]; 
    });

    // Populate Arrays
    const wList = document.getElementById('weaponList'); wList.innerHTML=''; 
    if(data.weapons) data.weapons.forEach(w => addWeaponRow(w));

    const sList = document.getElementById('spellList'); sList.innerHTML='';
    if(data.spells) {
         const sortedSpells = data.spells.sort((a,b) => {
             const map = { "Cantrip": 0, "1st": 1, "2nd": 2, "3rd": 3, "4th": 4, "5th": 5, "6th": 6, "7th": 7, "8th": 8, "9th": 9 };
             return (map[a.lvl] || 0) - (map[b.lvl] || 0);
         });
         sortedSpells.forEach(s => addSpellRow(s));
    }

    document.getElementById('activeList').innerHTML=''; if(data.activeAbilities) data.activeAbilities.forEach(x => addActiveRow(x));
    document.getElementById('passiveList').innerHTML=''; if(data.passiveAbilities) data.passiveAbilities.forEach(x => addPassiveRow(x));
    document.getElementById('featList').innerHTML=''; if(data.feats) data.feats.forEach(x => addFeatRow(x));
    document.getElementById('itemList').innerHTML=''; if(data.items) data.items.forEach(x => addItemRow(x));

    // Skills (Main Only)
    if(!currentSummonId && data.skills){
        const rows = document.querySelectorAll('.skill-row-data');
        data.skills.forEach((s, i) => {
            if(rows[i]){
                rows[i].querySelector('.skill-cs').checked = s.cs;
                rows[i].querySelector('.skill-ranks').value = s.lvl;
            }
        });
    }
    updateCalculations();
}

function getMod(id) { const val = document.getElementById(id).value; return val ? Math.floor((Number(val)-10)/2) : 0; }

function updateCalculations(){
    ['str','dex','con','int','wis','cha'].forEach(stat => { document.getElementById('mod-'+stat).textContent = (getMod(stat)>=0?'+':'')+getMod(stat); });

    const con = getMod('con'), dex = getMod('dex'), wis = getMod('wis');
    const fB = Number(document.getElementById('fort_bonus').value)||0, rB = Number(document.getElementById('ref_bonus').value)||0, wB = Number(document.getElementById('will_bonus').value)||0;
    
    document.getElementById('fort_total').textContent = (con+fB >=0?'+':'')+(con+fB);
    document.getElementById('ref_total').textContent = (dex+rB >=0?'+':'')+(dex+rB);
    document.getElementById('will_total').textContent = (wis+wB >=0?'+':'')+(wis+wB);

    // Only calc skills if main char
    if(!currentSummonId) {
        document.querySelectorAll('.skill-row-data').forEach(row => {
            const stat = row.dataset.stat, mod = getMod(stat), ranks = Number(row.querySelector('.skill-ranks').value)||0, isCs = row.querySelector('.skill-cs').checked;
            const total = mod + ranks + ((isCs && ranks>0) ? 3 : 0);
            row.querySelector('.skill-mod').textContent = mod;
            row.querySelector('.skill-total').textContent = (total>=0?'+':'')+total;
        });
    }
}

function triggerSave(){
    if(isInternalUpdate || !currentParentUid) return;
    document.getElementById('statusText').textContent = "Saving...";
    document.getElementById('statusText').style.color = "yellow";
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveData, 1000);
}

async function saveData(){
    if(!currentParentUid) return;

    // Scrape current form data
    const currentData = {};
    document.querySelectorAll('.save-field').forEach(el => currentData[el.id] = el.value);

    // Arrays
    currentData.weapons = [];
    document.getElementById('weaponList').querySelectorAll('details').forEach(d => {
        const attrs = [];
        d.querySelectorAll('.attr-row').forEach(row => attrs.push({ name: row.querySelector('.attr-n').value, val: row.querySelector('.attr-v').value }));
        currentData.weapons.push({ name: d.querySelector('.w-name').value, mod: d.querySelector('.w-mod').value, attrs: attrs });
    });
    
    currentData.spells = scrapeList('spellList', ['.l-val','.n-val','.k-val','.d-val'], ['lvl','name','link','desc']);
    currentData.activeAbilities = scrapeList('activeList', ['.n-val','.u-val','.t-val','.d-val'], ['name','uses','type','desc']);
    currentData.passiveAbilities = scrapeList('passiveList', ['.n-val','.d-val'], ['name','desc']);
    currentData.feats = scrapeList('featList', ['.n-val','.l-val','.d-val'], ['name','link','desc']);
    currentData.items = scrapeList('itemList', ['.n-val','.t-val','.c-val','.d-val','.i-data'], ['name','tags','cost','desc','img']);

    if(!currentSummonId) {
        currentData.skills = [];
        document.querySelectorAll('.skill-row-data').forEach(row => { 
            currentData.skills.push({ cs: row.querySelector('.skill-cs').checked, lvl: Number(row.querySelector('.skill-ranks').value)||0 }); 
        });
    }

    // CONSTRUCT FINAL PAYLOAD
    let finalPayload = {};
    
    if (currentSummonId) {
        // We are editing a summon. We need to grab the FULL sheet data,
        // find the summon in the array, replace it, and save the whole sheet.
        // We use 'fullSheetData' which is kept up to date by onSnapshot.
        
        finalPayload = { ...fullSheetData }; // copy
        if(!finalPayload.summons) finalPayload.summons = [];
        
        const idx = finalPayload.summons.findIndex(s => s.id === currentSummonId);
        // Ensure ID is preserved
        currentData.id = currentSummonId; 
        
        if(idx > -1) {
            finalPayload.summons[idx] = currentData;
        } else {
            // Should theoretically not happen unless summon was deleted remotely while editing
            finalPayload.summons.push(currentData);
        }
    } else {
        // Editing Main Character
        // We preserve the 'summons' array from the full data so we don't overwrite it
        const existingSummons = fullSheetData.summons || [];
        finalPayload = { ...currentData, summons: existingSummons };
    }

    try {
        await setDoc(doc(db, 'users', currentParentUid, 'sheet', 'character'), finalPayload);
        document.getElementById('statusText').textContent = "Saved";
        document.getElementById('statusText').style.color = "#4caf50";
    } catch(e) {
        console.error(e);
        document.getElementById('statusText').textContent = "Save Failed";
        document.getElementById('statusText').style.color = "red";
    }
}

function scrapeList(id, selectors, keys){
    const list = [];
    document.getElementById(id).querySelectorAll('details').forEach(d => {
        const obj = {}; selectors.forEach((sel, i) => obj[keys[i]] = d.querySelector(sel)?.value || '');
        list.push(obj);
    });
    return list;
}

function createRow(containerId, titleFunc, html, data={}){
    const div = document.createElement('details');
    div.innerHTML = `<summary>${titleFunc(data)} <button class="btn-remove">x</button></summary><div class="details-content">${html}</div>`;
    document.getElementById(containerId).appendChild(div);
    div.querySelectorAll('input,textarea,select').forEach(i => i.addEventListener('input', () => { div.querySelector('summary').innerHTML = titleFunc(scrapeRow(div)) + ` <button class="btn-remove">x</button>`; triggerSave(); }));
    div.querySelector('.btn-remove').onclick = (e) => { e.preventDefault(); div.remove(); triggerSave(); };
    return div;
}

function scrapeRow(el){
    const d = {};
    const map = {'.w-name':'name', '.w-mod':'mod', '.n-val':'name', '.l-val':'lvl', '.k-val':'link', '.u-val':'uses', '.t-val':'type'};
    for(let k in map) d[map[k]] = el.querySelector(k)?.value || '';
    return d;
}

function addWeaponRow(d={}){ 
    let attrHtml = '';
    if(d.attrs) d.attrs.forEach(a => attrHtml += `<div class="attr-row"><input class="attr-n" value="${a.name}" placeholder="Attr"><input class="attr-v" value="${a.val}" placeholder="Val"><button class="btn-remove" onclick="this.parentElement.remove();triggerSave()">x</button></div>`);

    const html = `
        <div style="display:flex; gap:10px;">
            <input class="w-name" value="${d.name||''}" placeholder="Name">
            <select class="w-mod" style="width:80px">
                <option ${d.mod==='STR'?'selected':''}>STR</option><option ${d.mod==='DEX'?'selected':''}>DEX</option>
                <option ${d.mod==='CON'?'selected':''}>CON</option><option ${d.mod==='INT'?'selected':''}>INT</option>
                <option ${d.mod==='WIS'?'selected':''}>WIS</option><option ${d.mod==='CHA'?'selected':''}>CHA</option>
            </select>
        </div>
        <div class="attr-container">${attrHtml}</div>
        <button class="btn-add" style="padding:4px; font-size:11px; margin-top:5px;" onclick="addWeaponAttr(this)">+ Attribute</button>
    `;
    createRow('weaponList', x => x.name||'New Weapon', html, d);
}
window.addWeaponAttr = (btn) => {
    const div = document.createElement('div'); div.className = 'attr-row';
    div.innerHTML = `<input class="attr-n" placeholder="Attr"><input class="attr-v" placeholder="Val"><button class="btn-remove" onclick="this.parentElement.remove();triggerSave()">x</button>`;
    btn.previousElementSibling.appendChild(div);
    div.querySelectorAll('input').forEach(i => i.addEventListener('input', triggerSave));
};

const SPELL_LVLS = ["Cantrip","1st","2nd","3rd","4th","5th","6th","7th","8th","9th"];
function addSpellRow(d={}){
    let opts = ""; SPELL_LVLS.forEach(l => opts += `<option ${d.lvl===l?'selected':''}>${l}</option>`);
    const summary = (x) => {
        const nameDisplay = x.link ? `<a href="${x.link}" target="_blank">${x.name||'New Spell'}</a>` : (x.name||'New Spell');
        return `[${x.lvl||'-'}] ${nameDisplay}`;
    };
    const html = `<div style="display:flex;gap:5px"><select class="l-val" style="width:80px">${opts}</select><input class="n-val" value="${d.name||''}" placeholder="Name"></div><input class="k-val" value="${d.link||''}" placeholder="Link"><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('spellList', summary, html, d);
}

const ACTION_TYPES = ["Standard","Move","Swift","Full","Free","Immediate","Reaction"];
function addActiveRow(d={}){
    let opts = ""; ACTION_TYPES.forEach(t => opts += `<option ${d.type===t?'selected':''}>${t}</option>`);
    const summary = (x) => `<span>${x.name||'Ability'}: <small style="color:#aaa">${x.type||'-'}</small></span> <span>${x.uses||''}</span>`;
    const html = `<input class="n-val" value="${d.name||''}" placeholder="Name"><div style="display:flex;gap:5px;margin-top:5px;"><select class="t-val">${opts}</select><input class="u-val" value="${d.uses||''}" placeholder="Uses"></div><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('activeList', summary, html, d);
}

function addPassiveRow(d={}){ createRow('passiveList', x => x.name||'New Passive', `<input class="n-val" value="${d.name||''}" placeholder="Name"><textarea class="d-val">${d.desc||''}</textarea>`, d); }
function addFeatRow(d={}){ createRow('featList', x => x.name||'New Feat', `<input class="n-val" value="${d.name||''}" placeholder="Name"><input class="l-val" value="${d.link||''}" placeholder="Link"><textarea class="d-val">${d.desc||''}</textarea>`, d); }
function addItemRow(d={}){ createRow('itemList', x => x.name||'New Item', `<div style="display:flex;gap:10px"><div style="flex:1"><input class="n-val" value="${d.name||''}" placeholder="Name" style="margin-bottom:5px"><input class="t-val" value="${d.tags||''}" placeholder="Tags" style="margin-bottom:5px"><input class="c-val" value="${d.cost||''}" placeholder="Cost"><input type="hidden" class="i-data" value="${d.img||''}"><input type="file" onchange="encodeImg(this)" style="margin-top:5px; font-size:11px;"></div><img src="${d.img||''}" class="item-preview"></div><textarea class="d-val">${d.desc||''}</textarea>`, d); }

window.encodeImg = (inp) => { const f = inp.files[0]; if(f){ const r = new FileReader(); r.onload = e => { const p = inp.parentElement; p.querySelector('.i-data').value = e.target.result; p.nextElementSibling.src = e.target.result; triggerSave(); }; r.readAsDataURL(f); } };

function initSkillsTable(){
    const body = document.getElementById('skillsTableBody'); body.innerHTML = '';
    SKILLS_DB.forEach(s => {
        const tr = document.createElement('tr'); tr.className = 'skill-row-data'; tr.dataset.stat = s.s;
        tr.innerHTML = `<td><input type="checkbox" class="skill-cs"></td><td>${s.n} <small style="color:#888">(${s.s})</small></td><td class="skill-mod">0</td><td><input type="number" class="skill-ranks" style="width:40px; text-align:center; background:var(--input-bg); border:1px solid var(--border); padding:4px; border-radius:3px;"></td><td class="skill-total" style="color:var(--accent);font-weight:bold">0</td>`;
        tr.querySelectorAll('input').forEach(i => i.addEventListener('input', () => { updateCalculations(); triggerSave(); }));
        body.appendChild(tr);
    });
}

document.getElementById('btnAddWeapon').onclick = () => addWeaponRow();
document.getElementById('btnAddSpell').onclick = () => addSpellRow();
document.getElementById('btnAddActive').onclick = () => addActiveRow();
document.getElementById('btnAddPassive').onclick = () => addPassiveRow();
document.getElementById('btnAddFeat').onclick = () => addFeatRow();
document.getElementById('btnAddItem').onclick = () => addItemRow();

document.body.addEventListener('input', (e) => { 
    if(e.target.classList.contains('save-field') || e.target.classList.contains('calc-trigger')) { 
        updateCalculations(); 
        triggerSave(); 
    } 
});

</script>
</body>
</html>