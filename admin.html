<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Master Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
  /* --- ADMIN LAYOUT STYLES --- */
  :root { --bg:#111; --panel:#222; --muted:#aaa; --accent:#ffcc66; --good:#4caf50; --bad:#ff6666; }
  body { margin:0; font-family:Arial,Helvetica,sans-serif; background:#0b0b0b; color:#fff; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
  
  /* Header */
  header { height:50px; background:var(--panel); display:flex; align-items:center; padding:0 18px; border-bottom:1px solid #333; flex-shrink:0; justify-content: space-between;}
  header h1 { font-family:'Uncial Antiqua',serif; color:var(--accent); margin:0; font-size:20px; }

  /* Main Layout */
  #layout { display:flex; flex:1; overflow:hidden; }
  
  /* Sidebar (User List) */
  #sidebar { width:250px; background:#181818; border-right:1px solid #333; display:flex; flex-direction:column; flex-shrink:0; }
  #userSearch { background:#000; border:none; border-bottom:1px solid #333; color:#fff; padding:15px; width:100%; box-sizing:border-box; outline:none; }
  #usersList { flex:1; overflow-y:auto; }
  .userItem { padding:10px 15px; cursor:pointer; border-bottom:1px solid #222; transition:0.2s; }
  .userItem:hover { background:#222; }
  .userItem.selected { background:var(--accent); color:#000; }
  .userItem .uName { font-weight:bold; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .userItem .uMeta { font-size:11px; opacity:0.7; }

  /* Editor Area (Right Side) */
  #editorArea { flex:1; display:flex; flex-direction:column; background:#111; position:relative; overflow:hidden; }
  #emptyState { display:flex; align-items:center; justify-content:center; height:100%; color:#444; font-family:'Uncial Antiqua'; font-size:24px; }
  
  /* --- COPIED CHARACTER SHEET STYLES (Scoped to #sheetContainer) --- */
  #sheetContainer { flex:1; overflow-y:auto; padding:20px; display:none; }
  #sheetContainer.active { display:block; }

  /* Re-using styles from characters.html but adapted for the container */
  .tabs-container { display: flex; width: 100%; max-width: 1000px; margin: 0 auto; gap:20px; }
  .tab-menu { display: flex; flex-direction: column; width: 160px; background: #1a1a1a; padding: 10px; gap: 5px; border-radius:8px; height:fit-content; }
  .tab-menu button { background: #333; color: #fff; border: none; padding: 10px; cursor: pointer; border-radius: 4px; text-align: left; font-family: 'Uncial Antiqua', serif; }
  .tab-menu button:hover, .tab-menu button.active { background: var(--accent); color: #000; }
  
  .tab-content { flex: 1; display: none; background: #222; padding: 20px; border-radius: 8px; border:1px solid #333; }
  .tab-content.active { display: block; animation: fadeIn 0.3s; }

  h2, h3, h4 { font-family: 'Uncial Antiqua', serif; color: var(--accent); margin-top:0; }
  input, textarea, select { background: #111; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 4px; width:100%; box-sizing:border-box; }
  input:focus, textarea:focus { border-color: var(--accent); outline: none; }
  
  /* Grid & Tables */
  .bio-grid { display: grid; grid-template-columns: 100px 1fr; gap: 10px; align-items: center; margin-bottom: 20px; }
  .bio-grid label { text-align: right; color: #888; font-size:12px; font-weight:bold; }
  
  .ability-table { width: 100%; max-width: 400px; margin: 0 auto; border-collapse: collapse; text-align: center; }
  .ability-table th, .ability-table td { border: 1px solid #444; padding: 5px; }
  .modifier { color: var(--accent); font-weight: bold; }

  /* Combat Headers */
  .combat-header { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; background: #181818; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
  .stat-group { display: flex; flex-direction: column; align-items: center; }
  .stat-group label { font-size: 11px; color: var(--accent); margin-bottom: 4px; }
  .stat-row { display:flex; align-items:center; gap:5px; }

  /* Sub Tabs */
  .sub-nav { display: flex; gap:10px; border-bottom: 1px solid #444; margin-bottom: 15px; padding-bottom:5px; }
  .sub-tab-btn { background: none; border: none; color: #888; cursor: pointer; font-family:'Uncial Antiqua'; font-size:14px; }
  .sub-tab-btn.active { color: var(--accent); text-decoration: underline; }
  .sub-content { display: none; }
  .sub-content.active { display: block; }

  /* Lists (Details/Summary) */
  details { background: #181818; border: 1px solid #333; border-radius: 4px; margin-bottom: 8px; overflow: hidden; }
  details summary { padding: 8px 12px; cursor: pointer; background: #252525; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
  details[open] summary { border-bottom: 1px solid #333; }
  .details-content { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
  
  /* Buttons */
  .btn-add { width:100%; background:var(--accent); color:#000; border:none; padding:8px; font-weight:bold; cursor:pointer; border-radius:4px; margin-top:10px; }
  .btn-remove { background:#ff4444; color:#fff; border:none; padding:2px 6px; border-radius:2px; cursor:pointer; font-size:10px; }
  
  /* Skills */
  .skills-table { width:100%; border-collapse:collapse; font-size:13px; }
  .skills-table th { text-align:left; color:var(--accent); border-bottom:1px solid #444; padding:5px; }
  .skills-table td { padding:4px; border-bottom:1px solid #333; }
  .skill-disabled { opacity:0.5; }

  /* Items */
  .item-preview { width:40px; height:40px; border:1px solid #444; background:#000; object-fit:cover; }

  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

  /* Admin Status Bar */
  #adminBar { position:absolute; bottom:0; left:0; right:0; background:var(--accent); color:#000; padding:5px 10px; font-size:12px; font-weight:bold; display:flex; justify-content:space-between; }
</style>
</head>
<body>

<header>
  <h1>Mount Aetheria — Admin Console</h1>
  <div style="font-size:12px; color:#888;">Logged in as Admin</div>
</header>

<div id="layout">
  <div id="sidebar">
    <input type="text" id="userSearch" placeholder="Search Users...">
    <div id="usersList"><div style="padding:15px; color:#888;">Loading...</div></div>
  </div>

  <div id="editorArea">
    <div id="emptyState">Select a user to edit their sheet</div>
    
    <div id="sheetContainer">
      <div class="tabs-container">
        <div class="tab-menu">
          <button class="tab-btn active" data-tab="character">Character</button>
          <button class="tab-btn" data-tab="combat">Combat</button>
          <button class="tab-btn" data-tab="skills">Skills</button>
          <button class="tab-btn" data-tab="items">Items</button>
          <button class="tab-btn" data-tab="notes">Notes</button>
        </div>

        <div class="tab-content active" id="character">
          <h2>Bio & Stats</h2>
          <div class="bio-grid">
            <label>Name</label><input type="text" id="charName" class="save-field">
            <label>Race</label><input type="text" id="race" class="save-field">
            <label>Class</label><input type="text" id="class" class="save-field">
            <label>Alignment</label><input type="text" id="alignment" class="save-field">
            <label>Size</label><input type="text" id="size" class="save-field">
            <label>Senses</label><input type="text" id="senses" class="save-field">
            <label>Languages</label><input type="text" id="languages" class="save-field">
          </div>
          <h3>Ability Scores</h3>
          <table class="ability-table">
            <tr><th>Stat</th><th>Score</th><th>Mod</th></tr>
            <tr><td>STR</td><td><input type="number" id="str" class="save-field calc-stat"></td><td id="mod-str" class="modifier">+0</td></tr>
            <tr><td>DEX</td><td><input type="number" id="dex" class="save-field calc-stat"></td><td id="mod-dex" class="modifier">+0</td></tr>
            <tr><td>CON</td><td><input type="number" id="con" class="save-field calc-stat"></td><td id="mod-con" class="modifier">+0</td></tr>
            <tr><td>INT</td><td><input type="number" id="int" class="save-field calc-stat"></td><td id="mod-int" class="modifier">+0</td></tr>
            <tr><td>WIS</td><td><input type="number" id="wis" class="save-field calc-stat"></td><td id="mod-wis" class="modifier">+0</td></tr>
            <tr><td>CHA</td><td><input type="number" id="cha" class="save-field calc-stat"></td><td id="mod-cha" class="modifier">+0</td></tr>
          </table>
        </div>

        <div class="tab-content" id="combat">
          <div class="combat-header">
            <div class="stat-group"><label>HP</label><div class="stat-row"><input id="hp_curr" class="save-field" style="width:50px"><input id="hp_max" class="save-field" style="width:50px"></div></div>
            <div class="stat-group"><label>MP</label><div class="stat-row"><input id="mp_curr" class="save-field" style="width:50px"><input id="mp_max" class="save-field" style="width:50px"></div></div>
            <div class="stat-group"><label>Speed</label><input id="speed" class="save-field" style="width:60px"></div>
            <div class="stat-group"><label>AC Total</label><input id="ac_total" class="save-field" style="width:50px"></div>
            <div class="stat-group"><label>Init Mod</label><input id="init_bonus" class="save-field" style="width:50px"></div>
          </div>

          <div class="sub-nav">
            <button class="sub-tab-btn active" data-sub="offense">Offense</button>
            <button class="sub-tab-btn" data-sub="defense">Defense</button>
            <button class="sub-tab-btn" data-sub="spells">Spells</button>
            <button class="sub-tab-btn" data-sub="feats">Feats/Abils</button>
          </div>

          <div id="offense" class="sub-content active">
             <div class="bio-grid" style="grid-template-columns:100px 1fr;">
                <label>BAB</label><input id="bab" class="save-field">
                <label>CMB</label><input id="cmb_total" class="save-field">
                <label>CMD</label><input id="cmd_total" class="save-field">
             </div>
             <h3>Weapons</h3>
             <div id="weaponList"></div>
             <button class="btn-add" id="btnAddWeapon">+ Add Weapon</button>
          </div>

          <div id="defense" class="sub-content">
             <div class="bio-grid">
                <label>Touch AC</label><input id="ac_touch" class="save-field">
                <label>Flat-Foot AC</label><input id="ac_flat" class="save-field">
                <label>DR</label><input id="dr_val" class="save-field">
                <label>SR</label><input id="sr_val" class="save-field">
             </div>
             <h3>Saves</h3>
             <table class="ability-table">
               <tr><th>Save</th><th>Base/Bonus</th><th>Total</th></tr>
               <tr><td>Fort</td><td><input type="number" id="fort_bonus" class="save-field calc-stat"></td><td id="fort_total" class="modifier">+0</td></tr>
               <tr><td>Ref</td><td><input type="number" id="ref_bonus" class="save-field calc-stat"></td><td id="ref_total" class="modifier">+0</td></tr>
               <tr><td>Will</td><td><input type="number" id="will_bonus" class="save-field calc-stat"></td><td id="will_total" class="modifier">+0</td></tr>
             </table>
          </div>

          <div id="spells" class="sub-content">
             <div style="margin-bottom:10px;"><label>DC Base:</label> <input id="spell_dc_base" class="save-field"></div>
             <div id="spellList"></div>
             <button class="btn-add" id="btnAddSpell">+ Add Spell</button>
          </div>

          <div id="feats" class="sub-content">
             <h3>Active Abilities</h3>
             <div id="activeList"></div>
             <button class="btn-add" id="btnAddActive">+ Add Active</button>
             
             <h3>Passive Abilities</h3>
             <div id="passiveList"></div>
             <button class="btn-add" id="btnAddPassive">+ Add Passive</button>

             <h3>Feats</h3>
             <div id="featList"></div>
             <button class="btn-add" id="btnAddFeat">+ Add Feat</button>

             <h3>Proficiencies</h3>
             <textarea id="proficiencies" class="save-field" style="height:80px"></textarea>
          </div>
        </div>

        <div class="tab-content" id="skills">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <strong>Skills</strong>
                <span>Unused Points: <input id="skill_points" class="save-field" style="width:50px; display:inline-block;"></span>
            </div>
            <table class="skills-table">
                <thead><tr><th style="width:30px">CS</th><th>Name</th><th style="width:40px">Mod</th><th style="width:50px">Ranks</th><th style="width:40px">Tot</th></tr></thead>
                <tbody id="skillsTableBody"></tbody>
            </table>
        </div>

        <div class="tab-content" id="items">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div><label>Gil</label><input id="currency_gil" class="save-field"></div>
                <div><label>Moogle Pts</label><input id="currency_moogle" class="save-field"></div>
            </div>
            <div id="itemList"></div>
            <button class="btn-add" id="btnAddItem">+ Add Item</button>
        </div>

        <div class="tab-content" id="notes">
            <textarea id="notesArea" class="save-field" style="height:400px; font-family:sans-serif;"></textarea>
        </div>

      </div> </div> <div id="adminBar">
      <span id="statusText">Ready</span>
      <span id="targetUserUID">No User Selected</span>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyBpoi5qvqUehnhcyhfB7d0gtelNUICIthw",
  authDomain: "mount-aetheria.firebaseapp.com",
  projectId: "mount-aetheria",
  storageBucket: "mount-aetheria.firebasestorage.app",
  messagingSenderId: "492855693446",
  appId: "1:492855693446:web:f9948569254a7220c38107",
  measurementId: "G-0PF84KDN7L"
};
const ADMIN_UID = "U7uyfcMtULSLJvXD0HzJaiMIeGE3";
const ADMIN_EMAIL = "phoeaung2076@gmail.com";

// --- INIT ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- GLOBAL STATE ---
let allUsers = [];
let selectedUserUid = null;
let unsubscribeSheet = null; // To stop listening when switching users
let saveTimeout = null;
let isInternalUpdate = false; // Prevent write loops

// --- SKILLS DB ---
const SKILLS_DB = [
    {name: "Acrobatics", stat: "dex", trained: false}, {name: "Appraise", stat: "int", trained: false},
    {name: "Bluff", stat: "cha", trained: false}, {name: "Climb", stat: "str", trained: false},
    {name: "Craft (1)", stat: "int", trained: false}, {name: "Craft (2)", stat: "int", trained: false},
    {name: "Diplomacy", stat: "cha", trained: false}, {name: "Disable Device", stat: "dex", trained: true},
    {name: "Disguise", stat: "cha", trained: false}, {name: "Escape Artist", stat: "dex", trained: false},
    {name: "Fly", stat: "dex", trained: false}, {name: "Handle Animal", stat: "cha", trained: true},
    {name: "Heal", stat: "wis", trained: false}, {name: "Intimidate", stat: "cha", trained: false},
    {name: "Knw: Arcana", stat: "int", trained: true}, {name: "Knw: Nature", stat: "int", trained: true},
    {name: "Knw: Local", stat: "int", trained: true}, {name: "Knw: Religion", stat: "int", trained: true},
    {name: "Perception", stat: "wis", trained: false}, {name: "Ride", stat: "dex", trained: false},
    {name: "Sense Motive", stat: "wis", trained: false}, {name: "Spellcraft", stat: "int", trained: true},
    {name: "Stealth", stat: "dex", trained: false}, {name: "Survival", stat: "wis", trained: false},
    {name: "Swim", stat: "str", trained: false}, {name: "Use Magic Device", stat: "cha", trained: true}
];

// --- AUTH ---
onAuthStateChanged(auth, async (user) => {
  if(!user) { window.location.href="login.html"; return; }
  if(user.uid !== ADMIN_UID && user.email !== ADMIN_EMAIL) {
    document.body.innerHTML = "<h2 style='color:red;padding:20px'>Access Denied: Admin Only</h2>";
    return;
  }
  loadUserList();
});

// --- USER LIST ---
async function loadUserList(){
    const listEl = document.getElementById('usersList');
    listEl.innerHTML = '<div style="padding:15px">Fetching users...</div>';
    
    try {
        const snap = await getDocs(collection(db, 'users'));
        allUsers = [];
        snap.forEach(d => {
            const data = d.data();
            allUsers.push({
                uid: d.id,
                name: data.displayName || data.name || "Unknown",
                email: data.email || "No Email"
            });
        });
        allUsers.sort((a,b) => a.name.localeCompare(b.name));
        renderUserList(allUsers);
    } catch(e) {
        listEl.innerHTML = `<div style="padding:15px;color:red">Error: ${e.message}</div>`;
    }
}

function renderUserList(users){
    const listEl = document.getElementById('usersList');
    listEl.innerHTML = '';
    users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'userItem';
        div.innerHTML = `<span class="uName">${u.name}</span><span class="uMeta">${u.email}</span>`;
        div.onclick = () => selectUser(u.uid, div);
        listEl.appendChild(div);
    });
}

document.getElementById('userSearch').addEventListener('input', (e)=>{
    const txt = e.target.value.toLowerCase();
    const filtered = allUsers.filter(u => u.name.toLowerCase().includes(txt) || u.email.toLowerCase().includes(txt));
    renderUserList(filtered);
});

// --- SELECT USER ---
function selectUser(uid, el){
    // UI Highlight
    document.querySelectorAll('.userItem').forEach(d => d.classList.remove('selected'));
    if(el) el.classList.add('selected');

    selectedUserUid = uid;
    document.getElementById('targetUserUID').textContent = "Editing: " + uid;
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('sheetContainer').style.display = 'block';
    document.getElementById('sheetContainer').classList.add('active');

    // Init Logic
    initSkillsTable();
    startListening(uid);
}

// --- REAL-TIME LISTENER ---
function startListening(uid){
    if(unsubscribeSheet) unsubscribeSheet();
    
    const docRef = doc(db, 'users', uid, 'sheet', 'character'); // Correct Singular Path
    
    document.getElementById('statusText').textContent = "Syncing...";
    
    unsubscribeSheet = onSnapshot(docRef, (docSnap) => {
        if(docSnap.exists()){
            isInternalUpdate = true; // Don't trigger save loops
            populateSheet(docSnap.data());
            isInternalUpdate = false;
            document.getElementById('statusText').textContent = "Synced";
            document.getElementById('statusText').style.color = "#4caf50";
        } else {
            // New Sheet
            document.getElementById('statusText').textContent = "No Sheet Data (Empty)";
        }
    }, (err) => {
        console.error(err);
        document.getElementById('statusText').textContent = "Error Syncing";
        document.getElementById('statusText').style.color = "red";
    });
}

// --- POPULATE UI ---
function populateSheet(data){
    // 1. Static Fields
    document.querySelectorAll('.save-field').forEach(el => {
        if(data[el.id] !== undefined) el.value = data[el.id];
    });

    // 2. Dynamic Lists (Clear and Rebuild)
    document.getElementById('weaponList').innerHTML='';
    if(data.weapons) data.weapons.forEach(w => addWeaponRow(w));

    document.getElementById('spellList').innerHTML='';
    if(data.spells) data.spells.forEach(s => addSpellRow(s));

    document.getElementById('activeList').innerHTML='';
    if(data.activeAbilities) data.activeAbilities.forEach(x => addActiveRow(x));
    
    document.getElementById('passiveList').innerHTML='';
    if(data.passiveAbilities) data.passiveAbilities.forEach(x => addPassiveRow(x));

    document.getElementById('featList').innerHTML='';
    if(data.feats) data.feats.forEach(x => addFeatRow(x));
    
    document.getElementById('itemList').innerHTML='';
    if(data.items) data.items.forEach(x => addItemRow(x));

    // 3. Skills
    if(data.skills){
        const rows = document.querySelectorAll('.skill-row');
        data.skills.forEach((s, i) => {
            if(rows[i]){
                rows[i].querySelector('.skill-cs').checked = s.cs;
                rows[i].querySelector('.skill-ranks').value = s.lvl;
            }
        });
    }

    updateCalculations();
}

// --- CALCULATION LOGIC ---
function getMod(id) {
    const val = document.getElementById(id).value;
    return val ? Math.floor((Number(val)-10)/2) : 0;
}

function updateCalculations(){
    // Stats
    ['str','dex','con','int','wis','cha'].forEach(stat => {
        const mod = getMod(stat);
        document.getElementById('mod-'+stat).textContent = (mod>=0?'+':'')+mod;
    });

    // Saves
    const con = getMod('con');
    const dex = getMod('dex');
    const wis = getMod('wis');
    const fB = Number(document.getElementById('fort_bonus').value)||0;
    const rB = Number(document.getElementById('ref_bonus').value)||0;
    const wB = Number(document.getElementById('will_bonus').value)||0;
    
    document.getElementById('fort_total').textContent = (con+fB >=0?'+':'')+(con+fB);
    document.getElementById('ref_total').textContent = (dex+rB >=0?'+':'')+(dex+rB);
    document.getElementById('will_total').textContent = (wis+wB >=0?'+':'')+(wis+wB);

    // Skills
    document.querySelectorAll('.skill-row').forEach(row => {
        const stat = row.dataset.stat;
        const mod = getMod(stat);
        const ranks = Number(row.querySelector('.skill-ranks').value)||0;
        const isCs = row.querySelector('.skill-cs').checked;
        const csBonus = (isCs && ranks>0) ? 3 : 0;
        const total = mod + ranks + csBonus;
        
        row.querySelector('.skill-mod').textContent = mod;
        row.querySelector('.skill-total').textContent = (total>=0?'+':'')+total;
        
        if(row.dataset.trained === 'true' && ranks === 0) {
            row.classList.add('skill-disabled');
            row.querySelector('.skill-total').textContent = "-";
        } else {
            row.classList.remove('skill-disabled');
        }
    });
}

// --- SAVING ---
function triggerSave(){
    if(isInternalUpdate || !selectedUserUid) return;
    
    document.getElementById('statusText').textContent = "Saving...";
    document.getElementById('statusText').style.color = "yellow";
    
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveData, 1000);
}

async function saveData(){
    if(!selectedUserUid) return;
    
    const payload = {};
    
    // Static
    document.querySelectorAll('.save-field').forEach(el => payload[el.id] = el.value);

    // Skills
    payload.skills = [];
    document.querySelectorAll('.skill-row').forEach(row => {
        payload.skills.push({
            cs: row.querySelector('.skill-cs').checked,
            lvl: Number(row.querySelector('.skill-ranks').value)||0
        });
    });

    // Lists (Scrapers)
    payload.weapons = scrapeList('weaponList', ['.w-name','.w-atk'], ['name','atk']); 
    // Note: Complex weapon attributes omitted for brevity, but can be added if needed
    
    payload.spells = scrapeList('spellList', ['.l-val','.n-val','.k-val','.d-val'], ['lvl','name','link','desc']);
    payload.activeAbilities = scrapeList('activeList', ['.n-val','.u-val','.d-val'], ['name','uses','desc']);
    payload.passiveAbilities = scrapeList('passiveList', ['.n-val','.d-val'], ['name','desc']);
    payload.feats = scrapeList('featList', ['.n-val','.l-val','.d-val'], ['name','link','desc']);
    payload.items = scrapeList('itemList', ['.n-val','.t-val','.c-val','.d-val','.i-data'], ['name','tags','cost','desc','img']);

    try {
        await setDoc(doc(db, 'users', selectedUserUid, 'sheet', 'character'), payload);
        document.getElementById('statusText').textContent = "Saved";
        document.getElementById('statusText').style.color = "#4caf50";
    } catch(e) {
        console.error(e);
        document.getElementById('statusText').textContent = "Save Failed";
        document.getElementById('statusText').style.color = "red";
    }
}

// --- DYNAMIC LIST HELPERS ---
function scrapeList(id, selectors, keys){
    const list = [];
    document.getElementById(id).querySelectorAll('details').forEach(d => {
        const obj = {};
        selectors.forEach((sel, i) => obj[keys[i]] = d.querySelector(sel)?.value || '');
        list.push(obj);
    });
    return list;
}

function createRow(containerId, titleFunc, html, data={}){
    const div = document.createElement('details');
    div.innerHTML = `<summary>${titleFunc() || 'New Item'}</summary><div class="details-content">${html}<button class="btn-remove">Remove</button></div>`;
    document.getElementById(containerId).appendChild(div);
    
    // Bind Events
    div.querySelectorAll('input,textarea,select').forEach(i => i.addEventListener('input', () => {
        div.querySelector('summary').textContent = titleFunc() || 'New Item';
        triggerSave();
    }));
    div.querySelector('.btn-remove').onclick = () => { div.remove(); triggerSave(); };
    div.querySelectorAll('input').forEach(i => i.value = i.getAttribute('value')||''); // Set initial values
    return div;
}

// Specific Row Creators (Simpler versions of Character Sheet logic)
function addWeaponRow(d={}){ 
    const html = `<input class="w-name" value="${d.name||''}" placeholder="Name"><input class="w-atk" value="${d.atk||''}" placeholder="Attack Mod">`;
    createRow('weaponList', ()=>d.name||document.querySelector('.w-name')?.value, html, d);
}
function addSpellRow(d={}){
    const html = `<select class="l-val"><option ${d.lvl==='1st'?'selected':''}>1st</option><option ${d.lvl==='2nd'?'selected':''}>2nd</option></select><input class="n-val" value="${d.name||''}" placeholder="Name"><input class="k-val" value="${d.link||''}" placeholder="Link"><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('spellList', ()=>`[${d.lvl||'?'}] ${d.name||''}`, html, d);
}
function addActiveRow(d={}){
    const html = `<input class="n-val" value="${d.name||''}" placeholder="Name"><input class="u-val" value="${d.uses||''}" placeholder="Uses"><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('activeList', ()=>d.name||'', html, d);
}
function addPassiveRow(d={}){
    const html = `<input class="n-val" value="${d.name||''}" placeholder="Name"><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('passiveList', ()=>d.name||'', html, d);
}
function addFeatRow(d={}){
    const html = `<input class="n-val" value="${d.name||''}" placeholder="Name"><input class="l-val" value="${d.link||''}" placeholder="Link"><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('featList', ()=>d.name||'', html, d);
}
function addItemRow(d={}){
    const html = `<div style="display:flex;gap:10px"><div style="flex:1"><input class="n-val" value="${d.name||''}" placeholder="Name"><input class="t-val" value="${d.tags||''}" placeholder="Tags"><input class="c-val" value="${d.cost||''}" placeholder="Cost"><input type="hidden" class="i-data" value="${d.img||''}"></div><img src="${d.img||''}" class="item-preview"></div><textarea class="d-val">${d.desc||''}</textarea>`;
    createRow('itemList', ()=>d.name||'', html, d);
}

// --- SKILL TABLE BUILDER ---
function initSkillsTable(){
    const body = document.getElementById('skillsTableBody');
    body.innerHTML = '';
    SKILLS_DB.forEach(s => {
        const tr = document.createElement('tr');
        tr.className = 'skill-row';
        tr.dataset.stat = s.stat;
        tr.dataset.trained = s.trained;
        tr.innerHTML = `
            <td><input type="checkbox" class="skill-cs"></td>
            <td>${s.name} <small style="color:#888">(${s.stat})</small></td>
            <td class="skill-mod">0</td>
            <td><input type="number" class="skill-ranks" style="width:40px"></td>
            <td class="skill-total" style="color:var(--accent);font-weight:bold">0</td>
        `;
        tr.querySelectorAll('input').forEach(i => i.addEventListener('input', () => {
            updateCalculations();
            triggerSave();
        }));
        body.appendChild(tr);
    });
}

// --- TAB LOGIC ---
document.querySelectorAll('.tab-btn').forEach(b => b.onclick = (e) => {
    document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
    e.target.classList.add('active');
    document.getElementById(e.target.dataset.tab).classList.add('active');
});
document.querySelectorAll('.sub-tab-btn').forEach(b => b.onclick = (e) => {
    document.querySelectorAll('.sub-tab-btn').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.sub-content').forEach(x => x.classList.remove('active'));
    e.target.classList.add('active');
    document.getElementById(e.target.dataset.sub).classList.add('active');
});

// --- ADD BUTTONS ---
document.getElementById('btnAddWeapon').onclick = () => addWeaponRow();
document.getElementById('btnAddSpell').onclick = () => addSpellRow();
document.getElementById('btnAddActive').onclick = () => addActiveRow();
document.getElementById('btnAddPassive').onclick = () => addPassiveRow();
document.getElementById('btnAddFeat').onclick = () => addFeatRow();
document.getElementById('btnAddItem').onclick = () => addItemRow();

// Global Inputs save trigger
document.body.addEventListener('input', (e) => {
    if(e.target.classList.contains('save-field') || e.target.classList.contains('calc-stat')) {
        updateCalculations();
        triggerSave();
    }
});

</script>
</body>
</html>